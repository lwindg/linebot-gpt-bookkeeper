#!/bin/bash
# v1.5.0 測試腳本 - 逐個測試並檢視結果

echo "======================================================================"
echo "🧪 v1.5.0 多項目支出測試腳本"
echo "======================================================================"
echo ""
echo "使用方式："
echo "  - 每個測試案例會顯示測試訊息和結果"
echo "  - 按 Enter 繼續下一個測試"
echo "  - 按 Ctrl+C 中斷測試"
echo ""
read -p "按 Enter 開始測試..."

# 測試函數
run_test() {
    local category="$1"
    local description="$2"
    local message="$3"
    local expected="$4"

    echo ""
    echo "======================================================================"
    echo "[$category] $description"
    echo "======================================================================"
    if [ -n "$expected" ]; then
        echo "預期結果：$expected"
    fi
    echo ""

    python test_local.py "$message"

    echo ""
    read -p "按 Enter 繼續下一個測試..."
}

# ============================================================
# 單項目記帳（向後相容）
# ============================================================

run_test "向後相容" "TC-V15-001: v1 格式兼容 - 標準記帳" "午餐120元現金" "✅ 單項目，使用 v1 格式顯示"

run_test "向後相容" "TC-V15-002: v1 格式兼容 - 含暱稱" "點心200元狗卡" "✅ 付款方式：台新狗卡"

run_test "向後相容" "TC-V15-003: v1 格式兼容 - 自然語句" "買了咖啡50元，Line轉帳" "✅ 單項目，v1 格式"

# ============================================================
# 多項目記帳（核心功能）
# ============================================================

run_test "多項目" "TC-V15-010: 雙項目 - 逗號分隔" "早餐80元，午餐150元，現金" "✅ 2個項目，共用付款方式：現金"

run_test "多項目" "TC-V15-011: 雙項目 - 付款方式在前" "用狗卡，咖啡50，三明治35" "✅ 2個項目，共用付款方式：台新狗卡"

run_test "多項目" "TC-V15-012: 三項目 - 早午晚餐" "早餐50元，午餐120元，晚餐200元，現金" "✅ 3個項目，共用付款方式：現金"

run_test "多項目" "TC-V15-013: 雙項目 - 分號分隔" "咖啡45元；蛋糕120元；Line轉帳" "✅ 2個項目，分號分隔"

run_test "多項目" "TC-V15-014: 雙項目 - 頓號分隔" "早餐三明治35、飲料30、現金" "✅ 2個項目，頓號分隔"

run_test "多項目" "TC-V15-015: 四項目以上" "咖啡50、三明治35、沙拉80、果汁40、現金" "✅ 4個項目，共用付款方式"

# ============================================================
# 共用付款方式驗證
# ============================================================

run_test "共用驗證" "TC-V15-020: 共用交易ID驗證" "早餐80元，午餐150元，現金" "✅ 檢查兩個項目的交易ID是否相同"

run_test "共用驗證" "TC-V15-021: 共用日期驗證" "早餐80元，午餐150元，現金" "✅ 檢查兩個項目的日期是否相同"

run_test "共用驗證" "TC-V15-022: 共用付款方式驗證" "咖啡50，三明治35，用狗卡" "✅ 檢查兩個項目的付款方式是否都是台新狗卡"

# ============================================================
# 錯誤處理與邊界案例
# ============================================================

run_test "錯誤處理" "TC-V15-030: ❌ 不同付款方式（應拒絕）" "早餐80元現金，午餐150元刷卡" "❌ 應回傳錯誤：偵測到不同付款方式"

run_test "錯誤處理" "TC-V15-031: ❌ 第二項缺少金額（應拒絕）" "早餐80元，午餐，現金" "❌ 應回傳錯誤：第2個項目缺少金額"

run_test "錯誤處理" "TC-V15-032: ❌ 模糊情況（應拒絕）" "三明治和咖啡80元現金" "❌ 應回傳錯誤：無法確定項目數"

run_test "錯誤處理" "TC-V15-033: ❌ 缺少付款方式（應拒絕）" "早餐80元，午餐150元" "❌ 應回傳錯誤：缺少付款方式"

run_test "錯誤處理" "TC-V15-034: ❌ 第一項缺少金額（應拒絕）" "早餐，午餐150元，現金" "❌ 應回傳錯誤：第1個項目缺少金額"

run_test "錯誤處理" "TC-V15-035: ❌ 缺少品項名稱（應拒絕）" "80元，150元，現金" "❌ 應回傳錯誤：缺少品項名稱"

# ============================================================
# 對話意圖識別
# ============================================================

run_test "對話意圖" "TC-V15-040: 打招呼" "你好" "✅ 意圖：對話"

run_test "對話意圖" "TC-V15-041: 詢問功能" "可以幫我做什麼？" "✅ 意圖：對話"

run_test "對話意圖" "TC-V15-042: 感謝" "謝謝" "✅ 意圖：對話"

# ============================================================
# 複雜場景測試
# ============================================================

run_test "複雜場景" "TC-V15-050: 含明細說明的多項目" "在開飯早餐50元，在7-11買咖啡45元，現金" "✅ 2個項目，含明細說明"

run_test "複雜場景" "TC-V15-051: 含不同分類的多項目" "咖啡50元，蛋糕120元，狗卡" "✅ 2個項目，不同分類（飲品、點心）"

# ============================================================
# 完成
# ============================================================

echo ""
echo "======================================================================"
echo "✅ v1.5.0 測試完成！"
echo "======================================================================"
echo ""
echo "測試統計："
echo "  - 向後相容：3 個測試"
echo "  - 多項目核心功能：6 個測試"
echo "  - 共用驗證：3 個測試"
echo "  - 錯誤處理：6 個測試"
echo "  - 對話意圖：3 個測試"
echo "  - 複雜場景：2 個測試"
echo "  - 總計：23 個測試"
echo ""
echo "關鍵驗證點："
echo "  ✅ 向後相容：單項目使用 v1 格式"
echo "  ✅ 多項目處理：2-4+ 項目正確識別"
echo "  ✅ 共用驗證：交易ID、付款方式、日期相同"
echo "  ❌ 錯誤拒絕：不同付款方式、缺少資訊、模糊情況"
echo ""
