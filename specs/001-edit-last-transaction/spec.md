# Feature Specification: 修改上一次交易記錄

**Feature Branch**: `001-edit-last-transaction`
**Created**: 2025-11-29
**Status**: Draft
**Input**: User description: "修改上一次的交易記錄項目,包括品項、分類、專案、金額"

## Clarifications

### Session 2025-11-29

- Q: 當使用者開始修改上一筆交易的過程中，系統新增了新的交易記錄（例如多裝置同步），應該如何處理？ → A: 修改操作開始時鎖定目標交易 ID，即使期間有新交易，仍修改原鎖定的交易
- Q: FR-008 要求記錄修改歷史用於審計，這些歷史記錄應保留多久？ → A: 不保留（考量 Vercel KV 儲存限制）
- Q: 金額為零或負數時應如何處理？ → A: 允許零值（代表免費項目），拒絕負數
- Q: 當多筆交易具有相同時間戳記時，如何決定哪一筆是「最新的」？ → A: 使用交易 ID 作為次要排序（ID 較大者為最新）
- Q: 使用者介面的主要觸發方式為何？ → A: 文字指令為主（LINE Bot 對話式介面）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速修改最近一筆交易的品項 (Priority: P1)

使用者剛完成一筆記帳後,發現品項名稱輸入錯誤或不夠精確。例如,使用者記錄了「午餐」,但希望修改為更具體的「工作午餐」或「客戶聚餐」。使用者希望能夠快速取得並修改最近一筆交易的品項,而不需要搜尋或瀏覽歷史記錄。

**Why this priority**: 品項是記帳中最容易出錯的欄位,使用者在輸入後常需要立即調整。能夠快速修改最近一筆交易的品項可以大幅提升記帳體驗,減少使用者的挫折感。這是最基本且最常用的修改需求。

**Independent Test**: 可透過新增一筆交易,然後執行「修改上一筆」操作,驗證品項欄位可被成功更新,且不影響其他欄位。

**Acceptance Scenarios**:

1. **Given** 使用者剛完成一筆品項為「午餐」的交易記錄,**When** 使用者要求修改上一筆交易的品項為「工作午餐」,**Then** 該筆交易的品項更新為「工作午餐」,其他欄位(金額、分類、日期等)保持不變
2. **Given** 使用者執行修改上一筆交易品項的操作,**When** 修改完成,**Then** 系統顯示成功訊息,包含更新後的品項名稱
3. **Given** 資料庫中沒有任何交易記錄,**When** 使用者嘗試修改上一筆交易,**Then** 系統提示「無可修改的交易記錄」

---

### User Story 2 - 調整最近一筆交易的分類 (Priority: P2)

使用者完成記帳後,發現交易分類不正確或需要重新歸類。例如,使用者將「計程車費用」分類為「其他」,但後來想改為「交通」分類以便追蹤交通支出。

**Why this priority**: 分類是記帳分析的重要維度,正確的分類可以幫助使用者了解支出結構。修改最近一筆交易的分類可以快速修正分類錯誤,提升資料品質。

**Independent Test**: 可建立一筆具有特定分類的交易,執行「修改上一筆」操作更新分類,驗證分類變更正確且不影響其他欄位。

**Acceptance Scenarios**:

1. **Given** 使用者剛完成一筆分類為「其他」的交易記錄,**When** 使用者要求修改上一筆交易的分類為「交通」,**Then** 該筆交易的分類更新為「交通」
2. **Given** 使用者修改了上一筆交易的分類,**When** 修改完成,**Then** 系統顯示更新成功訊息,包含新的分類名稱
3. **Given** 使用者要修改上一筆交易的分類,**When** 提供的分類名稱為空值,**Then** 系統保留原有的分類,不進行更新

---

### User Story 3 - 指派或變更最近一筆交易的專案 (Priority: P3)

使用者完成記帳後,希望將該筆交易關聯到特定專案。例如,使用者支付了一筆會議室租金,後來想將這筆費用歸屬到「Q4 行銷活動」專案以便追蹤專案成本。

**Why this priority**: 專案管理功能對需要追蹤專案成本的使用者有價值,但相對於品項和分類,專案是較進階的功能。能夠快速為最近一筆交易指派專案可以提升專案財務管理效率。

**Independent Test**: 可建立一筆交易,執行「修改上一筆」操作指派專案,驗證專案關聯正確建立,且可透過專案篩選查看該交易。

**Acceptance Scenarios**:

1. **Given** 使用者剛完成一筆專案為「個人支出」的交易,**When** 使用者要求修改上一筆交易的專案為「Q4 行銷活動」,**Then** 該筆交易的專案更新為「Q4 行銷活動」
2. **Given** 使用者的上一筆交易專案為「個人支出」,**When** 使用者修改專案為「工作專案」,**Then** 原有的專案「個人支出」被「工作專案」取代
3. **Given** 使用者要修改上一筆交易的專案,**When** 提供空值,**Then** 系統保留原有的專案,不進行更新

---

### User Story 4 - 修正最近一筆交易的金額 (Priority: P4)

使用者完成記帳後,發現金額輸入錯誤需要修正。例如,使用者將 350 元誤輸入為 35 元,或發現帳單金額包含服務費需要調整。

**Why this priority**: 金額是記帳的核心資料,但相對於品項和分類,金額修改的頻率較低(大多數使用者輸入金額時會更謹慎)。雖然金額準確性很重要,但因使用頻率較低,優先度相對較低。

**Independent Test**: 可建立一筆具有特定金額的交易,執行「修改上一筆」操作更新金額,驗證金額計算正確且更新成功。

**Acceptance Scenarios**:

1. **Given** 使用者剛完成一筆金額為 35 元的交易,**When** 使用者要求修改上一筆交易的金額為 350 元,**Then** 該筆交易的金額更新為 350 元
2. **Given** 使用者修改了上一筆交易的金額,**When** 修改完成,**Then** 系統顯示更新成功訊息,包含新的金額
3. **Given** 使用者要修改上一筆交易的金額,**When** 提供的金額為無效值(如非數字、負數),**Then** 系統提示格式錯誤並拒絕更新
4. **Given** 使用者要修改上一筆交易的金額,**When** 提供金額為 0（免費項目）,**Then** 系統接受並更新金額為 0

---

### Edge Cases

- 當資料庫中沒有任何交易記錄時,使用者嘗試修改上一筆交易,系統應如何回應?
- 當使用者連續多次執行「修改上一筆」操作,系統是否始終指向同一筆交易(最新的)?
- 當使用者修改上一筆交易的過程中,有新的交易被新增(例如多裝置同步),修改操作開始時已鎖定目標交易 ID,仍修改原鎖定的交易
- 當使用者嘗試將金額修改為 0 時,系統允許（代表免費項目）;修改為負數時,系統拒絕並提示錯誤
- 當使用者修改上一筆交易時提供空值,系統保留原值不進行更新(所有欄位皆為必填)
- 當多筆交易具有相同時間戳記時,系統使用交易 ID 作為次要排序（ID 較大者為最新）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能夠識別並取得使用者最近一筆交易記錄(基於建立時間排序,若時間戳記相同則以交易 ID 較大者為最新)
- **FR-002**: 系統必須支援修改最近一筆交易的以下欄位:品項、分類、專案、金額
- **FR-003**: 系統必須在修改完成後顯示成功訊息,包含更新的欄位名稱和新值
- **FR-004**: 系統必須驗證修改輸入值的格式,確保資料正確(如金額必須為數字且不可為負數,允許為零)
- **FR-005**: 系統必須在無可修改的交易記錄時(資料庫為空),提示使用者「無可修改的交易記錄」
- **FR-006**: 系統必須在修改操作開始時鎖定目標交易 ID,確保單次修改操作始終針對同一筆交易,即使期間有新交易被新增
- **FR-007**: 使用者必須能夠透過單一指令快速修改上一筆交易,無需手動搜尋或提供交易 ID
- **FR-008**: 系統必須支援修改單一欄位,而不影響其他欄位的值
- **FR-009**: 所有欄位(品項、分類、專案、金額)皆為必填,當使用者修改時提供空值,系統必須保留原值而不進行更新

### Key Entities

- **交易記錄 (Transaction)**: 代表一筆記帳記錄,包含品項、分類、專案、金額、日期、建立時間等屬性。「上一筆交易」指根據建立時間排序後的最新一筆記錄（若時間戳記相同，則以交易 ID 較大者為最新）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 10 秒內完成「修改上一筆交易」的操作(包含發出指令、輸入新值、確認)
- **SC-002**: 修改上一筆交易的功能回應時間不超過 1 秒
- **SC-003**: 95% 的使用者在第一次使用「修改上一筆」功能時能夠成功完成操作,無需查看說明文件
- **SC-004**: 「修改上一筆」功能減少使用者搜尋和瀏覽交易記錄的操作次數達 80% 以上
- **SC-005**: 修改操作的錯誤率低於 1%(資料驗證失敗、操作中斷等)
- **SC-006**: 使用者對「修改上一筆」功能的滿意度評分達 4.5 分以上(5 分滿分)

## Assumptions

- 假設系統目前已支援單筆交易記錄的建立、讀取、更新、刪除(CRUD)功能
- 假設每筆交易記錄都有唯一的 ID 和時間戳記(建立時間)
- 假設所有交易記錄的欄位(品項、分類、專案、金額、日期)皆為必填,不存在空值
- 假設「上一筆交易」的定義為根據建立時間排序後的最新一筆記錄
- 假設系統為單使用者環境,或修改操作僅影響當前使用者的交易記錄
- 假設使用者介面以文字指令為主要觸發方式(LINE Bot 對話式介面)
- 假設修改操作為「覆蓋」模式,當提供有效新值時直接取代舊值;當提供空值時保留原值
- 假設系統具備基本的資料驗證機制(如金額格式、日期格式)
- 假設使用者擁有足夠的權限修改自己的交易記錄
