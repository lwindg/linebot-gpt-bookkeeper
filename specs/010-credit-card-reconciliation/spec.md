# 010 - 信用卡對帳（結帳自動比對 / 缺漏提醒 / 手續費分攤）

> 文件語言：本規格書以正體中文撰寫（符合 `AGENTS.md` / `CLAUDE.md` 的「規格與溝通用中文」原則）。

## 1. 目標（Goals）

在每月信用卡結帳時，使用者匯入帳單明細（主要來源：PDF / 截圖圖片），系統能：

1) 將帳單明細轉成結構化資料（Statement Lines）
2) 自動將帳單明細與 Notion 記帳資料庫「新帳目」進行比對（允許入帳/交易日期有 ±1~2 天落差）
3) 支援 **1 筆帳單項目 ↔ 多筆記帳品項** 的情境（多品項記帳），以 **批次ID**（既有欄位）為核心進行聚合比對
4) 支援國外刷卡 **手續費** 的偵測與分攤：
   - 帳單通常為「一筆消費 + 一筆手續費」
   - 若消費對應多筆品項（同批次ID），則依比例分攤至各品項之 `手續費` 欄位
5) 產出缺漏清單：
   - 帳單有、記帳沒有（建議補記）
   - 記帳有、帳單沒有（可能延後入帳/刷錯卡/付款方式誤填/或非本期）
6) 提供「確認勾選結算」機制：當使用者確認匹配後，標記該筆/該批次為「本月已對帳」。

## 2. 非目標（Non-goals / Out of scope for MVP）

MVP 先不處理或只做提示：

- 分期/拆帳：1 筆消費拆成多筆帳單項目（installments）
- 預授權/完成請款差額（hotel deposit / tips adjustments）
- 帳單內手續費「內含在同一筆入帳金額」且沒有獨立列明（若遇到先進到人工處理）
- 跨卡自動推斷（多張卡同時對帳）
- 完整 PDF 表格解析的 100% 自動化（先以 OCR + 模板/半結構為主）

## 3. 既有資料現況（Notion：新帳目）

本功能以 Notion 記帳資料庫「新帳目」為主資料來源。已確認存在下列欄位（可直接用於對帳）：

- `日期`（date）
- `付款方式`（select）：已可辨識卡/帳戶（例如台新狗卡、大戶信用卡等）
- `批次ID`（rich_text）：多品項同一筆刷卡共用（已存在）
- `交易ID`（rich_text）：單筆項目識別（已存在，可用作無批次ID時的 fallback）
- `原幣別`（select） + `原幣金額`（number）：外幣交易原幣資訊（已存在）
- `匯率`（number）：可用於 sanity check
- `手續費`（number）：可用於對帳後分攤寫入（已存在）
- 其他：`品項`、`分類`、`專案`、`附註`、`明細說明`、`收款／支付對象`…等

> 重要：MVP **不強制**新增 `card_last4`。對帳先以 `付款方式` 作為卡別/帳戶篩選依據。

## 4. 新增資料結構（Notion）

### 4.1 新增資料庫：信用卡帳單明細（cc_statement_lines）

每一行代表帳單上的「一筆入帳項目」，包含手續費那行。

建議欄位（MVP 必要）：

- `帳單月份`（select 或 text；格式：YYYY-MM）
- `付款方式`（select，選項需與「新帳目」一致或可對應）
- `入帳日`（date）
- `交易日`（date，可空；若帳單提供）
- `台幣金額`（number；消費為正數或負數需先統一規則，見 6.2）
- `原幣別`（select，可空）
- `原幣金額`（number，可空）
- `商店/描述`（rich_text）
- `是否手續費`（checkbox）
- `來源檔案`（files 或 url，可選：保存 PDF/圖片連結）
- `raw_text`（rich_text，可選：OCR 原文片段）
- `對帳狀態`（select：unmatched / proposed / matched / ignored，可選）

### 4.2 對帳關聯

在 `cc_statement_lines` 增加 relation：

- `對應帳目`（relation → 新帳目；允許多對多）

用途：
- 1 筆帳單行 ↔ 多筆帳目（同批次ID）
- 1 筆手續費行 ↔ 對應的消費帳目（同批次ID）

> 若 Notion relation 操作成本過高，可退一步以 rich_text 存 `批次ID`/`交易ID` 清單，但不建議作為長期方案。

## 5. 匯入流程（PDF / 圖片 → 帳單明細）

### 5.1 支援銀行（MVP）

- 先支援：**台新**（已確認）
- 同一銀行多張卡：本期包含 `台新狗卡` + `灰狗卡`（兩張皆屬台新）

### 5.2 台新帳單版面（依範例帳單）

台新帳單明細表頭欄位（依你提供的截圖）包含：

- `消費日`
- `入帳起息日`
- `消費明細`
- `新臺幣金額`
- `外幣折算日`
- `消費地`
- `幣別`
- `外幣金額`

卡別/卡片段落標示（用於把帳單行對應到 Notion 的 `付款方式`）：

- `Richart卡(原@GoGoicash御璽)(卡號末四碼:4606)` → **台新狗卡**
- `Richart卡(原FlyGo鈦金商務)(卡號末四碼:3900)` → **灰狗卡**

> 這代表：雖然 MVP 不強制你在「新帳目」新增末四碼欄位，但匯入時我們可以從帳單自動辨識末四碼，將每一筆 `cc_statement_line.付款方式` 精準對到狗卡/灰狗卡，顯著降低誤配。

### 5.3 匯入方式（MVP）

- 使用者提供：PDF 或 截圖圖片
- 系統進行 OCR（或先由使用者貼上 OCR 結果做 fallback）
- 解析成「帳單明細行」的結構化欄位後，寫入 Notion `cc_statement_lines`

### 5.3 解析策略（MVP）

- 使用「銀行模板」定義欄位擷取：日期、金額、原幣、描述、是否手續費
- 解析失敗的行：仍寫入 Notion，但標記 `對帳狀態=unmatched` 且保留 `raw_text` 供人工修正

## 6. 比對（Matching）規則

### 6.1 候選集合（Candidate Set）

針對每一筆 `cc_statement_line`：

1) 先用 `付款方式` 篩選新帳目（同卡）
   - 本期台新包含兩張卡：`台新狗卡`、`灰狗卡`。
   - 匯入/解析時若能辨識到卡別，則直接對應到其中一張；若辨識不到，則允許在兩張卡的集合內做候選（Need Confirm 風險會上升）。
2) 日期容忍：以 **入帳起息日** 為主，搜尋新帳目 `日期` 落在 ±2 天內
   - 若帳單行同時有「消費日」，則消費日也可用於候選生成與打分（同日加權）。
3) 金額：優先使用原幣匹配（若帳單行有原幣）

### 6.2 金額正規化（Sign convention）

需在匯入時統一規則（已確認採用）：

- `台幣金額`、`原幣金額` 在 `cc_statement_lines` 內採：**消費=正數、退款/折抵/回饋=負數**。
  - 例如：回饋金、折抵金、退款等都可能是負數。
- 新帳目內現行金額表現（支出/收入 formula）需確認後，匹配時取同方向的值：
  - 支出：取 `支出金額`（正數）
  - 退款/折抵/回饋：以負數表示（若既有系統以不同方式記錄，需在 matcher 做正規化）

### 6.3 原幣優先匹配

若帳單行具有 `原幣別` + `原幣金額`：

- 以新帳目 `原幣別`、`原幣金額` 作為主要比對條件
- 台幣金額作為次要校驗（允許小額容忍，避免匯率/四捨五入差異）

### 6.4 多品項（批次ID）匹配

若候選新帳目存在 `批次ID`：

- 以 `批次ID` 聚合：同批次的多筆帳目金額加總
- 若加總金額（優先原幣，其次台幣）與帳單行金額相符（在容忍範圍內），則視為「帳單行 ↔ 該批次所有帳目」匹配成功

### 6.5 無批次ID 的 fallback

- 若無 `批次ID`，可改用 `交易ID`（若帳單有可辨識的交易序號/授權碼則加分；若沒有則用單筆比對）

### 6.6 輸出分類

對帳結果分三類：

- Matched：唯一高信心匹配（可自動連結）
- Proposed / Need Confirm：有 2+ 候選或信心不足（提供候選清單給使用者確認）
- Unmatched：無候選（列入缺漏清單）

## 7. 手續費（Foreign Fee）處理

> 台新帳單用語：你確認「國外交易服務費」等同「國外交易手續費」。

### 7.1 手續費行偵測

帳單明細中若描述包含關鍵字（台新範例）：

- `國外交易服務費`

或通用關鍵字：

- `國外交易手續費`
- `手續費`
- `FX FEE` / `FOREIGN FEE`

則標記 `是否手續費=true`。

> 範例格式（台新）：`國外交易服務費—93.00`
>
> - `—93.00` 代表「這筆服務費是針對 **新臺幣金額 = 93** 的那筆外幣交易」的參考金額（不是服務費本身）。
> - **服務費實際金額**請以該行的 `新臺幣金額` 欄位為準（例如範例中該行新臺幣金額為 `1`）。

### 7.2 手續費對應

- 優先嘗試：同 `入帳日`（±1 天）且同卡的外幣消費批次
- 若找到唯一批次：將手續費行連結到該批次的帳目
- 若多候選：進入 Need Confirm

### 7.3 分攤寫入

當手續費行對應到某個批次（或單筆）：

- 若對應多筆帳目（同批次ID）：依各品項「金額占比」分攤手續費，寫入各帳目的 `手續費` 欄位
- 若僅單筆：手續費全額寫入該筆 `手續費`

> 分攤比例優先使用原幣金額；若缺原幣則使用台幣金額。

## 8. 缺漏清單（Missing Lists）

### 8.1 帳單有、記帳沒有

條件：`cc_statement_lines` 未匹配（unmatched）且非手續費行/或手續費行未能對應。

輸出：
- 日期、金額（台幣/原幣）、描述
- 建議動作：補記（可產生草稿）、忽略（年費/利息等）

### 8.2 記帳有、帳單沒有

條件：新帳目中同卡、日期在帳單月份範圍（含 ±2 天 padding）內，但沒有被任何帳單行連結。

輸出：
- 日期、品項、金額、批次ID/交易ID
- 建議原因：延後入帳到下期 / 刷錯卡 / 付款方式填錯

## 9. 使用者流程（LINE bot）

### 9.1 現況指令與選單（已存在）

- LINE 文字指令：
  - `功能` / `選單`：開啟 Flex Menu
  - `鎖定專案 ...` / `鎖定付款 ...` / `鎖定幣別 ...`
  - `鎖定狀態` / `全部解鎖`
  - `記帳教學`

> **注意**：LINE 無法在同一則訊息同時輸入文字與圖片，因此信用卡對帳需採「先鎖定模式，再上傳圖片」的互動。

### 9.2 MVP：鎖定對帳模式（新增，整合既有 lock 機制）

流程（建議以 Flex Menu 進入；亦保留文字指令）：

1) 進入模式：`鎖定對帳 台新 2026-01`
2) 上傳帳單截圖（可多張）
   - 每張圖片：解析台新帳單明細 → 寫入 Notion「信用卡帳單明細」
   - 並建立/更新 Notion「信用卡帳單」（statement）
3) 執行比對：`執行對帳`
   - 跑 matching（含 batch consume / 同日優先 / ledger query window 自動延伸）
   - 寫回 Notion relation：
     - 帳單明細 `對應帳目` / `對帳狀態`
     - 新帳目 `對應帳單明細` / `對應帳單`
4) 離開模式：`解除對帳` 或 `全部解鎖`

### 9.3 指令前綴（建議）

- 現況指令多為中文自然語句。
- 建議為所有指令提供「可選的 `/` 前綴」相容層（例如 `/功能`、`/鎖定專案 ...`），但需保持現有無前綴指令仍可用。

## 10. 「勾選結算 / 已對帳」如何落地

### 10.1 最新決策（已採用）

- **不使用** `對帳月份(select)`（選項會無限增長，且跨期/補登容易混亂）。
- 改以 Notion relation 作為唯一對帳依據：
  - 新帳目：
    - `對應帳單明細`（relation → 信用卡帳單明細）
    - `對應帳單`（relation → 信用卡帳單）
  - 信用卡帳單明細：
    - `所屬帳單`（relation → 信用卡帳單）
    - `對應帳目`（relation → 新帳目）

> 這樣「是否已對帳」可用 relation 是否為空判斷；若仍需要月份視角，可用 rollup/公式從 `對應帳單.帳單結帳日` 產生顯示欄位。

### 10.2 Close（關帳）

MVP 可先不做「關帳」專用指令；只要 relation 寫回完成，即可在 Notion 用 view 篩選 matched/unmatched。後續若要 close：
- 在「信用卡帳單」增加狀態欄位（open/closed）
- close 時鎖定該 statement 不再自動重跑覆蓋。

## 11. 驗收標準（Acceptance Criteria）

### 11.1 基本匯入
- [ ] 使用者提供台新/永豐帳單 PDF/圖片後，可在 Notion 產生對應的 `cc_statement_lines` 記錄
- [ ] 每筆記錄至少包含：帳單月份、付款方式、入帳日、台幣金額、描述

### 11.2 自動匹配（含日期飄移）
- [ ] 對同卡交易，日期 ±2 天內且金額一致者，系統可自動提出匹配

### 11.3 多品項批次ID
- [ ] 若記帳為多筆且 `批次ID` 相同，系統可將其聚合並成功對上一筆帳單行

### 11.4 原幣優先
- [ ] 若帳單行含原幣資訊，匹配時優先使用原幣別/原幣金額，比台幣更優先

### 11.5 手續費分攤
- [ ] 帳單中獨立列出的手續費能被偵測並與外幣消費匹配
- [ ] 若消費對應多筆帳目（同批次ID），手續費能依比例分攤寫入每筆的 `手續費`

### 11.6 缺漏清單
- [ ] 能列出「帳單有但記帳無」與「記帳有但帳單無」兩份清單供使用者確認

### 11.7 Close / 結算
- [ ] 使用者確認後可執行 close，寫回已對帳標記（依 10 的選擇）

## 12. 釐清事項（需使用者確認）

> ✅ 已確認：
>
> 1) 銀行模板：先支援 **台新**
> 2) 帳單日期欄位：提供 **消費日 + 入帳起息日**（兩日期）
> 3) 金額正規化：採 **消費=正數、退款/折抵/回饋=負數**（負數可能代表回饋或折抵）
> 4) 對帳寫回：以 Notion relation 為準（新帳目 `對應帳單` / `對應帳單明細`），不使用 `對帳月份(select)`。
> 5) 台新卡別用詞需與新帳目一致：`台新狗卡` + `FlyGo 信用卡`
> 6) LINE 互動採「鎖定對帳模式」（先下指令/點選單，再上傳圖片）。
