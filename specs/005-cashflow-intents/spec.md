# Feature Specification: Cashflow Intents MVP

**Feature Branch**: `005-cashflow-intents`  
**Created**: 2026-01-08  
**Status**: Draft  
**Input**: User description: "目前已在適當的分支，也建立了 draft 版的規格於 specs/005-cashflow-intents/spec.md 之下，依此做基礎建立規格 如從合庫提款時，記兩筆： - 品項：合庫提款 原幣金額：5000 付款方式：合庫轉帳 分類：提款 交易類型：提款 - 品項：合庫提款 原幣金額：5000 付款方式：現金 分類：提款 交易類型：收入"
**Language**: 本文件內容以正體中文撰寫，程式碼/識別符/錯誤訊息維持英文

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 提款雙筆記錄 (Priority: P1)

使用者輸入提款描述（例如「合庫提款 5000」），系統自動建立兩筆現金流記錄：
一筆代表帳戶資金流出、另一筆代表現金流入，金額相同。

**Why this priority**: 提款是高頻情境且直接影響資金流向，錯記會造成金流失真。

**Independent Test**: 輸入含提款描述與金額的訊息後，應產生兩筆記錄且金額一致，
付款方式與交易類型符合規範。

**Acceptance Scenarios**:

1. **Given** 使用者輸入「合庫提款 5000」且未指定幣別, **When** 系統建立記錄, **Then**
   產生兩筆金額為 5000 的記錄，品項皆為「合庫提款」，交易類型分別為
   「提款」與「收入」，且付款方式分別為「合庫轉帳」與「現金」。
2. **Given** 使用者輸入「ATM 領現 3000（現金）」, **When** 系統建立記錄, **Then**
   產生兩筆金額為 3000 的記錄，並清楚標示一筆為帳戶流出、一筆為現金流入。

---

### User Story 2 - 轉帳意圖記錄 (Priority: P2)

使用者輸入轉帳描述（例如「轉帳給媽媽 2000」），系統能辨識為轉帳並建立記錄。

**Why this priority**: 轉帳是常見資金移動情境，需正確分類與追蹤對象。

**Independent Test**: 輸入含轉帳描述與金額的訊息後，應建立轉帳記錄且包含金額。

**Acceptance Scenarios**:

1. **Given** 使用者輸入「轉帳給媽媽 2000」, **When** 系統建立記錄, **Then**
   產生單筆記錄且交易類型為「支出」，並保留付款方/收款方資訊（若有提供）。
2. **Given** 使用者輸入「合庫轉帳到台新 2000」, **When** 系統建立記錄, **Then**
   產生兩筆金額相同的記錄，交易類型分別為「轉帳」與「收入」。
3. **Given** 使用者輸入「合庫轉帳到富邦 2000」, **When** 系統建立記錄, **Then**
   產生兩筆金額相同的記錄，交易類型分別為「轉帳」與「收入」。
4. **Given** 使用者輸入「合庫轉帳給媽媽 2000」, **When** 系統建立記錄, **Then**
   產生單筆記錄且交易類型為「支出」。

---

### User Story 3 - 收入與繳卡費意圖記錄 (Priority: P3)

使用者輸入收入或繳卡費描述（例如「薪水入帳 60000」、「繳卡費 15000」），
系統能辨識意圖並建立記錄。

**Why this priority**: 收入與繳卡費影響現金流全貌，需納入 MVP 的基本覆蓋範圍。

**Independent Test**: 分別輸入收入與繳卡費訊息後，應建立對應意圖的記錄且保留金額。

**Acceptance Scenarios**:

1. **Given** 使用者輸入「薪水入帳 60000」, **When** 系統建立記錄, **Then**
產生收入記錄且交易類型為「收入」、金額為 60000。
2. **Given** 使用者輸入「繳卡費 15000」, **When** 系統建立記錄, **Then**
   產生繳卡費記錄且金額為 15000。
3. **Given** 使用者輸入「合庫繳卡費到富邦 1500」, **When** 系統建立記錄, **Then**
   產生兩筆金額相同的記錄，交易類型分別為「轉帳」與「收入」。

---

### Edge Cases

- 金額缺失或無法解析時，系統如何回應？
- 同一句話同時出現「轉帳」與「提款」關鍵描述時如何判斷？
- 使用者輸入 0 或負數金額時，回傳錯誤並要求正數金額。

## Clarifications

### Session 2026-01-08

- Q: 多意圖同時命中時的判斷優先序 → A: 固定優先序：card_payment > transfer > withdrawal > income
- Q: 非正數金額的處理 → A: 回傳錯誤，要求提供正數金額
- Q: 付款方式／帳戶未提供時的預設值 → A: 使用 NA
- Q: 轉帳給他人是否雙筆 → A: 對他人轉帳單筆記錄；帳戶間轉帳雙筆記錄

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST 辨識現金流意圖並歸類為 `withdrawal`, `transfer`, `income`,
  `card_payment` 之一。
- **FR-002**: System MUST 在意圖為 `withdrawal` 時建立兩筆金額相同的記錄，
  分別代表帳戶流出與現金流入；交易類型分別為「提款」與「收入」。
- **FR-003**: System MUST 在意圖為 `transfer` 且為帳戶間移轉時建立雙筆記錄，
  交易類型分別為「轉帳」與「收入」。
- **FR-004**: System MUST 在意圖為 `transfer` 且為對他人轉帳時建立單筆記錄，
  交易類型為「支出」。
- **FR-005**: System MUST 將繳卡費視為 `transfer` 意圖，並以「帳戶 → 信用卡」
  表達資金移轉，交易類型分別為「轉帳」與「收入」。
- **FR-006**: System MUST 讓收入記錄沿用既有支出相同的欄位與分類結構。
- **FR-007**: System MUST 保留每筆記錄的品項名稱、原幣金額、付款方式、分類、交易類型。
- **FR-008**: System MUST 在多意圖同時命中時，依固定優先序判斷：
  `card_payment` > `transfer` > `withdrawal` > `income`。
- **FR-009**: System MUST 在缺少必填欄位（至少金額）時提供可理解的錯誤訊息。
- **FR-010**: System MUST 在無法辨識為現金流意圖時沿用原有記帳流程。
- **FR-011**: System MUST 在金額為 0 或負數時回傳錯誤，要求提供正數金額。
- **FR-012**: System MUST 在付款方式或帳戶未提供時，欄位值記為 `NA`。

### Acceptance Notes

- 提款需可驗證雙筆記錄金額一致且交易類型為「提款／收入」。
- 帳戶間轉帳需可驗證雙筆記錄金額一致且交易類型為「轉帳／收入」。
- 對他人轉帳需可驗證為單筆且交易類型為「支出」。
- 繳卡費需可驗證為 transfer 意圖且交易類型為「轉帳／收入」。
- 收入需可驗證欄位結構與支出一致。

### Assumptions

- 預設幣別為 TWD，除非使用者明確指定。
- 品項名稱可直接使用使用者輸入的描述（例如「合庫提款」）。

### Key Entities *(include if feature involves data)*

- **Cashflow Entry**: 一筆現金流記錄，包含品項、金額、付款方式、分類、交易類型、時間。
- **Intent**: 使用者輸入所對應的現金流意圖分類。
- **Payment Method**: 付款或資金來源方式（例如「合庫轉帳」、「現金」）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在 20 筆包含提款描述的測試輸入中，100% 產生兩筆金額一致的記錄。
- **SC-002**: 80% 以上的測試使用者可在 1 分鐘內完成單筆現金流記錄輸入並確認結果。
- **SC-003**: 金額缺失的輸入 100% 返回清楚的錯誤訊息並指出需補充的欄位。
- **SC-004**: 在測試資料集中，現金流意圖辨識正確率達 90% 以上。
