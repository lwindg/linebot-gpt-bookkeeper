# 010 更新專案：短期專案比對與清單查詢

## 概述

目前「修改上一筆」可直接更新專案欄位，但沒有專案清單與比對能力。使用者輸入短期專案（如「日本玩雪」）時，無法自動對應到 Notion select options 中的完整專案名稱（如「20260206-14 日本玩雪」）。

本規格目標：在不引入 AI 判斷的前提下，更新專案時能以規則化方式比對 Notion select options，並在比對不唯一時提供候選清單；若使用者提供含日期的專案名稱且查不到，允許直接建立。

## 目標

- 更新專案時支援「短期專案」比對與候選建議
- 長期專案使用程式碼固定清單，直接更新
- 透過 Make.com 取得 Notion select options（不在 Vercel 端保存 Notion token）
- 比對範圍限定為「過去 30 天到未來所有日期」
- 不新增多回合狀態機，維持單回合更新
- 支援「專案清單」指令，列出近期短期專案

## 範圍

### In Scope

- 專案欄位更新時的比對流程
- Make.com webhook 取得 Notion select options
- 以日期前綴解析短期專案的時間範圍
- 候選清單回覆（最多 3 筆）
- KV 快取 options（TTL 可設定）
- 「專案清單」指令列出近期短期專案

### Out of Scope

- 新增專案選單互動（多回合選擇）
- 變更 update intent 的欄位規則
- Notion API 直連
- 其他欄位的相似比對

## 使用者流程

1. 使用者輸入「專案修改為日本玩雪」
2. 系統判斷非長期專案 → 透過 Make 取得 Notion options
3. 篩出「過去 30 天到未來所有日期」的短期專案
4. 去日期前綴後比對相似度
5. 若唯一且相似度 ≥ 0.6 → 直接更新為完整名稱
6. 若不唯一 → 回覆候選清單請使用者提供完整名稱

## 專案清單指令流程

1. 使用者輸入「專案清單」
2. 系統呼叫 Make 取得 Notion select options
3. 篩出「過去 30 天到未來所有日期」的短期專案
4. 依日期排序後回覆清單

## 專案命名規則（短期）

日期前綴格式：
- 一日：`YYYYMMDD`
- 多日（同月份）：`YYYYMMDD-DD`
- 多日（跨月）：`YYYYMMDD-MMDD`
- 多日（跨年）：`YYYYMMDD-YYYYMMDD`

> 只要名稱包含上述日期前綴，即視為「短期專案」。

## 長期專案清單（固定於 code config）

- 日常
- 家庭年度支出
- 個人年度支出
- 子女年度支出
- 健康檢查
- 登山行程
- 紀念日/送禮
- 旅遊
- 原生家庭
- 折扣/優惠

> 比對時需做正規化（全形/半形、空白、`/` vs `／`）。

## 功能需求

- FR-PROJ-01：更新欄位為「專案」時，若輸入命中長期專案清單 → 直接更新，不查 Notion。
- FR-PROJ-02：短期專案比對流程需透過 Make.com 取得 Notion select options。
- FR-PROJ-03：options 回應格式支援 `{"options": ["..."]}` 或純陣列 `["..."]`。
- FR-PROJ-04：短期專案候選需落在「過去 30 天到未來所有日期」範圍內。
- FR-PROJ-05：短期比對需使用去日期前綴後的名稱計算相似度，門檻為 `>= 0.6`。
- FR-PROJ-06：若相似度門檻內「唯一」候選，使用該候選完整名稱更新。
- FR-PROJ-07：若不唯一，回覆 3 筆候選清單，要求使用者提供完整名稱。
- FR-PROJ-08：若使用者輸入含日期前綴但比對不到，允許直接採用該值（建立新 option）。
- FR-PROJ-09：Make webhook 失敗時，若輸入含日期前綴可直接更新；否則回傳錯誤訊息。
- FR-PROJ-10：更新流程僅影響「專案」欄位，其他欄位不變。
- FR-PROJ-11：指令「專案清單」會列出近期短期專案（過去 30 天到未來所有日期）。
- FR-PROJ-12：清單僅包含含日期前綴的短期專案，依日期排序。

## 相似度規則

- 使用標準庫 `difflib.SequenceMatcher` 的 `ratio`。
- 比對對象：
  - 使用者輸入值（去日期前綴後）
  - 候選專案名稱（去日期前綴後）
- 若 `ratio >= 0.6` 的候選只有一筆 → 視為唯一。
- 若候選 >= 2 筆或 0 筆 → 視為不唯一。
- 候選排序規則：相似度由高到低；若相似度相同，依日期越近者優先。

## 回覆訊息規則

- 不唯一或無候選時：
  - `❌ 找不到唯一專案\n請輸入完整名稱（含日期），或從以下候選擇一個：\n1) ...\n2) ...\n3) ...`
- 候選不足 3 筆時僅列出實際候選數量；無候選時僅回覆提示，不列出清單。
- Make 失敗且無日期輸入：
  - `❌ 無法取得專案清單，請稍後再試或提供完整名稱（含日期）。`

## 驗收標準

- 輸入「專案修改為日本玩雪」能在唯一候選時自動更新為完整名稱。
- 相似候選不唯一時，回覆 3 筆候選並拒絕更新。
- 輸入含日期且 options 中不存在時，仍能更新成功。
- 長期專案命中時不會呼叫 Make。
- 比對範圍限定為「過去 30 天到未來所有日期」。
- 輸入「專案清單」可回覆近期短期專案清單。

## 測試案例

- TC-PROJ-001：長期專案命中（如「日常」）→ 直接更新
- TC-PROJ-002：短期唯一候選 → 自動套用完整名稱
- TC-PROJ-003：短期多候選 → 回候選 3 筆
- TC-PROJ-004：含日期輸入且 options 無對應 → 直接更新
- TC-PROJ-005：Make 失敗且無日期輸入 → 回錯誤訊息
- TC-PROJ-006：候選日期超出 30 天過去範圍 → 不參與比對
- TC-PROJ-007：輸入「專案清單」 → 回覆近期短期專案清單

## 假設與依賴

- Make webhook 能回傳 Notion select options。
- Notion 允許用新的 select name 更新並自動新增 option。
- 使用者輸入「含日期前綴」可視為明確專案名稱。
- 系統日期以執行當天為準（例如 2026-02-01 → 2026-01-02 起）。
- 短期比對只使用「含日期前綴」的 options，其餘選項忽略。
