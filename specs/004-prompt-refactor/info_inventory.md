# 資訊盤點（必要性／分類／代墊／專案）

本文件彙整目前系統的行為與約束，作為下一步 Prompt/Schema 重構的 baseline。

## 1) 資料模型（runtime）

### `app.gpt_processor.BookkeepingEntry`
- 目前實務上需要的欄位：`日期`、`品項`、`原幣金額`、`付款方式`、`分類`、`必要性`、`代墊狀態`、`收款支付對象`
- 預設值（code-level）：
  - `原幣別`: `"TWD"`
  - `匯率`: `1.0`（當 `原幣別 != "TWD"` 時會查匯率）
  - `明細說明`: `""`
  - `專案`: `"日常"`（目前文字/收據流程皆 hard-code）
  - `代墊狀態`: `"無"`
  - `收款支付對象`: `""`
  - `附註`: `""`（多項目流程會填入批次資訊）

### Structured Output Schema（`app/schemas.py`）
- `multi_bookkeeping` 的每個 `items[]` 必填：`品項`、`原幣別`、`原幣金額`、`明細說明`、`分類`、`必要性`、`代墊狀態`、`收款支付對象`
- `update_last_entry` 的 `fields_to_update` 允許：`品項`、`分類`、`專案`、`原幣金額`
- 注意：`items[]` 目前 schema **尚未包含** `專案`

## 2) 分類（`分類`）

### 來源（目前）
- Prompt 的分類清單：`app/prompts.py:CLASSIFICATION_RULES`
- 程式端驗證（目前僅更新流程）：`app/category_resolver.py` 會從 `CLASSIFICATION_RULES` 抽取分類並建立 allow-list

### 格式
- Prompt 文字主要使用全形斜線 `／`
- 程式端驗證會正規化為 `/`
- 測試與 KV / webhook payload 常見也用 `/`
- 目前為了跟 code/tests 對齊，建議系統輸出以 `/` 作為分類分隔符

### 規則（prompt-level）
- 必須從預定義分類中選擇，不可自建新分類
- 早餐/午餐/晚餐必須三層（例如 `家庭／餐飲／早餐`）
- 若無精確匹配，選最接近的既有分類（仍不可新建）

### 落地（code-level）
- 目前只在 `update_last_entry` 的分類更新做 enforcement：
  - 簡短分類（例如 `水果`）會解析成既有路徑（例如 `家庭/水果`）
  - 未知/新分類（例如 `水果/香蕉`）會被拒絕
  - 以使用者原始訊息抽取分類字串做驗證，避免 GPT 轉寫後繞過（例如把 `水果/香蕉` 轉成 `家庭/水果`）

## 3) 必要性（`必要性`）

### 允許值（schema/prompt）
- `必要日常支出`
- `想吃想買但合理`
- `療癒性支出`
- `衝動購物（提醒）`

### 目前預設（code-level）
- 文字流程：缺值時預設 `必要日常支出`
- 收據流程：固定填 `必要日常支出`

## 4) 代墊（`代墊狀態`／`收款支付對象`）

### 允許值（schema/prompt）
- `無` / `代墊` / `需支付` / `不索取`

### 目前預設（code-level）
- 文字流程：缺值時預設 `代墊狀態="無"`、`收款支付對象=""`
- 收據流程：固定填 `代墊狀態="無"`、`收款支付對象=""`

### 規則重點（prompt-level）
- 只有在訊息中出現明確代墊關鍵字時才判斷為代墊；否則一律 `無`
- 若代墊狀態為（`代墊`、`需支付`、`不索取`）必須同時有對象
- 訊息開頭的人名若沒有緊接代墊關鍵字，應視為品項的一部分（不是對象）

## 5) 專案（`專案`）

### 目前行為
- 記帳項目（文字 + 收據）：目前都硬編成 `"日常"`
- `update_last_entry`：`fields_to_update` 支援更新 `專案`，但目前沒有 validation/mapping

### 規劃（來自 `plan.md`）
目標是避免一律預設 `日常`，加入小而明確的推斷規則：
- 健康/醫療 → `健康檢查`
- 行程分類 → `登山行程`
- 禮物/節慶 → `紀念日／送禮`
- 其餘 → `日常`
- 活動型專案（例如 `20250517-18 玉山南稜`）先維持手動

## 6) 下一步重構前需要決策的點
- 已決策：
  - 分類輸出在「模型輸出→落地」之間統一正規化（`／`→`/`），對外/落地一律使用 `/`
  - 「不新建分類」的 enforcement 擴到 `multi_bookkeeping`（文字/收據）：
    - 若分類不在 allow-list，採「自動修正到最接近既有分類」
    - 若無法修正，fallback 為 `家庭支出`
  - 專案採 rule-based mapping（小而明確），沒有權威清單；其餘預設 `日常`
