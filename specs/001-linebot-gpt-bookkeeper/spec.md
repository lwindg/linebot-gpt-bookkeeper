# 功能規格書：LINE Bot GPT 記帳中介系統

**功能分支**：`001-linebot-gpt-bookkeeper`
**建立日期**：2025-11-11
**最後更新**：2025-11-14
**狀態**：v1.5.0 開發中（v1 MVP 已完成）
**輸入**：使用者描述：「建立一個 linebot 中介，接收 linebot 訊息後轉給 gpt 處理，若為記帳項目則轉為所需要的格式發送 webhook，並回覆記帳的完整格式」

## 版本策略

本規格採用 **MVP-First Development** 原則，分為四個遞進版本：

### v1 MVP - Serverless 最簡版（已完成）

**目標**：驗證「用自然語言記帳」的核心價值，以最簡單方式快速上線

**核心功能**：
- 接收 LINE 訊息，用 GPT 識別記帳意圖
- 處理**資訊完整**的單筆台幣記帳（有品項、金額、付款方式）
- 發送 webhook 到記帳系統
- 回覆使用者確認訊息
- 簡單的一般對話回應（透過 GPT，不需外部 API）

**架構特點**：
- **無狀態** Serverless function（如 AWS Lambda、Google Cloud Functions）
- **不儲存**對話歷史或任何資料
- 每次請求獨立處理
- 簡化的交易ID（使用時間戳記）
- 僅支援**台幣**（TWD）

**明確排除**（延後到後續版本）：
- 多輪對話（處理不完整項目）
- 對話脈絡管理和儲存
- 圖片/收據識別
- 即時資訊查詢（天氣、新聞、匯率 API）
- 單一訊息多筆支出
- 外幣支援和匯率 API
- 持久化重試佇列

---

### v1.5.0 - 多筆支出與視覺識別版（正在開發）

**目標**：在 v1 MVP 的無狀態架構基礎上，增加多筆支出和收據圖片識別能力

**新增功能**：
- **單一訊息多筆支出處理**：識別並處理一條訊息中的多筆記帳項目（如「早餐80元，午餐150元」）
- **圖片/收據識別（GPT Vision API）**：上傳收據圖片後自動提取金額、日期、品項等資訊

**架構特點**（維持 v1 MVP 無狀態設計）：
- **無狀態** Serverless function（與 v1 相同）
- **不儲存**對話歷史或任何資料
- 每次請求獨立處理
- 簡化的交易ID（與 v1 相同，使用時間戳記）
- 僅支援**台幣**（TWD）
- 多筆支出共用同一交易ID，發送多個獨立 webhook

**與 v1 的差異**：
- ✅ 支援單一訊息多筆支出（v1 不支援）
- ✅ 支援圖片訊息和 GPT Vision API（v1 僅支援文字）
- ❌ 仍不支援多輪對話和對話脈絡
- ❌ 仍不支援外幣和匯率 API
- ❌ 仍不支援即時資訊查詢

**明確排除**（延後到 v2）：
- 多輪對話（處理不完整項目）
- 對話脈絡管理和儲存
- 即時資訊查詢（天氣、新聞、匯率 API）
- 外幣支援和即時匯率 API
- 持久化重試佇列
- 複雜交易ID（YYYYMMDD-NNN 格式）

---

### v2 完整版（v1.5.0 驗證後開發）

**目標**：在 v1.5.0 基礎上，加入完整功能以提升使用者體驗和資料品質

**新增功能**：
- 對話脈絡管理（需要儲存層）
- 處理不完整項目的多輪對話（v2 版本：要求補齊後才建立項目）
- 即時資訊查詢（天氣、新聞、匯率、股價 API）
- 外幣支援和即時匯率 API
- 完整錯誤處理和持久化重試機制
- 週期性對話歷史清除
- 複雜交易ID（YYYYMMDD-NNN 格式）

**架構變化**：
- 需要資料庫或儲存服務（對話脈絡、重試佇列、交易ID計數器）
- 可能需要背景任務處理器（重試、定期清除）

---

### v3 未來版（視 v2 使用情況決定）

**目標**：進一步優化資料輸入流程

**實驗性功能**：
- 允許先建立**不完整**的記帳項目（立即發送 webhook）
- 系統同時詢問缺少的資訊
- 使用者補充後發送更新 webhook
- 若使用者回覆非補充資訊，智慧切換回一般對話

**待驗證問題**：
- 不完整項目對下游記帳系統的影響
- 使用者是否偏好「先記錄後補充」vs「補齊後記錄」
- 更新 webhook 的複雜度和可靠性

---

## Clarifications

### Session 2025-11-11

**v1 MVP 相關**：
- 無需釐清（使用簡化設計）

**v1.5.0 相關**：
- Q: When a user sends a single message with multiple expense items (e.g., "早餐80元，午餐150元，現金"), how should the system create transaction records? → A: This is ONE transaction with multiple items. Same transaction ID and payment method for all items, send multiple webhooks (one per item)
- Q: What if a message contains different payment methods (e.g., "早餐80元現金，午餐150元刷卡")? → A: This represents TWO separate transactions, not one. System should reject and ask user to record them separately
- Q: When users send images (potentially receipts), how should the system process them? → A: Use GPT Vision API to extract receipt details and create transaction if clear, ask for clarification if ambiguous

**v2 完整版相關**：
- Q: When generating the transaction ID (交易ID) in format "YYYYMMDD-NNN", how should the sequence number (NNN) be managed? → A: Daily counter per date that resets at midnight Taiwan time
- Q: When handling non-TWD currencies, where should the system retrieve real-time exchange rates from? → A: Free public exchange rate API with cached fallback
- Q: When GPT or the webhook endpoint is unavailable, how should the system handle incoming messages? → A: Queue messages and retry automatically with exponential backoff, notify users when processed

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 透過 LINE 發送記帳項目（版本：v1 MVP 起）

使用者透過 LINE 發送自然語言訊息描述其支出或收入，系統智慧辨識為記帳項目，進行處理，記錄到記帳系統中，並回覆格式化的確認摘要。

**優先級**：P1（所有版本的核心功能）

**為何此優先級**：這是核心功能 - 讓使用者透過自然對話記錄支出/收入。沒有這個功能，系統就沒有價值。

**獨立測試**：可以透過發送 LINE 訊息如「午餐花了150元現金」來完整測試，驗證：(1) GPT 正確識別為記帳項目，(2) 觸發 webhook 並傳送結構化資料，(3) 使用者收到包含完整格式化細節的確認訊息。

---

#### v1 MVP 驗收場景（資訊完整的單筆台幣記帳）

1. **假設** 使用者已將 LINE bot 加為好友，**當** 使用者發送「早餐花了80元買三明治用現金」（包含品項、金額、付款方式），**則** 系統回覆格式化項目，顯示金額、分類、描述和時間戳記
2. **假設** 使用者發送完整支出訊息，**當** GPT 處理並識別為記帳項目，**則** 觸發 webhook 並傳送包含所有 14 個欄位的結構化 JSON（幣別固定為 TWD，匯率固定為 1.0）
3. **假設** webhook 成功接收記帳資料，**當** 處理完成，**則** 使用者在 LINE 收到包含完整格式化項目細節的確認訊息
4. **假設** 使用者發送收入訊息如「收到薪水50000元轉帳」（包含品項、金額、付款方式），**當** 系統處理，**則** 項目正確分類為收入並相應觸發 webhook
5. **假設** 使用者發送不完整訊息如「買了咖啡」（缺少金額和付款方式），**當** GPT 處理，**則** 系統回覆「抱歉，請提供完整資訊（品項、金額、付款方式）以便記帳」，且不觸發 webhook

**v1 MVP 限制**：
- 僅支援台幣（TWD）交易
- 不支援單一訊息多筆支出
- 不處理不完整項目（要求使用者在單一訊息中提供完整資訊）
- 交易ID 使用簡化格式（時間戳記）

---

#### v1.5.0 新增場景

6. **假設** 使用者發送「早餐80元，午餐150元，現金」（單一訊息多筆支出，同一種付款方式），**當** 系統處理，**則** 為兩筆支出使用相同的交易ID和付款方式，但發送兩個獨立的 webhook
7. **假設** 使用者發送「咖啡50，三明治35，用狗卡」（多個項目共用付款方式），**當** 系統處理，**則** 正確識別兩個項目都使用「台新狗卡」付款，使用相同交易ID
8. **假設** 使用者發送收據圖片，**當** 系統使用 GPT Vision API 處理，**則** 提取品項、金額、日期等資訊並建立記帳項目，若資訊不清晰則回覆「無法辨識收據資訊，請提供文字描述」
9. **假設** 使用者發送包含多筆支出的收據圖片（如超商收據列出多個商品），**當** 系統識別圖片中有多個品項，**則** 為所有品項使用相同的交易ID和付款方式，並發送多個獨立的 webhook

**v1.5.0 增強**：
- 單一訊息多筆支出處理（同一次支出行為，多個項目，共用付款方式）
- 圖片/收據識別（GPT Vision API）
- 維持無狀態架構（不需要儲存層）
- 交易ID 格式與 v1 相同（時間戳記）

---

#### v2 完整版新增場景

9. **假設** 使用者發送「昨天在日本買了拉麵1200日圓付現金」，**當** 系統處理，**則** 正確識別幣別為 JPY，透過匯率 API 取得即時匯率，並在 webhook 中包含原幣別、原幣金額和匯率

**v2 完整版增強**：
- 支援多種幣別和即時匯率 API
- 複雜的交易ID 格式（YYYYMMDD-NNN）
- 對話脈絡管理和多輪對話
- 持久化重試機制

---

### 使用者故事 2 - 處理非記帳對話（版本：v1 MVP 起，v2 擴充）

使用者發送與記帳無關的訊息，系統識別並適當回應，不觸發記帳 webhook。

**優先級**：P2（避免誤觸發記帳）

**為何此優先級**：對自然使用者體驗至關重要 - 使用者應該能詢問記帳相關問題或進行一般對話，而不會觸發錯誤的記帳項目。

---

#### v1 MVP 驗收場景（簡單對話回應）

**獨立測試**：可以透過發送非記帳訊息如「你好」或「我可以記帳什麼？」來完整測試，驗證系統透過 GPT 回應且不觸發 webhook。

1. **假設** 使用者發送問候如「你好」，**當** GPT 處理訊息，**則** 系統以友善問候回應且不觸發 webhook
2. **假設** 使用者詢問記帳相關問題如「我可以記帳什麼？」，**當** GPT 處理訊息，**則** 系統提供有用資訊但不建立項目
3. **假設** 使用者發送模糊訊息，**當** GPT 無法判斷是否與記帳相關，**則** 系統向使用者詢問澄清問題
4. **假設** 使用者發送閒聊對話，**當** GPT 處理，**則** 系統自然回應，不觸發 webhook

**v1 MVP 限制**：
- 僅透過 GPT 進行對話回應
- 不整合外部即時資訊 API
- 無對話脈絡管理（每次請求獨立）

---

#### v2 完整版新增場景（即時資訊查詢）

**獨立測試**：可以透過發送即時資訊查詢如「今天台北天氣如何？」或「美金匯率多少？」來完整測試，驗證系統透過外部 API 查詢並回應。

5. **假設** 使用者詢問即時資訊如「今天台北天氣如何？」，**當** 系統識別為天氣查詢，**則** 透過天氣 API 取得即時資料並回覆，不觸發 webhook
6. **假設** 使用者詢問「美金匯率多少？」，**當** 系統識別為匯率查詢，**則** 透過匯率 API 查詢並回覆當前匯率，不觸發 webhook
7. **假設** 使用者查詢股價或新聞，**當** 系統識別意圖，**則** 透過對應 API 取得資料並回覆
8. **假設** 外部 API（天氣、新聞等）不可用，**當** 使用者查詢即時資訊，**則** 系統回覆適當的錯誤訊息或替代回應
9. **假設** 使用者在記帳對話中詢問即時資訊，**當** 系統處理，**則** 正確維護對話脈絡，先回答即時資訊，再繼續記帳流程

**v2 完整版增強**：
- 整合外部即時資訊 API（天氣、新聞、匯率、股價）
- 對話脈絡管理（能在多輪對話中維持上下文）
- 智慧意圖切換（在記帳和查詢之間流暢切換）

---

### 使用者故事 3 - 處理不完整的記帳項目（版本：v2 起）

使用者嘗試記錄記帳項目但提供的資訊不完整（例如缺少必填欄位：品項、原幣金額、付款方式），系統識別缺少的資訊並提示使用者提供，然後才建立項目並發送 webhook。

**優先級**：P3（v1 MVP 不支援，v2 起引入）

**為何此優先級**：透過確保所有記帳項目完整準確來提升資料品質和使用者體驗，但系統初期（v1 MVP）可以在沒有此功能的情況下運作。

**v1 MVP 行為**：
- 使用者發送不完整訊息時，系統回覆「抱歉，請提供完整資訊（品項、金額、付款方式）以便記帳」
- 不儲存對話脈絡，不支援多輪對話補充資訊
- 使用者需在單一訊息中提供所有必填資訊

---

#### v2 完整版驗收場景（補齊後才建立）

**獨立測試**：可以透過發送不完整訊息如「買了午餐」（沒有金額和付款方式）來完整測試，驗證系統在建立項目前要求提供缺少的資訊。

1. **假設** 使用者發送「買了咖啡」（缺少金額和付款方式），**當** GPT 處理訊息，**則** 系統詢問「請問花了多少錢？用什麼付款方式？」，且暫不發送 webhook
2. **假設** 使用者只發送「花了200元現金」（缺少品項），**當** GPT 處理訊息，**則** 系統詢問「請問買了什麼？」，且暫不發送 webhook
3. **假設** 使用者在後續訊息中提供缺少的資訊如「咖啡」，**當** GPT 收到完整資訊，**則** 系統建立包含所有必填欄位的項目並觸發 webhook
4. **假設** 使用者發送包含不明確日期參考的項目如「昨天買的午餐150元現金」，**當** GPT 處理，**則** 系統正確解讀日期並包含在格式化項目中
5. **假設** 使用者在補充過程中切換話題（如「今天天氣如何？」），**當** 系統識別為非補充資訊，**則** 回答天氣問題，並保留記帳脈絡等待使用者繼續補充

**v2 完整版能力**：
- 儲存對話脈絡以支援多輪對話
- 智慧識別使用者回覆是補充資訊還是新話題
- 在要求補齊所有必填欄位後才建立項目並發送 webhook

---

#### v3 未來版驗收場景（先建立後補充）

**實驗目標**：驗證「先記錄後補充」的使用者體驗是否優於「補齊後記錄」。

1. **假設** 使用者發送「買了咖啡」，**當** 系統處理，**則** 立即建立項目（品項=咖啡，金額=0，付款方式=空）並發送 webhook，同時詢問「請問花了多少錢？用什麼付款方式？」
2. **假設** 使用者回覆「80元，現金」，**當** 系統識別為補充資訊，**則** 發送**更新 webhook**（更新金額和付款方式）並確認「已更新：咖啡 80元 現金」
3. **假設** 使用者回覆「今天天氣如何？」（非補充資訊），**當** 系統識別非補充資訊，**則** 切換為一般對話處理，透過天氣 API 查詢並回覆，同時保留不完整項目等待補充
4. **假設** 使用者長時間未補充不完整項目，**當** 超過設定時限（例如24小時），**則** 系統發送提醒訊息詢問是否需要補充或刪除該項目

**v3 未來版挑戰**：
- 需要下游記帳系統支援項目更新（UPDATE webhook）
- 不完整項目可能影響財務報表準確性
- 需要驗證使用者是否偏好此流程

---

### 邊緣案例

#### v1 MVP 邊緣案例

- **當使用者發送非常長或複雜的訊息時**，系統將正常處理，但若超過 GPT token 限制則先截斷訊息（取前 N 個 token）再處理
- **當 GPT 服務不可用時**，使用者立即收到「服務暫時無法使用，請稍後再試」的錯誤訊息（v1 MVP 無持久化重試機制）
- **當 webhook 端點回傳錯誤或無法連線時**，使用者收到「記帳失敗，請稍後再試」的錯誤訊息（v1 MVP 無重試佇列）
- **當 GPT 將非記帳訊息誤分類為記帳項目時**，使用者可以在確認訊息中回覆「取消」或「錯誤」，系統回應「已了解，該項目未記錄」（v1 MVP 不撤銷已發送的 webhook）
- **當使用者發送貼圖或不支援的媒體類型時**，系統回覆「抱歉，目前僅支援文字訊息記帳」

**v1 MVP 簡化處理**：
- 無持久化重試機制（失敗即回報錯誤）
- 無對話脈絡儲存（不處理並發訊息問題）
- 僅支援文字訊息（不處理圖片）

---

#### v1.5.0 邊緣案例

**多筆支出處理**：
- **當使用者在單一訊息中混合記帳項目和一般對話時**（例如「早餐80元，午餐150元，現金，今天天氣不錯」），系統將僅處理識別出的記帳項目，對於一般對話部分透過 GPT 回應
- **當使用者發送多筆項目但缺少付款方式時**（例如「早餐80元，午餐150元」缺少付款方式），系統回覆「請提供付款方式」，且不觸發任何 webhook
- **當使用者發送多筆項目但其中部分缺少金額時**（例如「早餐80元，午餐買了便當，現金」缺少午餐金額），系統回覆「第二個項目缺少金額，請提供完整資訊」，且不觸發任何 webhook
- **當系統無法明確區分單一訊息中的多個項目時**（例如「三明治和咖啡80元現金」），系統回覆「無法確定是一個項目還是多個項目（三明治、咖啡），請分別描述金額」
- **當使用者在同一訊息中混合不同付款方式時**（例如「早餐80元現金，午餐150元刷卡」），系統判斷為兩次獨立支出行為，回覆「偵測到不同付款方式，請分開記帳」

**圖片/收據處理**：
- **當使用者發送的圖片不是收據時**（例如風景照、人物照），系統回覆「抱歉，無法從圖片中識別收據資訊，請提供文字描述」
- **當收據圖片模糊或資訊不完整時**，系統回覆「收據圖片不清晰，請提供文字描述：品項、金額、付款方式」
- **當收據包含非台幣幣別時**（例如日幣、美金收據），系統回覆「v1.5.0 僅支援台幣，請提供文字描述並手動換算台幣金額」
- **當使用者同時發送圖片和文字訊息時**，系統優先處理圖片中的收據資訊，若圖片無法識別則使用文字訊息內容

**v1.5.0 限制**：
- 維持無狀態架構（與 v1 MVP 相同）
- 不支援多輪對話補充不完整資訊
- 圖片識別失敗時不儲存上下文
- 仍使用時間戳記格式交易ID

---

#### v2 完整版邊緣案例

**錯誤處理和重試**：
- **當 LINE webhook 傳送失敗或逾時時**，訊息將加入重試佇列並以指數退避策略自動重試（2s, 4s, 8s, 16s...），使用者會收到「暫時無法處理，系統會自動重試」的通知，處理完成後收到確認
- **當 GPT 服務不可用時**，訊息將加入佇列並自動重試，使用者立即收到「服務暫時無法使用，稍後會自動處理」的通知
- **當 webhook 端點回傳錯誤或無法連線時**，訊息將加入重試佇列並自動重試，使用者收到「記帳暫時失敗，系統會自動重試」的通知
- **當即時資訊 API（天氣、新聞等）回傳錯誤或逾時時**，系統回覆適當的錯誤訊息，例如「抱歉，目前無法取得天氣資訊，請稍後再試」

**多筆支出和外幣**：
- **當單一訊息包含多筆支出時**（例如「早餐花了80元，午餐花了150元」），系統將為所有項目使用相同的交易ID，但為每個項目發送個別的 webhook
- **當系統處理不同幣別時**（例如 USD、JPY），透過匯率 API 即時取得匯率；當匯率 API 不可用時使用快取匯率；若快取也不存在則通知使用者「無法處理該幣別，請稍後再試」

**對話脈絡管理**：
- **當使用者發送非常長或複雜的訊息時**，系統將正常處理，但若超過 GPT token 限制則先摘要訊息再處理
- **當系統處理同一使用者的並發訊息時**，依照接收順序處理，維持對話脈絡的時序性；若訊息在短時間內大量湧入，後續訊息將排隊等待處理
- **當對話脈絡超過長度限制時**（例如超過 100 則訊息或 GPT token 限制的 80%），系統自動摘要或截斷最舊的訊息，確保系統能持續運作
- **當每週日晚上 8 點發送清除脈絡詢問訊息時**，若使用者 24 小時內未回應，則視為選擇「保留」，繼續維護現有脈絡
- **當使用者在非週日主動要求清除對話脈絡時**（例如發送「清除歷史」），系統應立即執行清除並確認

**圖片和媒體**：
- **當使用者發送圖片時**，系統使用 GPT Vision API 辨識是否為收據並提取記帳資訊，若清晰則建立交易，若模糊則詢問澄清；貼圖或其他非文字媒體則以一般對話回應

**誤分類處理**：
- **當 GPT 將非記帳訊息誤分類為記帳項目時**，使用者可以在確認訊息中回覆「取消」或「錯誤」來撤銷該項目；系統應發送刪除 webhook（若下游支援）或記錄撤銷請求，並記錄此類錯誤以改進分類模型

## 需求 *(必填)*

### 功能需求

功能需求依版本分組，標註 **[v1 MVP]**、**[v1.5]**、**[v2]**、**[v3]**。

---

#### v1 MVP 功能需求（Serverless 最簡版）

**核心流程**：
- **FR-001** [v1 MVP]：系統必須接收並處理來自 LINE 訊息平台 webhook 的傳入訊息
- **FR-002** [v1 MVP]：系統必須將接收到的訊息轉發給 GPT 進行自然語言處理和意圖分類
- **FR-003** [v1 MVP]：系統必須根據 GPT 分析識別訊息內容是記帳項目還是一般對話
- **FR-004** [v1 MVP]：系統必須從自然語言中提取結構化記帳資料，包括：金額、分類、描述、交易類型（支出/收入）和日期時間

**資料轉換（v1 MVP 簡化版）**：
- **FR-005-MVP** [v1 MVP]：系統必須將提取的記帳資料轉換為 JSON 格式，包含以下欄位（**v1 MVP 限制**：固定台幣 TWD，匯率固定 1.0，交易ID 使用時間戳記）：
  - **使用者必填欄位**：品項、原幣金額、付款方式（缺少則回覆錯誤訊息要求重新輸入）
  - **系統推斷欄位**：日期（訊息時間）、原幣別（固定 TWD）、匯率（固定 1.0）、分類、明細說明、收款／支付對象
  - **系統預設欄位**：交易ID（時間戳記格式如 `20251112-143052`）、專案、必要性、代墊狀態、附註

**Webhook 和回應**：
- **FR-006** [v1 MVP]：系統必須在偵測到記帳項目時將結構化記帳資料發送到已設定的 webhook 端點
- **FR-007** [v1 MVP]：系統必須生成包含所有項目細節（金額、分類、描述、日期、類型）的格式化記帳項目回應
- **FR-008** [v1 MVP]：系統必須透過 LINE 訊息平台將格式化回應發送回使用者
- **FR-009** [v1 MVP]：系統必須透過 GPT 提供對話式回應來處理非記帳訊息，而不觸發 webhook

**資料驗證和處理**：
- **FR-010-MVP** [v1 MVP]：系統必須在建立項目前驗證所需記帳欄位（品項、金額、付款方式）是否存在，**缺少則回覆錯誤訊息**，不支援多輪對話補充
- **FR-012** [v1 MVP]：系統必須支援支出和收入兩種交易類型
- **FR-014-MVP** [v1 MVP]：系統必須記錄所有訊息處理活動以用於故障排除（簡化版日誌，輸出到 stdout）
- **FR-016** [v1 MVP]：系統必須從使用者訊息中提取或推斷付款方式
- **FR-017** [v1 MVP]：系統必須根據自然語言描述將項目分類到適當的類別
- **FR-019** [v1 MVP]：系統必須使用可設定的預設值指派專案和必要性欄位
- **FR-020** [v1 MVP]：系統必須填入所有必填的 webhook 欄位，對無法從使用者訊息提取的欄位使用空字串或預設值

**v1 MVP 明確排除**：
- ❌ 不支援多輪對話（不儲存對話脈絡）
- ❌ 不支援外幣和匯率 API
- ❌ 不支援單一訊息多筆支出
- ❌ 不支援圖片/收據識別
- ❌ 不支援即時資訊查詢 API
- ❌ 無持久化重試佇列（失敗即回報錯誤）

---

#### v1.5.0 功能需求（多筆支出與視覺識別版）

**在 v1 MVP 基礎上新增**（維持無狀態架構）：

**多筆支出處理**：
- **FR-021-v1.5** [v1.5]：系統必須支援單一訊息中的多筆支出，為所有項目使用相同的交易ID（時間戳記格式），但為每個項目發送個別的 webhook
- **FR-033** [v1.5]：系統必須能在單一訊息中正確識別和分離多筆記帳項目（透過逗號、分號、頓號或換行符號分隔）
- **FR-034** [v1.5]：系統必須驗證多筆支出中每一筆都包含完整資訊（品項、金額、付款方式），若任一筆不完整則回覆錯誤訊息且不觸發任何 webhook

**圖片/收據識別**：
- **FR-022-v1.5** [v1.5]：系統必須使用 GPT Vision API 處理圖片訊息，辨識是否為收據並提取記帳資訊（金額、品項、日期等），若資訊清晰則建立交易，若模糊或無法辨識則回覆錯誤訊息
- **FR-035** [v1.5]：系統必須處理收據圖片中的多筆支出項目，為所有項目使用相同的交易ID，並發送多個獨立的 webhook
- **FR-036** [v1.5]：系統必須在收據圖片包含非台幣幣別時回覆錯誤訊息，要求使用者提供文字描述並手動換算台幣金額
- **FR-037** [v1.5]：系統必須在圖片識別失敗時提供清楚的錯誤訊息，引導使用者改用文字描述

**LINE 訊息類型支援**：
- **FR-038** [v1.5]：系統必須支援處理 LINE 的文字訊息和圖片訊息類型
- **FR-039** [v1.5]：系統必須在收到圖片訊息時下載圖片內容並傳送給 GPT Vision API 進行分析
- **FR-040** [v1.5]：系統必須在使用者同時發送圖片和文字時，優先處理圖片內容，若圖片無法識別則使用文字內容

**v1.5.0 維持 v1 MVP 的限制**：
- ✅ 維持無狀態架構（不儲存對話歷史）
- ✅ 每次請求獨立處理
- ✅ 僅支援台幣（TWD）
- ✅ 簡化的交易ID（時間戳記格式）
- ❌ 不支援多輪對話補充不完整資訊
- ❌ 不支援外幣和匯率 API
- ❌ 不支援即時資訊查詢 API
- ❌ 無持久化重試佇列

---

#### v2 完整版功能需求

**v2 完整版增強原有需求**：
- **FR-005-Full** [v2]：完整版資料轉換，支援所有幣別、複雜交易ID（YYYYMMDD-NNN 格式）
- **FR-010-Full** [v2]：支援多輪對話補充不完整項目（需對話脈絡管理）
- **FR-014-Full** [v2]：完整日誌系統（結構化日誌、持久化儲存）

**v2 新增功能需求**：

**錯誤處理和重試**：
- **FR-011** [v2]：系統必須妥善處理 webhook 傳送失敗，將訊息加入持久化重試佇列並使用指數退避策略自動重試，當 GPT 或 webhook 不可用時通知使用者暫時無法使用，處理完成後發送確認訊息

**對話脈絡管理**：
- **FR-013** [v2]：系統必須為每個使用者維護獨立的對話脈絡（conversation context），用於多輪互動、上下文理解和記帳項目補充
- **FR-026** [v2]：系統必須儲存對話脈絡以支援多輪互動（例如詢問缺少資訊時）
- **FR-027** [v2]：系統必須在每週日的指定時間（例如晚上 8 點）主動發送訊息，詢問使用者是否需要清除歷史對話脈絡
- **FR-028** [v2]：系統必須在使用者確認後清除對話脈絡，或在使用者選擇保留時繼續維護現有脈絡
- **FR-029** [v2]：系統必須在對話脈絡過長時（例如超過 100 則訊息或 GPT token 限制的 80%）自動摘要或截斷最舊的訊息，確保系統能持續運作

**複雜交易ID和外幣**：
- **FR-015** [v2]：系統必須為每個記帳項目生成 YYYYMMDD-NNN 格式的唯一交易ID，其中 NNN 為每日計數器，於台灣時區午夜重置（需持久化儲存）
- **FR-018** [v2]：系統必須支援幣別資訊，包括原幣別、金額和匯率；非 TWD 幣別必須透過免費公開匯率 API（例如 exchangerate-api.io）即時取得匯率，若 API 不可用則使用快取匯率

**即時資訊查詢**：
- **FR-023** [v2]：系統必須識別使用者訊息中的即時資訊查詢意圖（天氣、新聞、匯率、股價等）
- **FR-024** [v2]：系統必須整合外部 API 服務以取得即時資訊，包括但不限於：天氣 API、匯率 API、新聞 API
- **FR-025** [v2]：系統必須在外部即時資訊 API 不可用時，提供適當的錯誤訊息或使用快取資料作為替代回應

---

#### v3 未來版功能需求

- **FR-030** [v3]：系統必須支援建立不完整的記帳項目並立即發送 webhook（品項必填，金額和付款方式可為空或預設值）
- **FR-031** [v3]：系統必須在使用者補充不完整項目時發送更新 webhook（UPDATE 操作）
- **FR-032** [v3]：系統必須智慧識別使用者回覆是補充資訊還是新話題，並相應切換處理邏輯

### 關鍵實體

- **記帳項目**：代表從使用者訊息中提取的完整財務交易，包含以下欄位（共 14 個欄位）：
  - **使用者必填**：品項、原幣金額、付款方式
  - **系統推斷**：日期、原幣別、匯率、分類、明細說明、收款／支付對象
  - **系統預設**：交易ID、專案、必要性、代墊狀態、附註
  - **版本差異**：
    - **v1 MVP**：原幣別固定 TWD，匯率固定 1.0，交易ID 使用時間戳記格式，僅支援單筆支出
    - **v1.5.0**：原幣別固定 TWD，匯率固定 1.0，交易ID 使用時間戳記格式，支援單一訊息多筆支出（共用交易ID）
    - **v2 完整版**：支援多種幣別，匯率透過 API 取得，交易ID 使用 YYYYMMDD-NNN 格式

- **LINE 訊息**：來自使用者的傳入訊息，包含訊息文字、使用者識別碼、時間戳記和訊息類型
  - **版本差異**：
    - **v1 MVP**：僅支援文字訊息
    - **v1.5.0**：支援文字和圖片訊息（使用 GPT Vision API 識別收據）
    - **v2 完整版**：支援文字和圖片（收據識別），並整合對話脈絡管理

- **Webhook 負載**：發送到外部記帳系統的結構化 JSON 資料包，包含所有 14 個欄位（使用中文欄位名稱）。詳見下方「Webhook JSON Schema 範例」。

- **GPT 對話脈絡** [v2]：為每個使用者維護的訊息歷史記錄，用於意圖分類、自然語言理解、從對話輸入中提取結構化資料，以及多輪互動（例如補充不完整項目）。脈絡會在超過長度限制時自動摘要或截斷，並可由使用者選擇每週清除。
  - **v1 MVP**：不儲存對話脈絡，每次請求獨立處理
  - **v2 完整版**：持久化儲存對話脈絡，支援多輪對話

## 成功標準 *(必填)*

### v1 MVP 成功標準

- **SC-001** [v1 MVP]：使用者能透過發送**資訊完整**的自然語言訊息（包含品項、金額、付款方式）成功記錄記帳項目，並在 5 秒內收到確認
- **SC-002** [v1 MVP]：系統正確識別和分類至少 90% 的記帳相關訊息與非記帳訊息（v1 MVP 基準線）
- **SC-003** [v1 MVP]：系統在 webhook 端點正常時能成功傳送記帳資料（v1 MVP 無重試機制，失敗即回報錯誤）
- **SC-004** [v1 MVP]：使用者能在單一訊息中完成台幣記帳項目記錄（包含品項、金額、付款方式）
- **SC-006** [v1 MVP]：格式化回應訊息 100% 包含所有必要的記帳資訊，以使用者可讀格式呈現
- **SC-007** [v1 MVP]：系統在正常情況下於 3 秒內回應使用者訊息（記帳或對話）

---

### v1.5.0 成功標準

- **SC-001-v1.5** [v1.5]：使用者能透過發送**資訊完整**的自然語言訊息成功記錄單筆或多筆記帳項目，並在 5 秒內收到確認（維持 v1 MVP 的資訊完整要求）
- **SC-004-v1.5** [v1.5]：使用者能在單一訊息中完成多筆台幣記帳項目記錄，系統為所有項目使用相同的交易ID，並發送多個獨立的 webhook
- **SC-008-v1.5** [v1.5]：圖片收據識別準確率達到 80% 以上（資訊清晰的台幣收據）
- **SC-010** [v1.5]：系統在收據圖片模糊或無法識別時，能提供清楚的錯誤訊息引導使用者改用文字描述
- **SC-011** [v1.5]：系統在圖片識別和文字處理的回應時間維持在 5 秒內（包含 GPT Vision API 呼叫）
- **SC-012** [v1.5]：使用者發送包含多筆支出的收據圖片時，系統能正確識別並為每一筆發送獨立的 webhook

**v1.5.0 維持 v1 MVP 的限制**：
- 維持無狀態架構（不儲存對話歷史）
- 僅支援台幣（TWD）
- 不支援多輪對話補充不完整資訊
- 無持久化重試機制

---

### v2 完整版成功標準

- **SC-001-Full** [v2]：使用者能透過發送自然語言訊息（包含完整或不完整資訊）成功記錄記帳項目，並在 5 秒內收到確認（支援多輪補充）
- **SC-002-Full** [v2]：系統正確識別和分類至少 95% 的記帳相關訊息與非記帳訊息（v2 改進目標）
- **SC-003-Full** [v2]：系統以 99% 的可靠性成功將記帳資料傳送到 webhook 端點（含自動重試機制）
- **SC-004-Full** [v2]：使用者能在單一訊息中完成多種幣別、多筆支出的記帳項目記錄
- **SC-005** [v2]：系統處理至少 100 個並發使用者對話而回應時間不會降級（需對話脈絡管理）
- **SC-008-Full** [v2]：圖片收據識別準確率達到 85% 以上（資訊清晰的收據，支援多種幣別）
- **SC-009** [v2]：即時資訊查詢（天氣、匯率等）回應時間在 5 秒內

## Webhook JSON Schema 範例

### 完整欄位說明

發送到外部記帳系統的 webhook JSON 包含以下 14 個欄位（使用中文欄位名稱）：

```json
{
  "日期": "2025-11-11",
  "品項": "早餐 - 三明治",
  "原幣別": "TWD",
  "原幣金額": 80.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-001",
  "明細說明": "早餐花了80元買三明治",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

### 欄位詳細定義

| 欄位名稱 | 資料類型 | 來源類型 | 說明 | 範例值 |
|---------|---------|---------|------|-------|
| 日期 | String (YYYY-MM-DD) | 系統推斷 | 交易日期，預設為訊息時間；若訊息包含相對時間（如「昨天」）則推斷實際日期 | "2025-11-11" |
| 品項 | String | 使用者必填 | 消費或收入的項目名稱，從訊息中提取 | "早餐 - 三明治" |
| 原幣別 | String | 系統推斷 | 原始交易幣別，預設 "TWD"；若訊息提及其他幣別則推斷（如 "USD", "JPY"） | "TWD" |
| 原幣金額 | Number | 使用者必填 | 原始交易金額，從訊息中提取 | 80.00 |
| 匯率 | Number | 系統推斷 | 即時匯率，TWD 為 1.0；其他幣別透過匯率 API 取得 | 1.0 |
| 付款方式 | String | 使用者必填 | 付款方式，從訊息中提取（如「現金」、「信用卡」、「Line Pay」） | "現金" |
| 交易ID | String (YYYYMMDD-NNN) | 系統預設 | 系統自動生成的唯一交易識別碼，NNN 為每日計數器（台灣時區） | "20251111-001" |
| 明細說明 | String | 系統推斷 | 從訊息內容提取的完整描述 | "早餐花了80元買三明治" |
| 分類 | String | 系統推斷 | 從品項推斷的消費分類（如「餐飲」、「交通」、「娛樂」） | "餐飲" |
| 專案 | String | 系統預設 | 使用預設值（如「個人」）；或從訊息推斷（如「工作」、「旅遊」） | "個人" |
| 必要性 | String | 系統預設 | 使用預設值（如「必要」）；或從訊息推斷（如「非必要」） | "必要" |
| 代墊狀態 | String | 系統預設 | 預設「否」；若訊息包含「代墊」、「先付」等關鍵字則為「是」 | "否" |
| 收款／支付對象 | String | 系統推斷 | 從訊息提取對象資訊（如「付給小明」）；若無則為空字串 | "" |
| 附註 | String | 系統預設 | 從訊息中提取的額外備註資訊；若無則為空字串 | "" |

### 範例場景

#### 範例 1：基本支出（台幣）
**使用者訊息**：「午餐花了150元刷卡」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "午餐",
  "原幣別": "TWD",
  "原幣金額": 150.00,
  "匯率": 1.0,
  "付款方式": "信用卡",
  "交易ID": "20251111-002",
  "明細說明": "午餐花了150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

#### 範例 2：外幣交易
**使用者訊息**：「昨天在日本買了拉麵1200日圓付現金」
**假設匯率**：1 JPY = 0.21 TWD

**Webhook JSON**：
```json
{
  "日期": "2025-11-10",
  "品項": "拉麵",
  "原幣別": "JPY",
  "原幣金額": 1200.00,
  "匯率": 0.21,
  "付款方式": "現金",
  "交易ID": "20251110-015",
  "明細說明": "昨天在日本買了拉麵1200日圓付現金",
  "分類": "餐飲",
  "專案": "旅遊",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

#### 範例 3：代墊款項
**使用者訊息**：「幫同事代墊計程車費300元現金」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "計程車",
  "原幣別": "TWD",
  "原幣金額": 300.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-003",
  "明細說明": "幫同事代墊計程車費300元現金",
  "分類": "交通",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "是",
  "收款／支付對象": "同事",
  "附註": ""
}
```

#### 範例 4：收入項目
**使用者訊息**：「收到薪水50000元轉帳」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "薪水",
  "原幣別": "TWD",
  "原幣金額": 50000.00,
  "匯率": 1.0,
  "付款方式": "轉帳",
  "交易ID": "20251111-004",
  "明細說明": "收到薪水50000元轉帳",
  "分類": "收入",
  "專案": "工作",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "公司",
  "附註": ""
}
```

#### 範例 5：單一訊息多筆支出
**使用者訊息**：「早餐80元現金，午餐150元刷卡」

**Webhook JSON 1**（同一交易ID）：
```json
{
  "日期": "2025-11-11",
  "品項": "早餐",
  "原幣別": "TWD",
  "原幣金額": 80.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-005",
  "明細說明": "早餐80元現金，午餐150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": "與交易ID 20251111-005 的其他項目為同一訊息"
}
```

**Webhook JSON 2**（同一交易ID）：
```json
{
  "日期": "2025-11-11",
  "品項": "午餐",
  "原幣別": "TWD",
  "原幣金額": 150.00,
  "匯率": 1.0,
  "付款方式": "信用卡",
  "交易ID": "20251111-005",
  "明細說明": "早餐80元現金，午餐150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": "與交易ID 20251111-005 的其他項目為同一訊息"
}
```

---

## 欄位標準值定義

本章節定義各欄位的標準值，供 GPT 進行分類推斷時參考。

### 分類（Category）

分類採用「大分類／子分類」的階層結構，用於歸納消費性質。

#### 家庭類（Family）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `家庭／食材` | 日常家庭料理、生鮮、預購水果等 | 豬肉、蔬菜、米 |
| `家庭／食材／釀造` | 用於自製果露、釀酒或保存類加工品 | 釀酒材料、果露材料 |
| `家庭／水果` | 單獨購買或預購的水果品項（具季節性或療癒性） | 玉荷包、芒果、文旦 |
| `家庭／餐飲／早餐` | 外出用餐或購買早餐即食品項 | 三明治、蛋餅、豆漿 |
| `家庭／餐飲／午餐` | 外出用餐或購買午餐即食品項 | 便當、麵食 |
| `家庭／餐飲／晚餐` | 外出用餐或購買晚餐即食品項 | 火鍋、自助餐 |
| `家庭／點心` | 家庭／個人平時的零食購買（含療癒性） | 餅乾、糖果、蛋糕 |
| `家庭／飲品` | 液態型日常飲料（不屬於正餐） | 現打果汁、冰沙、咖啡、茶飲 |
| `家庭／興趣與運動` | 運動用品、樂器、拼圖、手作工具等 | 羽球、吉他、拼圖 |
| `家庭／用品／雜項` | 廚房用具、保鮮容器、牙線棒等 | 保鮮盒、牙線棒 |
| `家庭／服飾` | 家人共用、兒童衣物、家庭採購服飾等 | 童裝、家居服 |
| `家庭／公用事業` | 水費、電費、瓦斯費、垃圾清潔費等公用事業費用 | 台水水費、台電電費、欣欣天然氣 |
| `家庭／通訊／網路費` | 家中寬頻、光纖、Wi-Fi 等固定上網費用 | 中華電信光世代 |
| `家庭／通訊／子女手機` | 子女使用之門號月租、上網方案 | 台哥大門號 |
| `家庭支出` | 玩具、紅包、雜項未分類類別 | 玩具、紅包 |

#### 個人類（Personal）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `個人／餐飲` | 公司聚餐、單人外食等 | 午餐便當、聚餐 |
| `個人／服飾` | 自己的衣物、鞋子、飾品等 | 上衣、球鞋、項鍊 |
| `個人／通訊` | 個人手機月租、行動上網費 | 遠傳月租 |

#### 行程類（Trip）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `行程／餐飲／早餐` | 行程中的早餐花費 | 早餐店、飯店早餐 |
| `行程／餐飲／午餐` | 行程中的午餐花費 | 便當、小吃 |
| `行程／餐飲／晚餐` | 行程中的晚餐花費 | 餐廳、小吃 |
| `行程／點心` | 登山、戶外活動前後準備的點心補給 | 能量棒、巧克力 |
| `行程／門票` | 入園費、森林遊樂區等具通行性質的門票 | 太魯閣入園費 |
| `行程／協作` | 登山協作人員的服務費 | 協作費用 |
| `行程／裝備／租借` | 睡袋、帳篷等行程租賃支出 | 睡袋租借 |

#### 健康類（Health）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `健康／醫療／本人` | 本人健康檢查、藥品、就醫等 | 感冒藥、健檢 |
| `健康／醫療／家庭成員` | 先生、小孩或其他家人健康相關支出 | 小孩看診、家人藥品 |
| `健康／保險` | 健康相關保險 | 壽險、醫療險 |

#### 教育類（Education）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `教育／子女` | 子女的課後班、教材等 | 補習班、教材 |
| `教育／進修` | 成人自主進修、講座、學習活動 | 山難講座、急救課程 |

#### 禮物類（Gift）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `禮物／家庭` | 給家人或家庭聚會使用的禮物 | 生日禮物 |
| `禮物／外部贈送` | 伴手禮、送朋友、同事禮物等 | 伴手禮、同事禮物 |

#### 交通類（Transportation）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `交通／接駁` | 火車、高鐵、登山接駁車、共乘計程車等 | 高鐵票、接駁車 |
| `交通／加油` | 私人汽車加油費用 | 加油 |
| `交通／保險` | 車輛強制險、車體險、第三責任險等 | 強制險 |

#### 收款類（Income）

| 分類值 | 說明 | 範例品項 |
|-------|------|---------|
| `收款／代墊回收` | 回收的代墊金額 | 代墊回收 |

---

### 付款方式（Payment Method）

| 選項 | 說明 |
|-----|------|
| `現金` | 使用實體現金支付 |
| `Line Pay` | 使用 Line Bank 轉帳支付 |
| `合庫` | 使用合作金庫帳戶進行轉帳 |
| `台新狗卡` | 台新銀行的 GoGo 聯名信用卡 |
| `台新 Richart` | 台新銀行 Richart 數位帳戶 |
| `FlyGo 信用卡` | 台新 FlyGo 信用卡 |
| `大戶信用卡` | 遠銀大戶數位帳戶所附之信用卡 |
| `聯邦綠卡` | 聯邦銀行綠生活卡 |
| `富邦 Costco` | 富邦 Costco 聯名卡 |
| `星展永續卡` | 星展銀行永續循環信用卡 |
| `NA` 或 `N/A` | 尚未指定或不適用的付款方式 |

**v1 MVP 簡化處理**：
- GPT 應識別訊息中的付款方式關鍵字（如「現金」、「刷卡」、「轉帳」）
- 對於信用卡，若使用者僅說「刷卡」且未指定卡別，使用預設值或 `NA`
- 對於轉帳，若使用者僅說「轉帳」且未指定銀行，使用預設值或 `NA`

**v2 完整版增強**：
- 支援對話脈絡記憶使用者慣用的付款方式
- 根據歷史記錄推測最可能的付款方式

---

### 專案（Project）

| 選項 | 說明 |
|-----|------|
| `日常` | 日常生活中常規支出，不屬於特定活動或年度性項目 |
| `家庭年度支出` | 如報稅、保險等家庭整體的年度性固定或特殊支出 |
| `子女年度支出` | 子女相關的年度費用，如補習、課程、健康費用等 |
| `紀念日／送禮` | 特定節日、生日或送禮用途 |
| `健康檢查` | 本人或家人健康檢查專案用途 |
| `登山行程` | 非特定登山行程準備之物品、裝備或課程 |
| `折扣／優惠` | 為特定折扣或促銷優惠而額外進行的採購支出 |

**特定活動專案格式**：`YYYYMMDD-DD 活動名稱`
- 範例：`20250518-19 玉山南稜行`

**v1 MVP 預設值**：
- 若訊息中未提及特定專案，使用 `日常` 作為預設值
- 可從分類推斷部分專案（如健康類 → 健康檢查、行程類 → 登山行程）

---

### 必要性（Necessity）

| 選項 | 說明 | 範例情境 |
|-----|------|---------|
| `必要日常支出` | 日常基本開銷 | 三餐、衛生用品、醫療 |
| `想吃想買但合理` | 非必需但仍屬合理 | 生日慶祝、合理點心、家人想吃 |
| `療癒性支出` | 為提升情緒、滿足自我療癒而購買 | 甜點、點心、舒壓用品 |
| `衝動購物（提醒）` | 明顯非必要或不預期消費 | 未計劃的購物 |

**v1 MVP 預設值**：
- 若訊息中未提及必要性，使用 `必要日常支出` 作為預設值
- 可從品項關鍵字推斷（如「點心」、「甜點」→ `療癒性支出`）

---

### 代墊狀態（Advance Payment Status）

| 選項 | 說明 |
|-----|------|
| `無` | 本人支出，無代墊或待收待付情況 |
| `不索取` | 本人代墊他人費用，但不會索取回款（如對家人支援） |
| `代墊` | 本人代為支付，需日後由對方付款給我 |
| `需支付` | 他人代墊，本人需支付給對方 |
| `已支付` | 本人已完成付款予對方（處理完成的需支付項目） |
| `已收款` | 已經收到對方的還款（處理完成的代墊項目） |

**關鍵字識別**：
- 「代墊」、「先付」、「幫付」→ `代墊`
- 「幫」+「對象」→ `代墊` 或 `不索取`（視對象是否為家人）
- 若無相關關鍵字，預設為 `無`

**v1 MVP 限制**：
- 僅識別基本代墊關鍵字
- 不支援代墊狀態變更（如 `代墊` → `已收款`）

**v2 完整版增強**：
- 支援代墊狀態追蹤和更新
- 主動提醒未收回的代墊款項

---

## 使用者回覆格式

當系統成功處理記帳項目後，應回覆使用者包含以下資訊的確認訊息：

### v1 MVP 回覆格式

```
✅ 記帳成功

📅 日期：2025-11-12
🏷️ 品項：午餐 - 便當
💰 金額：150 元（台幣）
💳 付款：現金
📂 分類：家庭／餐飲／午餐
📋 專案：日常
⭐ 必要性：必要日常支出
🔖 交易ID：20251112-143052
```

**說明**：
- 「金額（台幣）」欄位計算自「原幣金額 × 匯率」
- **v1 MVP**：固定為台幣，直接顯示原幣金額即可
- **v2 完整版**：支援外幣時，需計算並顯示台幣金額

**簡化版本**（若訊息過長）：
```
✅ 已記錄：午餐便當 150元（現金）
分類：家庭／餐飲／午餐 | 日常
交易ID：20251112-143052
```

---

## v2 完整版專屬功能（延後實作）

以下功能在 v1 MVP 中明確排除，留待 v2 完整版實作：

### 固定週期帳目提醒

- 根據 `periodic_expenses.json` 設定的固定週期帳目
- 在到期日前 2 天自動提醒使用者
- 提醒範例：
  ```
  🔔 固定週期帳目提醒
  
  📅 11月3日（週五）到期：
  - 家用網路費：1,171元（合庫）
  ```

### 信用卡週期管理

- 根據 `periodic_expenses.json` 設定的信用卡週期
- 提醒結帳日和繳款日
- 提醒範例：
  ```
  💳 信用卡提醒
  
  聯邦綠卡：
  - 結帳日：11月9日
  - 繳款日：11月24日
  ```

### 週期性觸發規則

- 根據 `trigger_rules.json` 設定
- 在每週起始日（週日）觸發提醒
- 提前提醒天數：2天

**實作時機**：v2 完整版需要對話脈絡管理和定時任務支援
