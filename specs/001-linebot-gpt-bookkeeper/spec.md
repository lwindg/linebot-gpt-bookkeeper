# 功能規格書：LINE Bot GPT 記帳中介系統

**功能分支**：`001-linebot-gpt-bookkeeper`
**建立日期**：2025-11-11
**狀態**：草稿
**輸入**：使用者描述：「建立一個 linebot 中介，接收 linebot 訊息後轉給 gpt 處理，若為記帳項目則轉為所需要的格式發送 webhook，並回覆記帳的完整格式」

## Clarifications

### Session 2025-11-11

- Q: When generating the transaction ID (交易ID) in format "YYYYMMDD-NNN", how should the sequence number (NNN) be managed? → A: Daily counter per date that resets at midnight Taiwan time
- Q: When handling non-TWD currencies, where should the system retrieve real-time exchange rates from? → A: Free public exchange rate API with cached fallback
- Q: When GPT or the webhook endpoint is unavailable, how should the system handle incoming messages? → A: Queue messages and retry automatically with exponential backoff, notify users when processed
- Q: When a user sends a single message with multiple expenses (e.g., "早餐80元，午餐150元"), how should the system create transaction records? → A: Same transaction ID for all items in the message, multiple webhooks
- Q: When users send images (potentially receipts), how should the system process them? → A: Use GPT Vision API to extract receipt details and create transaction if clear, ask for clarification if ambiguous

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 透過 LINE 發送記帳項目（優先級：P1）

使用者透過 LINE 發送自然語言訊息描述其支出或收入，系統智慧辨識為記帳項目，進行處理，記錄到記帳系統中，並回覆格式化的確認摘要。

**為何此優先級**：這是核心功能 - 讓使用者透過自然對話記錄支出/收入。沒有這個功能，系統就沒有價值。

**獨立測試**：可以透過發送 LINE 訊息如「午餐花了150元」來完整測試，驗證：(1) GPT 正確識別為記帳項目，(2) 觸發 webhook 並傳送結構化資料，(3) 使用者收到包含完整格式化細節的確認訊息。

**驗收場景**：

1. **假設** 使用者已將 LINE bot 加為好友，**當** 使用者發送「早餐花了80元買三明治」，**則** 系統回覆格式化項目，顯示金額、分類、描述和時間戳記
2. **假設** 使用者發送支出訊息，**當** GPT 處理並識別為記帳項目，**則** 觸發 webhook 並傳送包含金額、分類、描述和日期的結構化 JSON
3. **假設** webhook 成功接收記帳資料，**當** 處理完成，**則** 使用者在 LINE 收到包含完整格式化項目細節的確認訊息
4. **假設** 使用者發送收入訊息如「收到薪水50000元」，**當** 系統處理，**則** 項目正確分類為收入並相應觸發 webhook

---

### 使用者故事 2 - 處理非記帳對話與即時資訊查詢（優先級：P2）

使用者發送與記帳無關的訊息，系統識別並適當回應：
- **即時資訊查詢**（天氣、新聞、匯率、股價等）：透過網路 API 查詢並回覆最新資訊
- **一般對話**（問候、問題、閒聊）：透過 GPT 適當回應
- 兩者皆不觸發記帳 webhook

**為何此優先級**：對自然使用者體驗至關重要 - 使用者應該能詢問記帳相關問題、即時資訊或進行一般對話，而不會觸發錯誤的記帳項目。

**獨立測試**：可以透過發送非記帳訊息如「今天台北天氣如何？」或「美金匯率多少？」來完整測試，驗證系統透過外部 API 查詢即時資訊並回應，或以對話方式回應而不觸發 webhook。

**驗收場景**：

1. **假設** 使用者發送問候如「你好」，**當** GPT 處理訊息，**則** 系統以友善問候回應且不觸發 webhook
2. **假設** 使用者詢問記帳相關問題如「我可以記帳什麼？」，**當** GPT 處理訊息，**則** 系統提供有用資訊但不建立項目
3. **假設** 使用者詢問即時資訊如「今天台北天氣如何？」，**當** 系統識別為天氣查詢，**則** 透過天氣 API 取得即時資料並回覆，不觸發 webhook
4. **假設** 使用者詢問「美金匯率多少？」，**當** 系統識別為匯率查詢，**則** 透過匯率 API 查詢並回覆當前匯率，不觸發 webhook
5. **假設** 使用者發送模糊訊息，**當** GPT 無法判斷是否與記帳相關，**則** 系統向使用者詢問澄清問題
6. **假設** 使用者發送閒聊對話，**當** GPT 處理，**則** 系統維持對話脈絡並自然回應，不觸發 webhook
7. **假設** 外部 API（天氣、新聞等）不可用，**當** 使用者查詢即時資訊，**則** 系統回覆適當的錯誤訊息或替代回應

---

### 使用者故事 3 - 處理不完整的記帳項目（優先級：P3）

使用者嘗試記錄記帳項目但提供的資訊不完整（例如缺少必填欄位：品項、原幣金額、付款方式），系統識別缺少的資訊並提示使用者提供，然後才建立項目並發送 webhook。

**版本說明**：
- **v1（當前版本）**：系統在建立項目前驗證必要欄位，缺少時要求使用者補充，收到完整資訊後才建立項目並發送 webhook。
- **v2（未來版本）**：系統允許記錄不完整的項目，立即發送 webhook，並同時詢問缺少的部分。使用者補充後，發送更新 webhook。若使用者回覆不是補充資訊，則回到一般對話邏輯處理。

**為何此優先級**：透過確保所有記帳項目完整準確來提升資料品質和使用者體驗，但系統初期可以在沒有此改進的情況下運作。

**獨立測試**：可以透過發送不完整訊息如「買了午餐」（沒有金額和付款方式）來完整測試，驗證系統在建立項目前要求提供缺少的資訊。

**驗收場景（v1 - 當前版本）**：

1. **假設** 使用者發送「買了咖啡」（缺少金額和付款方式），**當** GPT 處理訊息，**則** 系統詢問「請問花了多少錢？用什麼付款方式？」
2. **假設** 使用者只發送「花了200元現金」（缺少品項），**當** GPT 處理訊息，**則** 系統詢問「請問買了什麼？」
3. **假設** 使用者在後續訊息中提供缺少的資訊如「咖啡」，**當** GPT 收到完整資訊，**則** 系統建立包含所有必填欄位的項目並觸發 webhook
4. **假設** 使用者發送包含不明確日期參考的項目如「昨天買的午餐150元現金」，**當** GPT 處理，**則** 系統正確解讀日期並包含在格式化項目中

**驗收場景（v2 - 未來版本）**：

1. **假設** 使用者發送「買了咖啡」，**當** 系統處理，**則** 立即建立項目（品項=咖啡，金額=0，付款方式=空）並發送 webhook，同時詢問「請問花了多少錢？用什麼付款方式？」
2. **假設** 使用者回覆「80元，現金」，**當** 系統識別為補充資訊，**則** 發送更新 webhook（更新金額和付款方式）並確認「已更新：咖啡 80元 現金」
3. **假設** 使用者回覆「今天天氣如何？」（非補充資訊），**當** 系統識別非補充資訊，**則** 切換為一般對話處理，透過天氣 API 查詢並回覆
4. **假設** 使用者長時間未補充不完整項目，**當** 超過設定時限（例如24小時），**則** 系統發送提醒訊息詢問是否需要補充或刪除該項目

---

### 邊緣案例

- 當 LINE webhook 傳送失敗或逾時時，訊息將加入重試佇列並以指數退避策略自動重試，使用者會收到暫時無法使用的通知，處理完成後收到確認
- 當 GPT 服務不可用時，訊息將加入佇列並自動重試，使用者立即收到服務暫時無法使用的通知
- 當 webhook 端點回傳錯誤或無法連線時，訊息將加入重試佇列並自動重試，使用者收到暫時無法使用的通知
- 當單一訊息包含多筆支出時（例如「早餐花了80元，午餐花了150元」），系統將為所有項目使用相同的交易ID，但為每個項目發送個別的 webhook
- 當使用者發送非常長或複雜的訊息時，系統將正常處理，但若超過 GPT token 限制則先摘要訊息再處理
- 當系統處理不同幣別時（例如 USD、JPY），透過匯率 API 即時取得匯率；當匯率 API 不可用時使用快取匯率；若快取也不存在則通知使用者無法處理該幣別，請稍後再試
- 當 GPT 將非記帳訊息誤分類為記帳項目時，使用者可以在確認訊息中回覆「取消」或「錯誤」來撤銷該項目；系統應記錄此類錯誤以改進分類模型
- 當系統處理同一使用者的並發訊息時，依照接收順序處理，維持對話脈絡的時序性；若訊息在短時間內大量湧入，後續訊息將排隊等待處理
- 當使用者發送圖片時，系統使用 GPT Vision API 辨識是否為收據並提取記帳資訊，若清晰則建立交易，若模糊則詢問澄清；貼圖或其他非文字媒體則以一般對話回應
- 當對話脈絡超過長度限制時（例如超過 100 則訊息或 GPT token 限制的 80%），系統自動摘要或截斷最舊的訊息，確保系統能持續運作
- 當每週日晚上 8 點發送清除脈絡詢問訊息時，若使用者 24 小時內未回應，則視為選擇「保留」，繼續維護現有脈絡
- 當使用者在非週日主動要求清除對話脈絡時（例如發送「清除歷史」），系統應立即執行清除並確認
- 當即時資訊 API（天氣、新聞等）回傳錯誤或逾時時，系統回覆適當的錯誤訊息，例如「抱歉，目前無法取得天氣資訊，請稍後再試」

## 需求 *(必填)*

### 功能需求

- **FR-001**：系統必須接收並處理來自 LINE 訊息平台 webhook 的傳入訊息
- **FR-002**：系統必須將接收到的訊息轉發給 GPT 進行自然語言處理和意圖分類
- **FR-003**：系統必須根據 GPT 分析識別訊息內容是記帳項目還是一般對話
- **FR-004**：系統必須從自然語言中提取結構化記帳資料，包括：金額、分類、描述、交易類型（支出/收入）和日期時間
- **FR-005**：系統必須將提取的記帳資料轉換為 JSON 格式，包含以下欄位：
  - **使用者必填欄位**（從訊息中提取，缺少則詢問使用者）：
    - 品項（必填）
    - 原幣金額（必填）
    - 付款方式（必填）
  - **系統推斷欄位**（由 GPT 從上下文判斷或自動計算）：
    - 日期（預設為訊息時間，YYYY-MM-DD 格式；若訊息包含「昨天」等相對時間則推斷實際日期）
    - 原幣別（預設 TWD；若訊息提及其他幣別如「美金」則推斷為 USD）
    - 匯率（TWD 交易為 1.0；非 TWD 幣別透過匯率 API 即時取得）
    - 分類（從品項描述推斷，例如「咖啡」→「餐飲」、「計程車」→「交通」）
    - 明細說明（從訊息內容提取完整描述）
    - 收款／支付對象（從訊息提取，例如「付給小明」；若無則為空字串）
  - **系統預設欄位**（使用設定的預設值或系統生成）：
    - 交易ID（系統自動生成，格式 YYYYMMDD-NNN）
    - 專案（使用可設定的預設值，例如「個人」；或從訊息推斷，例如「公司聚餐」→「工作」）
    - 必要性（使用可設定的預設值，例如「必要」；或從訊息推斷）
    - 代墊狀態（預設為「否」；若訊息包含「代墊」、「先付」等關鍵字則為「是」）
    - 附註（可為空字串；或從訊息中提取額外備註資訊）
- **FR-006**：系統必須在偵測到記帳項目時將結構化記帳資料發送到已設定的 webhook 端點
- **FR-007**：系統必須生成包含所有項目細節（金額、分類、描述、日期、類型）的格式化記帳項目回應
- **FR-008**：系統必須透過 LINE 訊息平台將格式化回應發送回使用者
- **FR-009**：系統必須透過 GPT 提供對話式回應來處理非記帳訊息，而不觸發 webhook
- **FR-010**：系統必須在建立項目前驗證所需記帳欄位是否存在
- **FR-011**：系統必須妥善處理 webhook 傳送失敗，將訊息加入重試佇列並使用指數退避策略自動重試，當 GPT 或 webhook 不可用時通知使用者暫時無法使用，處理完成後發送確認訊息
- **FR-012**：系統必須支援支出和收入兩種交易類型
- **FR-013**：系統必須保留對話脈絡以進行多輪互動（例如詢問缺少資訊時）
- **FR-014**：系統必須記錄所有訊息處理活動以用於故障排除和稽核
- **FR-015**：系統必須為每個記帳項目生成 YYYYMMDD-NNN 格式的唯一交易ID，其中 NNN 為每日計數器，於台灣時區午夜重置
- **FR-016**：系統必須在使用者訊息中提取或推斷付款方式（如有），否則使用可設定的預設值
- **FR-017**：系統必須根據自然語言描述將項目分類到適當的類別（分類）
- **FR-018**：系統必須支援幣別資訊，包括原幣別、金額和匯率，TWD 交易使用預設值；非 TWD 幣別必須透過免費公開匯率 API（例如 exchangerate-api.io）即時取得匯率，若 API 不可用則使用快取匯率
- **FR-019**：系統必須在訊息中未指定時，使用可設定的預設值指派專案和必要性欄位
- **FR-020**：系統必須填入所有必填的 webhook 欄位，對無法從使用者訊息提取的欄位使用空字串或預設值
- **FR-021**：系統必須支援單一訊息中的多筆支出，為所有項目使用相同的交易ID，但為每個項目發送個別的 webhook
- **FR-022**：系統必須使用 GPT Vision API 處理圖片訊息，辨識是否為收據並提取記帳資訊（金額、品項、日期等），若資訊清晰則建立交易，若模糊或無法辨識則詢問使用者澄清
- **FR-023**：系統必須識別使用者訊息中的即時資訊查詢意圖（天氣、新聞、匯率、股價等）
- **FR-024**：系統必須整合外部 API 服務以取得即時資訊，包括但不限於：天氣 API、匯率 API、新聞 API
- **FR-025**：系統必須在外部即時資訊 API 不可用時，提供適當的錯誤訊息或使用快取資料作為替代回應
- **FR-026**：系統必須為每個使用者維護獨立的對話脈絡（conversation context），用於多輪互動、上下文理解和記帳項目補充
- **FR-027**：系統必須在每週日的指定時間（例如晚上 8 點）主動發送訊息，詢問使用者是否需要清除歷史對話脈絡
- **FR-028**：系統必須在使用者確認後清除對話脈絡，或在使用者選擇保留時繼續維護現有脈絡
- **FR-029**：系統必須在對話脈絡過長時（例如超過 100 則訊息或 GPT token 限制的 80%）自動摘要或截斷最舊的訊息，確保系統能持續運作

### 關鍵實體

- **記帳項目**：代表從使用者訊息中提取的完整財務交易，包含以下欄位：
  - **使用者必填**：品項、原幣金額、付款方式
  - **系統推斷**：日期、原幣別（預設 TWD）、匯率、分類、明細說明、收款／支付對象
  - **系統預設**：交易ID（YYYYMMDD-NNN）、專案、必要性、代墊狀態、附註
  - **重要說明**：金額（台幣）由系統自動計算，不需使用者提供；原幣別預設為 TWD，除非使用者明確提及其他幣別
- **LINE 訊息**：來自使用者的傳入訊息，包含訊息文字、使用者識別碼、時間戳記和訊息類型（文字、圖片、貼圖等）
- **Webhook 負載**：發送到外部記帳系統的結構化 JSON 資料包，包含所有 15 個欄位（使用中文欄位名稱）。詳見下方「Webhook JSON Schema 範例」。
- **GPT 對話脈絡**：為每個使用者維護的訊息歷史記錄，用於意圖分類、自然語言理解、從對話輸入中提取結構化資料，以及多輪互動（例如補充不完整項目）。脈絡會在超過長度限制時自動摘要或截斷，並可由使用者選擇每週清除。

## 成功標準 *(必填)*

### 可衡量的結果

- **SC-001**：使用者能透過發送自然語言訊息成功記錄記帳項目，並在 5 秒內收到確認
- **SC-002**：系統正確識別和分類至少 95% 的記帳相關訊息與非記帳訊息
- **SC-003**：系統以 99% 的可靠性成功將記帳資料傳送到 webhook 端點
- **SC-004**：使用者能在單一訊息中完成標準交易的記帳項目記錄（金額、描述、分類明確）
- **SC-005**：系統處理至少 100 個並發使用者對話而回應時間不會降級
- **SC-006**：格式化回應訊息 100% 包含所有必要的記帳資訊，以使用者可讀格式呈現
- **SC-007**：系統在正常情況下於 3 秒內回應使用者訊息（記帳或對話）

## Webhook JSON Schema 範例

### 完整欄位說明

發送到外部記帳系統的 webhook JSON 包含以下 14 個欄位（使用中文欄位名稱）：

```json
{
  "日期": "2025-11-11",
  "品項": "早餐 - 三明治",
  "原幣別": "TWD",
  "原幣金額": 80.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-001",
  "明細說明": "早餐花了80元買三明治",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

### 欄位詳細定義

| 欄位名稱 | 資料類型 | 來源類型 | 說明 | 範例值 |
|---------|---------|---------|------|-------|
| 日期 | String (YYYY-MM-DD) | 系統推斷 | 交易日期，預設為訊息時間；若訊息包含相對時間（如「昨天」）則推斷實際日期 | "2025-11-11" |
| 品項 | String | 使用者必填 | 消費或收入的項目名稱，從訊息中提取 | "早餐 - 三明治" |
| 原幣別 | String | 系統推斷 | 原始交易幣別，預設 "TWD"；若訊息提及其他幣別則推斷（如 "USD", "JPY"） | "TWD" |
| 原幣金額 | Number | 使用者必填 | 原始交易金額，從訊息中提取 | 80.00 |
| 匯率 | Number | 系統推斷 | 即時匯率，TWD 為 1.0；其他幣別透過匯率 API 取得 | 1.0 |
| 付款方式 | String | 使用者必填 | 付款方式，從訊息中提取（如「現金」、「信用卡」、「Line Pay」） | "現金" |
| 交易ID | String (YYYYMMDD-NNN) | 系統預設 | 系統自動生成的唯一交易識別碼，NNN 為每日計數器（台灣時區） | "20251111-001" |
| 明細說明 | String | 系統推斷 | 從訊息內容提取的完整描述 | "早餐花了80元買三明治" |
| 分類 | String | 系統推斷 | 從品項推斷的消費分類（如「餐飲」、「交通」、「娛樂」） | "餐飲" |
| 專案 | String | 系統預設 | 使用預設值（如「個人」）；或從訊息推斷（如「工作」、「旅遊」） | "個人" |
| 必要性 | String | 系統預設 | 使用預設值（如「必要」）；或從訊息推斷（如「非必要」） | "必要" |
| 代墊狀態 | String | 系統預設 | 預設「否」；若訊息包含「代墊」、「先付」等關鍵字則為「是」 | "否" |
| 收款／支付對象 | String | 系統推斷 | 從訊息提取對象資訊（如「付給小明」）；若無則為空字串 | "" |
| 附註 | String | 系統預設 | 從訊息中提取的額外備註資訊；若無則為空字串 | "" |

### 範例場景

#### 範例 1：基本支出（台幣）
**使用者訊息**：「午餐花了150元刷卡」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "午餐",
  "原幣別": "TWD",
  "原幣金額": 150.00,
  "匯率": 1.0,
  "付款方式": "信用卡",
  "交易ID": "20251111-002",
  "明細說明": "午餐花了150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

#### 範例 2：外幣交易
**使用者訊息**：「昨天在日本買了拉麵1200日圓付現金」
**假設匯率**：1 JPY = 0.21 TWD

**Webhook JSON**：
```json
{
  "日期": "2025-11-10",
  "品項": "拉麵",
  "原幣別": "JPY",
  "原幣金額": 1200.00,
  "匯率": 0.21,
  "付款方式": "現金",
  "交易ID": "20251110-015",
  "明細說明": "昨天在日本買了拉麵1200日圓付現金",
  "分類": "餐飲",
  "專案": "旅遊",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": ""
}
```

#### 範例 3：代墊款項
**使用者訊息**：「幫同事代墊計程車費300元現金」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "計程車",
  "原幣別": "TWD",
  "原幣金額": 300.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-003",
  "明細說明": "幫同事代墊計程車費300元現金",
  "分類": "交通",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "是",
  "收款／支付對象": "同事",
  "附註": ""
}
```

#### 範例 4：收入項目
**使用者訊息**：「收到薪水50000元轉帳」

**Webhook JSON**：
```json
{
  "日期": "2025-11-11",
  "品項": "薪水",
  "原幣別": "TWD",
  "原幣金額": 50000.00,
  "匯率": 1.0,
  "付款方式": "轉帳",
  "交易ID": "20251111-004",
  "明細說明": "收到薪水50000元轉帳",
  "分類": "收入",
  "專案": "工作",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "公司",
  "附註": ""
}
```

#### 範例 5：單一訊息多筆支出
**使用者訊息**：「早餐80元現金，午餐150元刷卡」

**Webhook JSON 1**（同一交易ID）：
```json
{
  "日期": "2025-11-11",
  "品項": "早餐",
  "原幣別": "TWD",
  "原幣金額": 80.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251111-005",
  "明細說明": "早餐80元現金，午餐150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": "與交易ID 20251111-005 的其他項目為同一訊息"
}
```

**Webhook JSON 2**（同一交易ID）：
```json
{
  "日期": "2025-11-11",
  "品項": "午餐",
  "原幣別": "TWD",
  "原幣金額": 150.00,
  "匯率": 1.0,
  "付款方式": "信用卡",
  "交易ID": "20251111-005",
  "明細說明": "早餐80元現金，午餐150元刷卡",
  "分類": "餐飲",
  "專案": "個人",
  "必要性": "必要",
  "代墊狀態": "否",
  "收款／支付對象": "",
  "附註": "與交易ID 20251111-005 的其他項目為同一訊息"
}
```
