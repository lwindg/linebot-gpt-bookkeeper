# Feature Specification: 多幣別記帳功能

**Feature Branch**: `003-multi-currency`
**Created**: 2025-11-21
**Status**: Draft
**Input**: User description: "進行多幣別功能處理,記錄原幣別、原幣金額及透過台灣銀行 API 取得匯率"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 外幣消費記錄與自動換算 (Priority: P1)

使用者在 LINE 訊息中輸入外幣消費記錄（如「WSJ 4.99美元 大戶」），系統自動識別幣別、金額、項目名稱和付款方式，並透過台灣銀行 API 取得當日匯率，計算並儲存新台幣金額。

**Why this priority**: 這是核心功能，提供多幣別記帳的基本價值。使用者可以直接記錄外幣消費，無需手動換算，大幅提升使用便利性。

**Independent Test**: 可以透過發送單筆外幣消費訊息（例如「WSJ 4.99美元 大戶」）來獨立測試，驗證系統是否正確識別幣別、取得匯率並儲存完整記錄。

**Acceptance Scenarios**:

1. **Given** 使用者已登入系統，**When** 使用者發送「WSJ 4.99美元 大戶」，**Then** 系統識別出幣別為 USD、金額為 4.99、項目為「WSJ」、付款方式為「大戶」，並自動取得美元匯率，計算出新台幣金額並儲存
2. **Given** 使用者已登入系統，**When** 使用者發送「Norrona falketind Gore-Tex Jacket 290.97歐元 灰狗卡」，**Then** 系統識別出幣別為 EUR、金額為 290.97、項目為「Norrona falketind Gore-Tex Jacket」、付款方式為「灰狗卡」，並自動取得歐元匯率，計算出新台幣金額並儲存
3. **Given** 使用者已登入系統，**When** 使用者發送「OpenAI API Key 10美金 大戶」，**Then** 系統識別出「美金」為 USD 的同義詞，金額為 10，並正確處理記錄

---

### User Story 2 - 多筆外幣項目同時處理 (Priority: P2)

使用者可以在單一訊息中輸入多筆外幣消費項目，系統逐一識別每筆記錄的幣別、金額，並分別取得匯率和計算新台幣金額。

**Why this priority**: 提升使用者效率，適合一次性記錄多筆外幣消費的情境（如旅遊後整理發票）。

**Independent Test**: 可以透過發送包含多筆外幣消費的訊息來獨立測試，驗證系統是否正確處理每一筆記錄。

**Acceptance Scenarios**:

1. **Given** 使用者已登入系統，**When** 使用者發送「WSJ 4.99美元 大戶\nOpenAI API Key 10美金 大戶」，**Then** 系統識別出兩筆記錄，分別取得美元匯率，並儲存兩筆獨立的消費記錄
2. **Given** 使用者已登入系統，**When** 使用者發送包含不同幣別的多筆消費，**Then** 系統為每筆記錄取得對應幣別的匯率並正確儲存

---

### Edge Cases

- 當台灣銀行 API 無法取得匯率時（如 API 服務中斷或非營業時間），系統如何處理？
- 當使用者輸入的幣別不被台灣銀行 API 支援時，系統如何回應？
- 當使用者輸入的幣別格式不明確（如「EU」可能是拼寫錯誤或非標準縮寫），系統如何識別？
- 當使用者在同一訊息中混合使用新台幣和外幣時，系統如何區分處理？
- 當匯率波動劇烈時，系統如何確保儲存的匯率是查詢當下的匯率？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須識別使用者訊息中的幣別關鍵字（包含標準幣別代碼如 USD、EUR，以及常見同義詞如「美金」、「歐元」）
- **FR-002**: 系統必須從使用者訊息中正確解析外幣金額（支援整數和小數點格式）
- **FR-003**: 系統必須透過台灣銀行 API 取得指定幣別的當日匯率（現金賣出價）
- **FR-004**: 系統必須計算並儲存外幣金額換算成新台幣的金額（原幣金額 × 匯率）
- **FR-005**: 系統必須儲存每筆外幣消費記錄的完整資訊，包含：原幣別代碼、原幣金額、匯率、新台幣金額、項目名稱、付款方式、記錄時間
- **FR-006**: 系統必須支援多種常見幣別，至少包含：USD（美元）、EUR（歐元）、JPY（日圓）、GBP（英鎊）、AUD（澳幣）、CAD（加拿大幣）、CNY（人民幣）
- **FR-007**: 系統必須能夠處理幣別的多種表達方式（如「美元」、「美金」、「USD」均視為美元）
- **FR-008**: 系統必須在無法取得匯率時，向使用者提供明確的錯誤訊息，並說明原因（如 API 服務中斷、幣別不支援等）
- **FR-009**: 系統必須在成功記錄外幣消費後，向使用者回覆確認訊息，包含原幣金額、匯率和換算後的新台幣金額
- **FR-010**: 系統必須能夠區分外幣消費和新台幣消費（當訊息中無幣別關鍵字時，視為新台幣消費）
- **FR-011**: 系統必須支援在單一訊息中處理多筆外幣消費記錄（每行一筆）
- **FR-012**: 系統必須預存常用幣別（USD、EUR、JPY）的匯率作為備用，當台灣銀行 API 取得匯率失敗時，直接使用預存的備用匯率進行換算

### Key Entities

- **外幣消費記錄（Foreign Currency Expense）**: 代表一筆外幣消費，包含原幣別代碼（如 USD）、原幣金額（如 4.99）、取得的匯率（如 31.5）、計算後的新台幣金額（如 157.19）、項目名稱、付款方式、記錄時間。與一般消費記錄共享部分屬性（項目名稱、付款方式、記錄時間），但額外包含外幣相關資訊。
- **匯率快取（Exchange Rate Cache）**: 儲存從台灣銀行 API 取得的匯率資料，包含幣別代碼、匯率（現金賣出價）、取得時間。用於減少 API 呼叫次數，提升效能。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能夠在 10 秒內完成單筆外幣消費記錄（從發送訊息到收到確認回覆）
- **SC-002**: 系統對外幣消費訊息的幣別識別準確率達 95% 以上（基於常見幣別和格式）
- **SC-003**: 系統對外幣金額解析的準確率達 98% 以上（基於常見數字格式）
- **SC-004**: 90% 的外幣消費記錄能夠成功取得匯率並完成換算（考慮 API 可用性）
- **SC-005**: 系統在台灣銀行 API 可用的情況下，匯率資料的時效性在 24 小時內（即使用當日或前一營業日匯率）

## Assumptions

- 假設台灣銀行 API 提供穩定的匯率查詢服務，並且在營業時間內可正常存取
- 假設使用者輸入的幣別主要為常見國際貨幣（USD、EUR、JPY 等），罕見幣別需求較低
- 假設使用者可接受匯率為台灣銀行的「現金賣出價」作為換算基準（而非即期匯率或現金買入價）
- 假設使用者記錄外幣消費的時間點與實際消費時間相近，因此使用記錄當日匯率是合理的
- 假設系統現有的訊息解析邏輯可以擴充以支援幣別識別，無需完全重寫

## Dependencies

- 台灣銀行匯率 API 的可用性和穩定性
- 現有的訊息解析模組能夠擴充以支援多幣別識別
- 現有的資料儲存結構能夠擴充以儲存外幣消費記錄的額外欄位

## Out of Scope

- 查詢外幣消費記錄功能（未來項目）
- 支援加密貨幣或其他非法定貨幣
- 提供歷史匯率查詢功能（如查詢過去某日的匯率）
- 支援使用者自訂匯率或手動修改匯率
- 提供匯率走勢圖表或分析功能
- 支援多幣別帳戶餘額管理（僅記錄消費，不涉及資產管理）
