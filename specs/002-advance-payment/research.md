# Research: v1.7 代墊與需支付功能

**日期**：2025-11-18
**狀態**：Phase 0 Complete

## 研究目標

本文件解決 Technical Context 中的未知項目，並為 Phase 1 設計提供技術決策依據。

## 研究領域

### 1. GPT Prompt 優化策略

**研究問題**：如何在現有 `MULTI_EXPENSE_PROMPT` 基礎上增加代墊識別能力，同時保持 prompt 精簡並控制 token 成本？

**調查結果**：

#### 1.1 現有 Prompt 架構分析

**現況**（app/prompts.py）：
- 採用模組化設計：`PAYMENT_METHODS`、`CLASSIFICATION_RULES`、`NECESSITY_LEVELS` 為獨立常數
- 主 prompt `MULTI_EXPENSE_PROMPT` 使用 f-string 組合共用規則
- 優點：規則可重用，易於維護
- 缺點：完整 prompt 約 3000+ tokens（含分類規則、付款方式對照表等）

#### 1.2 代墊識別 Prompt 設計原則

根據使用者需求「重用架構、精簡語句、抽出對照資訊做成函式」，採用以下策略：

**策略 1：新增獨立常數 `ADVANCE_PAYMENT_RULES`**
- 抽出代墊狀態對照表為獨立常數（類似 `PAYMENT_METHODS`）
- 包含：關鍵字對照表、提取對象規則、優先順序判斷
- 優點：規則清晰、可重用、易測試

**策略 2：精簡語句使用表格格式**
```python
ADVANCE_PAYMENT_RULES = """## 代墊狀態識別

| 代墊狀態 | 關鍵字 | 範例 |
|---------|-------|-----|
| 代墊 | 「代」+對象、「幫」+對象 | 代妹買、幫同事墊 |
| 需支付 | 對象+「代訂」、「幫我買」 | 弟代訂、朋友幫我買 |
| 不索取 | 「不用還」、「不索取」 | 幫媽買，不用還 |

**提取對象**：「代妹」→「妹」、「弟代訂」→「弟」
**預設規則**：有對象但無明確狀態 → 預設「代墊」
"""
```

**策略 3：付款方式預設邏輯整合**
- 代墊項目：保留實際付款方式（已在訊息中提供）
- 需支付項目：若未明確說明 → 預設「NA」
- 整合到 `MULTI_EXPENSE_PROMPT` 的必要欄位檢查區塊

#### 1.3 Token 成本控制

**測算**：
- 現有 prompt base：~3000 tokens
- 新增代墊規則：~300 tokens（表格格式）
- 總計：~3300 tokens（增加 10%）
- GPT-4o 輸入定價：$2.50/1M tokens → 每次請求 $0.00825
- **結論**：成本增加可接受（個人專案，低頻使用）

### 2. 代墊狀態識別準確率優化

**研究問題**：如何達成 90% 識別準確率目標？

**調查結果**：

#### 2.1 關鍵字歧義處理

**挑戰案例**：
1. 「代妹買」vs「妹代買」→ 方向相反（代墊 vs 需支付）
2. 「幫朋友訂」vs「朋友幫我訂」→ 方向相反
3. 「弟代訂房間」→ 無明確「我」字，需推斷

**解決方案**：明確優先順序規則
```
判斷邏輯：
1. 句首為「代」、「幫」→ 代墊（我代他人）
2. 句首為對象 → 需支付（他人代我）
3. 包含「不用還」→ 不索取（優先級最高）
```

#### 2.2 測試資料集設計

建立測試案例涵蓋：
- ✅ 基本代墊：「代妹購買Pizza兌換券979元現金」
- ✅ 基本需支付：「弟代訂日本白馬房間10000元」
- ✅ 不索取：「幫媽媽買藥500元，不用還」
- ✅ 多項目混合：「早餐80元，午餐150元幫同事代墊，現金」
- ✅ 邊緣案例：「代購咖啡給三位同事」（不拆分）
- ✅ 錯誤情況：「幫忙買了東西200元」（缺少對象）

目標：15+ 測試案例覆蓋所有驗收場景

### 3. 資料模型欄位設計

**研究問題**：如何擴充 `BookkeepingEntry` 以支援代墊功能？

**調查結果**：

#### 3.1 現有欄位分析

```python
@dataclass
class BookkeepingEntry:
    代墊狀態: Optional[str] = "無"          # ✅ 已存在！
    收款支付對象: Optional[str] = ""        # ✅ 已存在！
```

**發現**：欄位已在 v1.6 或更早版本預留，但 GPT prompt 未啟用識別邏輯

**結論**：
- ✅ 無需修改資料模型結構
- ✅ 僅需啟用 GPT 識別和 webhook 傳輸
- ✅ 向下相容（已部署的 v1.5.0 包含這些欄位但保持預設值）

#### 3.2 欄位值規範

**代墊狀態** 允許值：
- `"無"` — 預設值（一般支出）
- `"代墊"` — 代他人支付，需收款
- `"需支付"` — 他人代墊，需償還
- `"不索取"` — 代墊但不收回（v1.7 支援）
- `"已支付"` — 保留（v1.8 規劃）
- `"已收款"` — 保留（v1.8 規劃）

**收款支付對象** 格式：
- 自然語言名稱（如「妹」、「弟」、「同事」、「朋友」）
- 代墊狀態為「無」時保持空字串 `""`
- 不進行正規化或驗證（保留使用者原始輸入）

### 4. LINE 確認訊息格式設計

**研究問題**：如何在確認訊息中清晰顯示代墊資訊？

**調查結果**：

#### 4.1 現有格式分析

單項目格式（`format_confirmation_message`）：
```
✅ 記帳成功！

📋 {品項}
💰 金額：{金額} 元 TWD
💳 付款方式：{付款方式}
📂 分類：{分類}
⭐ 必要性：{必要性}
🔖 交易ID：{交易ID}
📅 日期：{日期}
```

多項目格式（`format_multi_confirmation_message`）：
- 列出所有項目
- 共用資訊顯示在最後（付款方式、交易ID、日期）

#### 4.2 代墊資訊顯示策略

**設計原則**：
- 僅在代墊狀態非「無」時顯示
- 使用明確圖示區分狀態
- 位置：在「必要性」之後，「交易ID」之前

**圖示設計**：
- 💸 代墊給：{對象}
- 💰 需支付給：{對象}
- 🎁 不索取（代墊給：{對象}）

**範例**：
```
✅ 記帳成功！

📋 Pizza兌換券
💰 金額：979 元 TWD
💳 付款方式：現金
📂 分類：家庭支出
⭐ 必要性：想吃想買但合理
💸 代墊給：妹
🔖 交易ID：20251117-143052
📅 日期：2025-11-17
```

### 5. Webhook JSON Schema 設計

**研究問題**：Make.com webhook 是否需要調整以接收新欄位？

**調查結果**：

#### 5.1 現有 Webhook Payload 分析

```python
payload = {
    "operation": "CREATE",
    "日期": entry.日期,
    "品項": entry.品項,
    ...
    "代墊狀態": entry.代墊狀態,      # ✅ 已包含
    "收款支付對象": entry.收款支付對象,  # ✅ 已包含
    ...
}
```

**發現**：Webhook payload 已包含代墊欄位！

**結論**：
- ✅ 無需修改 `webhook_sender.py` 的 payload 結構
- ✅ Make.com 端可能需要更新接收邏輯（非本專案範圍）
- ✅ 僅需確保 GPT 正確填充這些欄位值

#### 5.2 JSON Schema 文件

建立 `contracts/advance-payment-webhook.json` 記錄完整 schema：
- 包含所有欄位定義
- 代墊狀態 enum 值
- 範例 payload（代墊、需支付、不索取）

### 6. 測試策略

**研究問題**：如何確保代墊功能的品質？

**調查結果**：

#### 6.1 測試層級

**整合測試**（最重要）：
- 模擬完整使用者旅程：發送 LINE 訊息 → GPT 處理 → Webhook → 確認回覆
- 覆蓋所有驗收場景（15+ 案例）
- 驗證 90% 準確率目標

**單元測試**（輔助）：
- GPT processor：驗證代墊欄位解析正確性
- Webhook sender：驗證 payload 包含代墊欄位
- LINE handler：驗證確認訊息格式

**手動測試**（發布前）：
- 使用真實 LINE 對話測試
- 驗證 Make.com 端接收正確

#### 6.2 測試資料準備

基於 spec.md 驗收場景建立測試集：
- 代墊基本案例 × 5
- 需支付基本案例 × 5
- 不索取案例 × 3
- 多項目混合 × 2
- 邊緣案例 × 5
- 錯誤情況 × 5

**總計**：25 個測試案例

## 技術決策摘要

| 決策項目 | 選定方案 | 理由 |
|---------|---------|-----|
| Prompt 架構 | 新增 `ADVANCE_PAYMENT_RULES` 常數 | 重用模組化設計，精簡易維護 |
| 關鍵字對照 | 表格格式 + 優先順序規則 | Token 效率高，GPT 易理解 |
| 資料模型 | 重用現有欄位（無修改） | 向下相容，簡單性原則 |
| 確認訊息 | 條件顯示代墊資訊 + 圖示 | 清晰不冗餘，使用者友善 |
| Webhook | 無需修改（欄位已存在） | 最小變更，降低風險 |
| 測試策略 | 整合測試為主 + 25 案例 | 覆蓋使用者旅程，可測量準確率 |

## 拒絕的替代方案

| 替代方案 | 拒絕理由 |
|---------|---------|
| 使用 Function Calling API | 過度工程，增加複雜度和成本 |
| 新增獨立代墊狀態 enum 類別 | 簡單字串即可，無需型別安全 |
| 將代墊規則拆成獨立 prompt | 增加 API 呼叫次數，降低效能 |
| 自動推斷家庭關係為「不索取」 | 需明確使用者意圖，避免誤判 |

## Phase 0 完成確認

✅ 所有 Technical Context 未知項目已解決
✅ Prompt 優化策略明確（表格格式 + 模組化）
✅ 資料模型設計確認（重用現有欄位）
✅ 測試策略定義（25 案例，90% 目標）
✅ 無新增依賴或複雜度

**可進入 Phase 1：設計與契約生成**
