# 功能規格書：v1.7 代墊與需支付功能

**功能分支**：`002-advance-payment`
**建立日期**：2025-11-17
**狀態**：Draft
**輸入**：使用者描述："增加 v1.7 進行「代墊」(代他人支付)及「需支付」(他人代為支付,事後需支付)的功能；當對話提及：- 代妹購買Pizza兌換券979元現金 => 代表 品項「Pizza 兌換券」、金額「979」、付款方式「現金」、代墊狀態「代墊」、收款／支付對象「妹」- 弟代訂日本白馬房間 10000 元 => 代表 品項「日本白馬房間」、金額「10000」、付款方式「NA」、代墊狀態「需支付」、收款／支付對象「弟」"

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 記錄代墊支出（優先級：P1）

使用者幫他人代為支付費用（例如幫妹妹購買商品、幫朋友墊付餐費等），透過 LINE 發送自然語言訊息描述代墊行為，系統智慧辨識為「代墊」狀態的記帳項目，並記錄收款對象資訊。

**為何此優先級**：代墊支出是雙向金流管理的核心功能之一，讓使用者能夠追蹤「代墊後需向他人收款」的金額，避免遺忘或混淆個人支出與代墊款項。此功能提供即時的代墊記錄和未來收款提醒的基礎。

**獨立測試**：可以透過發送 LINE 訊息如「代妹購買Pizza兌換券979元現金」來完整測試，驗證：(1) GPT 正確識別為代墊記帳項目，(2) 提取品項「Pizza兌換券」、金額「979」、付款方式「現金」、代墊狀態「代墊」、收款對象「妹」，(3) 觸發 webhook 並傳送結構化資料，(4) 使用者收到包含代墊狀態和收款對象的確認訊息。

**驗收場景**：

1. **假設** 使用者已將 LINE bot 加為好友，**當** 使用者發送「代妹購買Pizza兌換券979元現金」，**則** 系統回覆格式化項目，顯示品項、金額、付款方式、代墊狀態「代墊」、收款對象「妹」
2. **假設** 使用者發送「幫同事墊付計程車費300元現金」，**當** GPT 處理並識別為代墊記帳項目，**則** 觸發 webhook 並傳送包含代墊狀態「代墊」和收款對象「同事」的結構化 JSON
3. **假設** 使用者發送「代朋友買了午餐150元刷狗卡」，**當** 系統處理，**則** 正確識別品項「午餐」、金額「150」、付款方式「台新狗卡」、代墊狀態「代墊」、收款對象「朋友」
4. **假設** 使用者發送「幫老婆買水果200元現金」，**當** 系統處理，**則** 識別為代墊項目，收款對象為「老婆」，但根據家庭關係可推斷為「不索取」代墊狀態（預設為「代墊」，若需「不索取」需明確說明）
5. **假設** 使用者發送「代購咖啡50元給三位同事，Line轉帳」，**當** 系統處理，**則** 正確識別代墊狀態「代墊」、收款對象「同事」、品項「咖啡」、金額「50」（此為單筆代墊總額，不拆分）

---

### 使用者故事 2 - 記錄需支付款項（優先級：P1）

使用者記錄「他人代為支付，事後需支付給對方」的款項（例如朋友先幫忙訂房、同事幫忙購買等），透過 LINE 發送自然語言訊息描述需支付行為，系統智慧辨識為「需支付」狀態的記帳項目，並記錄支付對象資訊。

**為何此優先級**：需支付款項是代墊功能的互補面，讓使用者能夠追蹤「他人代墊後需償還的金額」，避免遺忘欠款或重複支付。此功能與代墊功能同等重要，構成完整的雙向金流管理體系。

**獨立測試**：可以透過發送 LINE 訊息如「弟代訂日本白馬房間10000元」來完整測試，驗證：(1) GPT 正確識別為需支付記帳項目，(2) 提取品項「日本白馬房間」、金額「10000」、付款方式「NA」、代墊狀態「需支付」、支付對象「弟」，(3) 觸發 webhook 並傳送結構化資料，(4) 使用者收到包含需支付狀態和支付對象的確認訊息。

**驗收場景**：

1. **假設** 使用者已將 LINE bot 加為好友，**當** 使用者發送「弟代訂日本白馬房間10000元」，**則** 系統回覆格式化項目，顯示品項、金額、付款方式「NA」、代墊狀態「需支付」、支付對象「弟」
2. **假設** 使用者發送「朋友幫我買了演唱會門票3000元」，**當** GPT 處理並識別為需支付記帳項目，**則** 觸發 webhook 並傳送包含代墊狀態「需支付」和支付對象「朋友」的結構化 JSON
3. **假設** 使用者發送「同事先墊了午餐120元」，**當** 系統處理，**則** 正確識別品項「午餐」、金額「120」、付款方式「NA」、代墊狀態「需支付」、支付對象「同事」
4. **假設** 使用者發送「媽媽幫忙付了學費50000元」，**當** 系統處理，**則** 識別為需支付項目，支付對象為「媽媽」，付款方式「NA」
5. **假設** 使用者發送「室友代付了水電費1500元」，**當** 系統處理，**則** 正確識別代墊狀態「需支付」、支付對象「室友」、品項「水電費」、金額「1500」

---

### 使用者故事 3 - 處理不索取的代墊款項（優先級：P2）

使用者幫家人代為支付費用但不會索取還款（例如幫父母購買日用品、幫配偶支付帳單等），透過 LINE 發送自然語言訊息明確說明「不索取」，系統智慧辨識為「不索取」狀態的記帳項目。

**為何此優先級**：不索取代墊是家庭成員間常見的金流模式，有助於區分「需收回的代墊款」和「贈與性質的代墊款」，讓財務記錄更精確。雖然重要，但相較於基本代墊和需支付功能，此功能可在後期引入。

**獨立測試**：可以透過發送 LINE 訊息如「幫媽媽買藥500元現金，不用還」來完整測試，驗證：(1) GPT 正確識別為不索取代墊項目，(2) 提取品項、金額、付款方式、代墊狀態「不索取」、收款對象「媽媽」，(3) 觸發 webhook 並傳送結構化資料。

**驗收場景**：

1. **假設** 使用者發送「幫媽媽買藥500元現金，不用還」，**當** GPT 處理，**則** 系統識別代墊狀態為「不索取」、收款對象「媽媽」
2. **假設** 使用者發送「幫老婆付停車費100元，不索取」，**當** 系統處理，**則** 正確識別代墊狀態為「不索取」、收款對象「老婆」
3. **假設** 使用者發送「代女兒繳補習費5000元Line轉帳，送給她的」，**當** 系統處理，**則** 識別代墊狀態為「不索取」、收款對象「女兒」

---

### 邊緣案例

**代墊與需支付相關**：
- **當使用者發送模糊的代墊訊息時**（例如「幫忙買了東西200元」但未說明幫誰買），系統回覆「請提供收款對象資訊（例如：幫誰代墊？）」
- **當使用者發送「代墊」和「需支付」混合訊息時**（例如「幫A代墊100元，B幫我墊付200元」），系統判斷為兩筆獨立交易，回覆「偵測到不同代墊狀態，請分開記帳」
- **當使用者發送「已支付」或「已收款」狀態時**（例如「已還給朋友500元」），v1.7 暫不支援代墊狀態更新，回覆「v1.7 僅支援記錄新的代墊和需支付項目，狀態更新功能將在未來版本提供」
- **當使用者在多筆支出訊息中包含代墊資訊時**（例如「早餐80元，午餐150元幫同事代墊，現金」），系統識別兩筆支出，其中午餐項目代墊狀態為「代墊」、收款對象「同事」，早餐項目代墊狀態為「無」
- **當付款方式不明確時**（例如「弟代訂房間10000元」未說明付款方式），系統預設付款方式為「NA」

**與現有功能整合**：
- **當收據圖片包含代墊資訊時**，v1.7 暫不支援從收據自動識別代墊狀態，使用者需額外發送文字訊息說明代墊狀態
- **當使用者修改上一筆記帳的代墊狀態時**（例如「上一筆改成代墊給朋友」），支援透過 `update_last_entry` intent 更新代墊狀態和收款對象

## 需求 *(必填)*

### 功能需求

**v1.7 核心功能需求**：

**代墊與需支付識別**：
- **FR-041** [v1.7]：系統必須識別訊息中的「代墊」關鍵字（如「代」、「幫」、「代購」、「代訂」、「代為」、「代墊」）並判斷為代墊記帳項目
- **FR-042** [v1.7]：系統必須識別訊息中的「需支付」關鍵字（如「代訂」、「幫忙訂」、「代付」、「先墊」、「幫我買」）並判斷為需支付記帳項目
- **FR-043** [v1.7]：系統必須從訊息中提取收款對象或支付對象資訊（如「妹」、「弟」、「同事」、「朋友」、「媽媽」、「老婆」等）
- **FR-044** [v1.7]：系統必須在 webhook JSON 中包含「代墊狀態」欄位，值為「無」、「代墊」、「需支付」、「不索取」之一（v1.7 僅支援前四種，「已支付」、「已收款」留待未來版本）
- **FR-045** [v1.7]：系統必須在 webhook JSON 中包含「收款／支付對象」欄位，內容為從訊息中提取的對象名稱

**資料驗證和處理**：
- **FR-046** [v1.7]：系統必須在識別為代墊或需支付項目時，驗證是否包含收款／支付對象資訊，若缺少則回覆錯誤訊息要求補充
- **FR-047** [v1.7]：系統必須在代墊或需支付項目中，若未明確說明付款方式，預設為「NA」
- **FR-048** [v1.7]：系統必須支援在多筆支出訊息中，部分項目為代墊狀態、部分為一般支出
- **FR-049** [v1.7]：系統必須在使用者嘗試記錄「已支付」或「已收款」狀態時，回覆「v1.7 僅支援記錄新的代墊和需支付項目，狀態更新功能將在未來版本提供」

**GPT Prompt 增強**：
- **FR-050** [v1.7]：系統必須更新 GPT prompt，新增代墊狀態和收款／支付對象的識別邏輯
- **FR-051** [v1.7]：系統必須在 GPT prompt 中定義「代墊」、「需支付」、「不索取」的關鍵字列表和識別規則
- **FR-052** [v1.7]：系統必須在 GPT prompt 中說明如何從自然語言中提取收款／支付對象

**回覆訊息格式**：
- **FR-053** [v1.7]：系統必須在確認訊息中顯示代墊狀態和收款／支付對象資訊（當代墊狀態非「無」時）
- **FR-054** [v1.7]：系統必須在確認訊息中使用明確的圖示或文字標示代墊狀態（如「💸 代墊給」、「💰 需支付給」）

**v1.7 明確排除**：
- ❌ 不支援代墊狀態更新（如「代墊」→「已收款」、「需支付」→「已支付」）
- ❌ 不支援從收據圖片自動識別代墊狀態
- ❌ 不支援代墊款項提醒或追蹤功能
- ❌ 不支援批次更新多筆代墊狀態

### 關鍵實體

- **代墊記帳項目**：代表使用者代他人支付的財務交易，包含以下欄位：
  - **使用者必填**：品項、原幣金額、收款對象
  - **系統推斷**：日期、原幣別、匯率、分類、明細說明、代墊狀態（「代墊」）
  - **系統預設**：交易ID、專案、必要性、付款方式（若未提供則預設「NA」）、附註

- **需支付記帳項目**：代表他人代為支付，使用者事後需支付給對方的財務交易，包含以下欄位：
  - **使用者必填**：品項、原幣金額、支付對象
  - **系統推斷**：日期、原幣別、匯率、分類、明細說明、代墊狀態（「需支付」）
  - **系統預設**：交易ID、專案、必要性、付款方式（預設「NA」）、附註

- **代墊狀態（Advance Payment Status）**：標示記帳項目的代墊性質，值為以下之一：
  - **無**：本人支出，無代墊或待收待付情況
  - **代墊**：本人代為支付，需日後由對方付款給我
  - **需支付**：他人代墊，本人需支付給對方
  - **不索取**：本人代墊他人費用，但不會索取回款（如對家人支援）
  - **已支付**（v1.7 不支援）：本人已完成付款予對方（處理完成的需支付項目）
  - **已收款**（v1.7 不支援）：已經收到對方的還款（處理完成的代墊項目）

- **收款／支付對象（Recipient / Payer）**：代墊或需支付項目的交易對象，為自然語言提取的名稱（如「妹」、「弟」、「同事」、「朋友」、「媽媽」等）

## 成功標準 *(必填)*

### 可測量成果

- **SC-001** [v1.7]：使用者能透過發送包含「代墊」關鍵字的自然語言訊息成功記錄代墊項目，並在 5 秒內收到包含代墊狀態和收款對象的確認訊息
- **SC-002** [v1.7]：使用者能透過發送包含「需支付」關鍵字的自然語言訊息成功記錄需支付項目，並在 5 秒內收到包含代墊狀態和支付對象的確認訊息
- **SC-003** [v1.7]：系統正確識別和分類至少 90% 的代墊和需支付訊息（基於測試資料集）
- **SC-004** [v1.7]：系統在代墊或需支付項目中，若未明確說明付款方式，100% 正確預設為「NA」
- **SC-005** [v1.7]：系統在缺少收款／支付對象資訊時，100% 回覆錯誤訊息要求使用者補充
- **SC-006** [v1.7]：Webhook JSON 100% 包含正確的「代墊狀態」和「收款／支付對象」欄位（當代墊狀態非「無」時）
- **SC-007** [v1.7]：系統在處理多筆支出訊息時，能正確區分代墊項目和一般支出項目，準確率達 95% 以上

## Webhook JSON Schema 範例（v1.7 增強版）

### 代墊項目範例

**使用者訊息**：「代妹購買Pizza兌換券979元現金」

**Webhook JSON**：
```json
{
  "日期": "2025-11-17",
  "品項": "Pizza兌換券",
  "原幣別": "TWD",
  "原幣金額": 979.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251117-001",
  "明細說明": "代妹購買Pizza兌換券979元現金",
  "分類": "家庭支出",
  "專案": "日常",
  "必要性": "想吃想買但合理",
  "代墊狀態": "代墊",
  "收款／支付對象": "妹",
  "附註": ""
}
```

### 需支付項目範例

**使用者訊息**：「弟代訂日本白馬房間10000元」

**Webhook JSON**：
```json
{
  "日期": "2025-11-17",
  "品項": "日本白馬房間",
  "原幣別": "TWD",
  "原幣金額": 10000.00,
  "匯率": 1.0,
  "付款方式": "NA",
  "交易ID": "20251117-002",
  "明細說明": "弟代訂日本白馬房間10000元",
  "分類": "行程／裝備／租借",
  "專案": "登山行程",
  "必要性": "必要日常支出",
  "代墊狀態": "需支付",
  "收款／支付對象": "弟",
  "附註": ""
}
```

### 不索取代墊項目範例

**使用者訊息**：「幫媽媽買藥500元現金，不用還」

**Webhook JSON**：
```json
{
  "日期": "2025-11-17",
  "品項": "藥",
  "原幣別": "TWD",
  "原幣金額": 500.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251117-003",
  "明細說明": "幫媽媽買藥500元現金，不用還",
  "分類": "健康／醫療／家庭成員",
  "專案": "日常",
  "必要性": "必要日常支出",
  "代墊狀態": "不索取",
  "收款／支付對象": "媽媽",
  "附註": ""
}
```

### 多筆支出含代墊範例

**使用者訊息**：「早餐80元，午餐150元幫同事代墊，現金」

**Webhook JSON 1**（一般支出）：
```json
{
  "日期": "2025-11-17",
  "品項": "早餐",
  "原幣別": "TWD",
  "原幣金額": 80.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251117-004",
  "明細說明": "早餐80元，午餐150元幫同事代墊，現金",
  "分類": "家庭／餐飲／早餐",
  "專案": "日常",
  "必要性": "必要日常支出",
  "代墊狀態": "無",
  "收款／支付對象": "",
  "附註": "與交易ID 20251117-004 的其他項目為同一訊息"
}
```

**Webhook JSON 2**（代墊支出）：
```json
{
  "日期": "2025-11-17",
  "品項": "午餐",
  "原幣別": "TWD",
  "原幣金額": 150.00,
  "匯率": 1.0,
  "付款方式": "現金",
  "交易ID": "20251117-004",
  "明細說明": "早餐80元，午餐150元幫同事代墊，現金",
  "分類": "個人／餐飲",
  "專案": "日常",
  "必要性": "必要日常支出",
  "代墊狀態": "代墊",
  "收款／支付對象": "同事",
  "附註": "與交易ID 20251117-004 的其他項目為同一訊息"
}
```

## 使用者回覆格式（v1.7 增強版）

### 代墊項目回覆範例

```
✅ 記帳成功

📅 日期：2025-11-17
🏷️ 品項：Pizza兌換券
💰 金額：979 元（台幣）
💳 付款：現金
📂 分類：家庭支出
📋 專案：日常
⭐ 必要性：想吃想買但合理
💸 代墊給：妹
🔖 交易ID：20251117-143052
```

### 需支付項目回覆範例

```
✅ 記帳成功

📅 日期：2025-11-17
🏷️ 品項：日本白馬房間
💰 金額：10000 元（台幣）
💳 付款：NA
📂 分類：行程／裝備／租借
📋 專案：登山行程
⭐ 必要性：必要日常支出
💰 需支付給：弟
🔖 交易ID：20251117-143052
```

### 不索取代墊項目回覆範例

```
✅ 記帳成功

📅 日期：2025-11-17
🏷️ 品項：藥
💰 金額：500 元（台幣）
💳 付款：現金
📂 分類：健康／醫療／家庭成員
📋 專案：日常
⭐ 必要性：必要日常支出
🎁 不索取（代墊給：媽媽）
🔖 交易ID：20251117-143052
```

## GPT Prompt 增強指引

### 代墊狀態識別規則

**關鍵字識別表**：

| 代墊狀態 | 關鍵字範例 | 範例訊息 |
|---------|----------|---------|
| 代墊 | 「代」、「幫」+對象、「代購」、「代訂」、「代為」、「代墊」、「先付」、「幫付」 | 「代妹買Pizza」、「幫同事墊付車費」、「代訂房間給朋友」 |
| 需支付 | 對象+「代訂」、「幫忙訂」、「代付」、「先墊」、「幫我買」、「幫買」 | 「弟代訂房間」、「朋友幫我買票」、「同事先墊了午餐」 |
| 不索取 | 「代」+對象+「不用還」、「不索取」、「送給」、「不收」 | 「幫媽媽買藥，不用還」、「代老婆付費，不索取」 |
| 無 | 無代墊關鍵字 | 「午餐120元現金」、「買咖啡50元」 |

**提取收款／支付對象規則**：

1. **「代」+對象**：「代妹買」→ 收款對象「妹」
2. **「幫」+對象**：「幫同事墊」→ 收款對象「同事」
3. **對象+「代訂」**：「弟代訂」→ 支付對象「弟」
4. **對象+「幫我」**：「朋友幫我買」→ 支付對象「朋友」
5. **「付給」+對象**：「付給小明」→ 支付對象「小明」

**優先順序**（當訊息模糊時）：

1. 若包含「不用還」、「不索取」→ 代墊狀態「不索取」
2. 若包含「代」、「幫」在前 → 代墊狀態「代墊」
3. 若包含對象在前+「代」、「幫」→ 代墊狀態「需支付」
4. 若無明確關鍵字但有對象 → 預設「代墊」（保守策略）

**付款方式預設規則**：

- 代墊項目：若未說明付款方式，使用實際支付的方式（如「現金」、「刷卡」）
- 需支付項目：若未說明付款方式，**預設「NA」**（因他人代為支付，本人尚未支付）

## 未來版本規劃

### v1.8 代墊狀態更新（未來版本）

**目標**：支援代墊狀態的更新和追蹤

**新增功能**：
- 支援「已收款」狀態更新（代墊 → 已收款）
- 支援「已支付」狀態更新（需支付 → 已支付）
- 支援透過 `update_last_entry` intent 更新代墊狀態
- 支援查詢未收回的代墊款項清單

### v2 代墊提醒與追蹤（未來版本）

**目標**：主動提醒和追蹤代墊款項

**新增功能**：
- 定期提醒未收回的代墊款項
- 定期提醒未支付的欠款
- 支援代墊款項統計和報表
- 支援批次更新代墊狀態
