{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LINE Bot GPT Bookkeeper - Advance Payment Webhook Contract",
  "description": "v1.7 代墊與需支付功能 Webhook JSON Schema（Make.com 整合）",
  "version": "1.7.0",
  "type": "object",
  "required": [
    "operation",
    "日期",
    "品項",
    "原幣別",
    "原幣金額",
    "匯率",
    "付款方式",
    "交易ID",
    "分類",
    "必要性",
    "代墊狀態"
  ],
  "properties": {
    "operation": {
      "type": "string",
      "enum": ["CREATE", "UPDATE"],
      "description": "操作類型（v1.5.0 新增，用於 Make.com Router）",
      "examples": ["CREATE"]
    },
    "日期": {
      "type": "string",
      "format": "date",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "交易日期（YYYY-MM-DD 格式）",
      "examples": ["2025-11-17"]
    },
    "品項": {
      "type": "string",
      "minLength": 1,
      "description": "購買的商品或服務名稱",
      "examples": ["Pizza兌換券", "日本白馬房間", "午餐"]
    },
    "原幣別": {
      "type": "string",
      "enum": ["TWD"],
      "description": "原始幣別（v1.7 僅支援台幣）",
      "examples": ["TWD"]
    },
    "原幣金額": {
      "type": "number",
      "minimum": 0,
      "description": "原幣金額（正數，浮點數）",
      "examples": [979.0, 10000.0, 150.0]
    },
    "匯率": {
      "type": "number",
      "minimum": 0,
      "description": "匯率（預設 1.0，台幣固定為 1.0）",
      "examples": [1.0]
    },
    "付款方式": {
      "type": "string",
      "description": "付款方式（標準名稱，參照付款方式對照表）",
      "enum": [
        "現金",
        "Line Pay",
        "合庫",
        "台新狗卡",
        "台新 Richart",
        "FlyGo 信用卡",
        "大戶信用卡",
        "聯邦綠卡",
        "富邦 Costco",
        "星展永續卡",
        "NA"
      ],
      "examples": ["現金", "台新狗卡", "NA"]
    },
    "交易ID": {
      "type": "string",
      "pattern": "^\\d{8}-\\d{6}$",
      "description": "交易ID（YYYYMMDD-HHMMSS 格式）",
      "examples": ["20251117-143052"]
    },
    "明細說明": {
      "type": "string",
      "description": "明細說明（可選，如商家名稱、用途說明等）",
      "examples": ["開飯", "7-11", "做早餐使用", ""]
    },
    "分類": {
      "type": "string",
      "description": "分類（大類／子類／細類格式，全形斜線）",
      "pattern": "^[^／]+／[^／]+(／[^／]+)?$",
      "examples": ["家庭支出", "行程／裝備／租借", "家庭／餐飲／早餐"]
    },
    "專案": {
      "type": "string",
      "description": "專案名稱（預設「日常」）",
      "examples": ["日常", "登山行程"]
    },
    "必要性": {
      "type": "string",
      "enum": [
        "必要日常支出",
        "想吃想買但合理",
        "療癒性支出",
        "衝動購物（提醒）"
      ],
      "description": "必要性等級",
      "examples": ["必要日常支出", "想吃想買但合理"]
    },
    "代墊狀態": {
      "type": "string",
      "enum": ["無", "代墊", "需支付", "不索取", "已支付", "已收款"],
      "description": "代墊狀態（v1.7 新增，支援：無、代墊、需支付、不索取；保留：已支付、已收款）",
      "default": "無",
      "examples": ["無", "代墊", "需支付", "不索取"]
    },
    "收款支付對象": {
      "type": "string",
      "description": "收款或支付對象名稱（當代墊狀態非「無」時必填）",
      "examples": ["妹", "弟", "同事", "朋友", "媽媽", ""]
    },
    "附註": {
      "type": "string",
      "description": "附註（可選）",
      "examples": ["", "與交易ID 20251117-004 的其他項目為同一訊息"]
    }
  },
  "examples": [
    {
      "title": "範例 1：代墊項目",
      "description": "使用者訊息：「代妹購買Pizza兌換券979元現金」",
      "payload": {
        "operation": "CREATE",
        "日期": "2025-11-17",
        "品項": "Pizza兌換券",
        "原幣別": "TWD",
        "原幣金額": 979.0,
        "匯率": 1.0,
        "付款方式": "現金",
        "交易ID": "20251117-143052",
        "明細說明": "代妹購買Pizza兌換券979元現金",
        "分類": "家庭支出",
        "專案": "日常",
        "必要性": "想吃想買但合理",
        "代墊狀態": "代墊",
        "收款支付對象": "妹",
        "附註": ""
      }
    },
    {
      "title": "範例 2：需支付項目",
      "description": "使用者訊息：「弟代訂日本白馬房間10000元」",
      "payload": {
        "operation": "CREATE",
        "日期": "2025-11-17",
        "品項": "日本白馬房間",
        "原幣別": "TWD",
        "原幣金額": 10000.0,
        "匯率": 1.0,
        "付款方式": "NA",
        "交易ID": "20251117-143052",
        "明細說明": "弟代訂日本白馬房間10000元",
        "分類": "行程／裝備／租借",
        "專案": "登山行程",
        "必要性": "必要日常支出",
        "代墊狀態": "需支付",
        "收款支付對象": "弟",
        "附註": ""
      }
    },
    {
      "title": "範例 3：不索取代墊項目",
      "description": "使用者訊息：「幫媽媽買藥500元現金，不用還」",
      "payload": {
        "operation": "CREATE",
        "日期": "2025-11-17",
        "品項": "藥",
        "原幣別": "TWD",
        "原幣金額": 500.0,
        "匯率": 1.0,
        "付款方式": "現金",
        "交易ID": "20251117-143052",
        "明細說明": "幫媽媽買藥500元現金，不用還",
        "分類": "健康／醫療／家庭成員",
        "專案": "日常",
        "必要性": "必要日常支出",
        "代墊狀態": "不索取",
        "收款支付對象": "媽媽",
        "附註": ""
      }
    },
    {
      "title": "範例 4：多項目含代墊（項目 1 - 一般支出）",
      "description": "使用者訊息：「早餐80元，午餐150元幫同事代墊，現金」",
      "payload": {
        "operation": "CREATE",
        "日期": "2025-11-17",
        "品項": "早餐",
        "原幣別": "TWD",
        "原幣金額": 80.0,
        "匯率": 1.0,
        "付款方式": "現金",
        "交易ID": "20251117-143052",
        "明細說明": "早餐80元，午餐150元幫同事代墊，現金",
        "分類": "家庭／餐飲／早餐",
        "專案": "日常",
        "必要性": "必要日常支出",
        "代墊狀態": "無",
        "收款支付對象": "",
        "附註": "與交易ID 20251117-143052 的其他項目為同一訊息"
      }
    },
    {
      "title": "範例 5：多項目含代墊（項目 2 - 代墊支出）",
      "description": "使用者訊息：「早餐80元，午餐150元幫同事代墊，現金」",
      "payload": {
        "operation": "CREATE",
        "日期": "2025-11-17",
        "品項": "午餐",
        "原幣別": "TWD",
        "原幣金額": 150.0,
        "匯率": 1.0,
        "付款方式": "現金",
        "交易ID": "20251117-143052",
        "明細說明": "早餐80元，午餐150元幫同事代墊，現金",
        "分類": "個人／餐飲",
        "專案": "日常",
        "必要性": "必要日常支出",
        "代墊狀態": "代墊",
        "收款支付對象": "同事",
        "附註": "與交易ID 20251117-143052 的其他項目為同一訊息"
      }
    }
  ],
  "notes": [
    "v1.7 新增欄位：代墊狀態、收款支付對象（欄位已在 v1.6 預留，v1.7 啟用識別邏輯）",
    "付款方式預設規則：代墊項目保留實際方式，需支付項目預設「NA」",
    "代墊狀態非「無」時，收款支付對象必填（GPT 層驗證，缺少時回傳 error）",
    "多項目記帳時，每個項目分別發送 webhook（共用交易ID）",
    "Make.com 端需更新接收邏輯以處理代墊欄位（非本專案範圍）"
  ]
}
