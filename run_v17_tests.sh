#!/bin/bash
# v1.7.0 ä»£å¢ŠåŠŸèƒ½æ¸¬è©¦è…³æœ¬ - æ”¯æ´è‡ªå‹•åˆ¤æ–·å’Œäººå·¥æª¢è¦–
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   ./run_v17_tests.sh          # äººå·¥åˆ¤æ–·æ¨¡å¼ï¼ˆé è¨­ï¼‰
#   ./run_v17_tests.sh --auto   # è‡ªå‹•åˆ¤æ–·æ¨¡å¼
#   ./run_v17_tests.sh --help   # é¡¯ç¤ºèªªæ˜

# ç¢ºä¿ UTF-8 ç·¨ç¢¼
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å…¨åŸŸè®Šæ•¸
AUTO_MODE=false
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
SKIPPED_TESTS=0
FILTER_PATTERN=""

# è§£æåƒæ•¸
while [[ $# -gt 0 ]]; do
    case "$1" in
        --auto)
            AUTO_MODE=true
            shift
            ;;
        --only)
            FILTER_PATTERN="$2"
            shift 2
            ;;
        --help|-h)
            echo "v1.7.0 ä»£å¢ŠåŠŸèƒ½æ¸¬è©¦è…³æœ¬"
            echo ""
            echo "ä½¿ç”¨æ–¹å¼ï¼š"
            echo "  ./run_v17_tests.sh                    äººå·¥åˆ¤æ–·æ¨¡å¼ï¼ˆé è¨­ï¼‰"
            echo "  ./run_v17_tests.sh --auto             è‡ªå‹•åˆ¤æ–·æ¨¡å¼"
            echo "  ./run_v17_tests.sh --only <pattern>   åªåŸ·è¡Œç¬¦åˆ pattern çš„æ¸¬è©¦"
            echo "  ./run_v17_tests.sh --help             é¡¯ç¤ºæ­¤èªªæ˜"
            echo ""
            echo "é¸æ“‡æ€§æ¸¬è©¦ç¯„ä¾‹ï¼š"
            echo "  ./run_v17_tests.sh --auto --only 004          # åªæ¸¬ TC-V17-004"
            echo "  ./run_v17_tests.sh --auto --only \"00[4-8]\"    # æ¸¬ 004-008"
            echo "  ./run_v17_tests.sh --auto --only ä»£å¢Š          # æ¸¬æ‰€æœ‰ä»£å¢Šç›¸é—œ"
            echo "  ./run_v17_tests.sh --auto --only åª½åª½          # æ¸¬åŒ…å«ã€Œåª½åª½ã€çš„æ¡ˆä¾‹"
            echo ""
            echo "è‡ªå‹•åˆ¤æ–·æ¨¡å¼ï¼š"
            echo "  - è‡ªå‹•æ¯”å°å¯¦éš›çµæœèˆ‡é æœŸçµæœ"
            echo "  - é¡¯ç¤ºè©³ç´°çš„å·®ç•°è³‡è¨Š"
            echo "  - çµ±è¨ˆé€šé/å¤±æ•—æ¸¬è©¦æ•¸é‡"
            echo "  - åˆ¤æ–·é …ç›®ï¼šå“é …ã€é‡‘é¡ã€ä»˜æ¬¾æ–¹å¼ã€ä»£å¢Šç‹€æ…‹ã€æ—¥æœŸ"
            echo "  - ä¸åˆ¤æ–·ï¼šäº¤æ˜“IDï¼ˆæ¯æ¬¡éƒ½ä¸åŒï¼‰"
            echo ""
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

echo "======================================================================"
echo "ğŸ§ª v1.7.0 ä»£å¢ŠåŠŸèƒ½æ¸¬è©¦è…³æœ¬"
echo "======================================================================"
echo ""
if [[ "$AUTO_MODE" == true ]]; then
    echo "æ¨¡å¼ï¼šğŸ¤– è‡ªå‹•åˆ¤æ–·"
else
    echo "æ¨¡å¼ï¼šğŸ‘¤ äººå·¥åˆ¤æ–·"
    echo ""
    echo "ä½¿ç”¨æ–¹å¼ï¼š"
    echo "  - æ¯å€‹æ¸¬è©¦æ¡ˆä¾‹æœƒé¡¯ç¤ºæ¸¬è©¦è¨Šæ¯å’Œçµæœ"
    echo "  - æŒ‰ Enter ç¹¼çºŒä¸‹ä¸€å€‹æ¸¬è©¦"
    echo "  - æŒ‰ Ctrl+C ä¸­æ–·æ¸¬è©¦"
fi
if [[ -n "$FILTER_PATTERN" ]]; then
    echo "éæ¿¾ï¼š$FILTER_PATTERN"
fi
echo ""
read -p "æŒ‰ Enter é–‹å§‹æ¸¬è©¦..."

# å¾è¼¸å‡ºæå– JSON
extract_json() {
    local output="$1"
    # æå– "å®Œæ•´ JSON:" ä¹‹å¾Œçš„å…§å®¹ï¼Œåˆ° "====" çµæŸ
    # ä½¿ç”¨ sed æ›¿ä»£ head -n -1ï¼ˆmacOS ä¸æ”¯æ´è² æ•¸ï¼‰
    echo "$output" | sed -n '/å®Œæ•´ JSON:/,/====/p' | tail -n +2 | sed '$d'
}

# æå–æ¬„ä½å€¼çš„è¼”åŠ©å‡½æ•¸ï¼ˆä½¿ç”¨ jq è§£æ JSONï¼‰
extract_field() {
    local output="$1"
    local field="$2"
    local json=$(extract_json "$output")

    # æª¢æŸ¥æ˜¯å¦æœ‰ entries é™£åˆ—ï¼ˆå¤šé …ç›®ï¼‰æˆ–ç›´æ¥æ˜¯ç‰©ä»¶ï¼ˆå–®é …ç›®ï¼‰
    local has_entries=$(echo "$json" | jq -r 'has("entries")' 2>/dev/null)

    case "$field" in
        "intent")
            # å¾ emoji è¼¸å‡ºæå–æ„åœ–ï¼ˆJSON ä¸­å¯èƒ½æ²’æœ‰ï¼‰
            echo "$output" | grep "ğŸ“ æ„åœ–:" | sed 's/.*ğŸ“ æ„åœ–: //' | tr -d '\n'
            ;;
        "item")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["å“é …"] // empty'
            else
                echo "$json" | jq -r '.["å“é …"] // empty'
            fi
            ;;
        "amount")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["åŸå¹£é‡‘é¡"] // empty'
            else
                echo "$json" | jq -r '.["åŸå¹£é‡‘é¡"] // empty'
            fi
            ;;
        "payment")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["ä»˜æ¬¾æ–¹å¼"] // empty'
            else
                echo "$json" | jq -r '.["ä»˜æ¬¾æ–¹å¼"] // empty'
            fi
            ;;
        "advance_status")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["ä»£å¢Šç‹€æ…‹"] // empty'
            else
                echo "$json" | jq -r '.["ä»£å¢Šç‹€æ…‹"] // empty'
            fi
            ;;
        "date")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["æ—¥æœŸ"] // empty'
            else
                echo "$json" | jq -r '.["æ—¥æœŸ"] // empty'
            fi
            ;;
        "item_count")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries | length'
            else
                echo "1"
            fi
            ;;
        "recipient")
            if [[ "$has_entries" == "true" ]]; then
                echo "$json" | jq -r '.entries[0]["æ”¶æ¬¾æ”¯ä»˜å°è±¡"] // empty'
            else
                echo "$json" | jq -r '.["æ”¶æ¬¾æ”¯ä»˜å°è±¡"] // empty'
            fi
            ;;
    esac
}

# äººå·¥åˆ¤æ–·æ¨¡å¼
run_test_manual() {
    local category="$1"
    local test_name="$2"
    local message="$3"
    local description="$4"

    TOTAL_TESTS=$((TOTAL_TESTS + 1))

    echo ""
    echo "======================================================================"
    echo -e "${BLUE}[$category]${NC} $test_name"
    echo "======================================================================"
    echo ""
    echo "ğŸ“© æ¸¬è©¦è¨Šæ¯ï¼š"
    echo "   $message"
    echo ""
    echo "ğŸ“ é æœŸçµæœï¼š"
    echo "   $description"
    echo ""
    echo "ğŸ” å¯¦éš›çµæœï¼š"
    echo "----------------------------------------------------------------------"

    # åŸ·è¡Œæ¸¬è©¦
    python test_local.py "$message" 2>&1 | grep -E "(ğŸ“|ğŸ›ï¸|ğŸ’°|ğŸ’³|ğŸ“…|ğŸ’¸|ğŸ‘¤|ğŸ“Š|ğŸ’¬)" | head -20

    echo "----------------------------------------------------------------------"
    echo ""
    read -p "æŒ‰ Enter ç¹¼çºŒä¸‹ä¸€å€‹æ¸¬è©¦..."
}

# è‡ªå‹•åˆ¤æ–·æ¨¡å¼
run_test_auto() {
    local category="$1"
    local test_name="$2"
    local message="$3"
    local description="$4"
    local expected_intent="$5"
    local expected_item="$6"
    local expected_amount="$7"
    local expected_payment="$8"
    local expected_advance="$9"
    local expected_date="${10}"
    local expected_item_count="${11}"
    local expected_recipient="${12}"

    TOTAL_TESTS=$((TOTAL_TESTS + 1))

    echo ""
    echo "======================================================================"
    echo -e "${BLUE}[$category]${NC} $test_name"
    echo "======================================================================"
    echo "ğŸ“© æ¸¬è©¦è¨Šæ¯: $message"

    # åŸ·è¡Œæ¸¬è©¦
    local output=$(python test_local.py "$message" 2>&1)

    # æå–å¯¦éš›å€¼ï¼ˆä½¿ç”¨ jq è§£æ JSONï¼‰
    local actual_intent=$(extract_field "$output" "intent")
    local actual_item=$(extract_field "$output" "item")
    local actual_amount=$(extract_field "$output" "amount")
    local actual_payment=$(extract_field "$output" "payment")
    local actual_advance=$(extract_field "$output" "advance_status")
    local actual_date=$(extract_field "$output" "date")
    local actual_item_count=$(extract_field "$output" "item_count")
    local actual_recipient=$(extract_field "$output" "recipient")

    # åˆ¤æ–·çµæœä¸¦å³æ™‚è¼¸å‡ºï¼ˆé¿å…ç·¨ç¢¼å•é¡Œï¼‰
    local test_passed=true
    local failures=()

    # æª¢æŸ¥å„æ¬„ä½
    [[ -n "$expected_intent" && "$actual_intent" != "$expected_intent" ]] && test_passed=false && failures+=("æ„åœ–: $expected_intent â†’ $actual_intent")
    [[ -n "$expected_item" && "$actual_item" != "$expected_item" ]] && test_passed=false && failures+=("å“é …: $expected_item â†’ $actual_item")
    [[ -n "$expected_amount" && "$actual_amount" != "$expected_amount" ]] && test_passed=false && failures+=("é‡‘é¡: $expected_amount â†’ $actual_amount")
    [[ -n "$expected_payment" && "$actual_payment" != "$expected_payment" ]] && test_passed=false && failures+=("ä»˜æ¬¾: $expected_payment â†’ $actual_payment")
    [[ -n "$expected_advance" && "$actual_advance" != "$expected_advance" ]] && test_passed=false && failures+=("ä»£å¢Š: $expected_advance â†’ $actual_advance")
    [[ -n "$expected_date" && "$actual_date" != "$expected_date" ]] && test_passed=false && failures+=("æ—¥æœŸ: $expected_date â†’ $actual_date")
    [[ -n "$expected_item_count" && "$actual_item_count" != "$expected_item_count" ]] && test_passed=false && failures+=("æ•¸é‡: $expected_item_count â†’ $actual_item_count")
    [[ -n "$expected_recipient" && "$actual_recipient" != "$expected_recipient" ]] && test_passed=false && failures+=("å°è±¡: $expected_recipient â†’ $actual_recipient")

    # é¡¯ç¤ºçµæœ
    if [[ "$test_passed" == true ]]; then
        echo -e "${GREEN}âœ… PASS${NC}"
        PASSED_TESTS=$((PASSED_TESTS + 1))
    else
        echo -e "${RED}âŒ FAIL${NC}"
        for f in "${failures[@]}"; do
            echo "  âŒ $f"
        done
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi
}

# åˆ¤æ–·åŸ·è¡Œå“ªç¨®æ¨¡å¼
run_test() {
    local test_name="$2"
    local message="$3"

    # æª¢æŸ¥éæ¿¾æ¢ä»¶
    if [[ -n "$FILTER_PATTERN" ]]; then
        if ! echo "$test_name $message" | grep -qE "$FILTER_PATTERN"; then
            # ä¸ç¬¦åˆéæ¿¾æ¢ä»¶ï¼Œè·³é
            return
        fi
    fi

    if [[ "$AUTO_MODE" == true ]]; then
        run_test_auto "$@"
    else
        run_test_manual "$1" "$2" "$3" "$4"
    fi
}

# ============================================================
# ä»£å¢ŠåŠŸèƒ½æ¸¬è©¦ï¼ˆä»£å¢Šçµ¦ä»–äººï¼‰
# ============================================================

run_test "ä»£å¢ŠåŠŸèƒ½" "TC-V17-001: åŸºæœ¬ä»£å¢Š - å¦¹" \
    "ä»£å¦¹è³¼è²·Pizzaå…Œæ›åˆ¸979å…ƒç¾é‡‘" \
    "âœ… å“é …: Pizzaå…Œæ›åˆ¸, ä»£å¢Šç‹€æ…‹: ä»£å¢Š, å°è±¡: å¦¹" \
    "è¨˜å¸³" "Pizzaå…Œæ›åˆ¸" "979.0" "ç¾é‡‘" "ä»£å¢Š" "" "" "å¦¹"

run_test "ä»£å¢ŠåŠŸèƒ½" "TC-V17-002: ä»£å¢Š - åŒäº‹è¨ˆç¨‹è»Šè²»" \
    "å¹«åŒäº‹å¢Šä»˜è¨ˆç¨‹è»Šè²»100å…ƒç¾é‡‘" \
    "âœ… å“é …: è¨ˆç¨‹è»Šè²», ä»£å¢Šç‹€æ…‹: ä»£å¢Š, å°è±¡: åŒäº‹" \
    "è¨˜å¸³" "è¨ˆç¨‹è»Šè²»" "100.0" "ç¾é‡‘" "ä»£å¢Š" "" "" "åŒäº‹"

run_test "ä»£å¢ŠåŠŸèƒ½" "TC-V17-003: ä»£å¢Š - æœ‹å‹åˆé¤åˆ·å¡" \
    "ä»£æœ‹å‹è²·åˆé¤120å…ƒåˆ·ç‹—å¡" \
    "âœ… å“é …: åˆé¤, ä»£å¢Šç‹€æ…‹: ä»£å¢Š, ä»˜æ¬¾: å°æ–°ç‹—å¡, å°è±¡: æœ‹å‹" \
    "è¨˜å¸³" "åˆé¤" "120.0" "å°æ–°ç‹—å¡" "ä»£å¢Š" "" "" "æœ‹å‹"

run_test "ä»£å¢ŠåŠŸèƒ½" "TC-V17-004: ä»£è³¼å’–å•¡ - Lineè½‰å¸³" \
    "ä»£è³¼å’–å•¡çµ¦ä¸‰ä½åŒäº‹150å…ƒLineè½‰å¸³" \
    "âœ… å“é …: å’–å•¡, ä»£å¢Šç‹€æ…‹: ä»£å¢Š, ä»˜æ¬¾: Line è½‰å¸³, å°è±¡: åŒäº‹" \
    "è¨˜å¸³" "å’–å•¡" "150.0" "Line è½‰å¸³" "ä»£å¢Š" "" "" "åŒäº‹"

# ============================================================
# éœ€æ”¯ä»˜åŠŸèƒ½æ¸¬è©¦ï¼ˆæ¬ ä»–äººéŒ¢ï¼‰
# ============================================================

run_test "éœ€æ”¯ä»˜åŠŸèƒ½" "TC-V17-005: åŸºæœ¬éœ€æ”¯ä»˜ - å¼Ÿä»£è¨‚" \
    "å¼Ÿä»£è¨‚æ—¥æœ¬ç™½é¦¬æˆ¿é–“10000å…ƒ" \
    "âœ… å“é …: æ—¥æœ¬ç™½é¦¬æˆ¿é–“, ä»£å¢Šç‹€æ…‹: éœ€æ”¯ä»˜, ä»˜æ¬¾: NA, å°è±¡: å¼Ÿ" \
    "è¨˜å¸³" "æ—¥æœ¬ç™½é¦¬æˆ¿é–“" "10000.0" "NA" "éœ€æ”¯ä»˜" "" "" "å¼Ÿ"

run_test "éœ€æ”¯ä»˜åŠŸèƒ½" "TC-V17-006: æœ‹å‹å¹«è²·æ¼”å”±æœƒé–€ç¥¨" \
    "æœ‹å‹å¹«æˆ‘è²·æ¼”å”±æœƒé–€ç¥¨3500å…ƒ" \
    "âœ… å“é …: æ¼”å”±æœƒé–€ç¥¨, ä»£å¢Šç‹€æ…‹: éœ€æ”¯ä»˜, ä»˜æ¬¾: NA, å°è±¡: æœ‹å‹" \
    "è¨˜å¸³" "æ¼”å”±æœƒé–€ç¥¨" "3500.0" "NA" "éœ€æ”¯ä»˜" "" "" "æœ‹å‹"

run_test "éœ€æ”¯ä»˜åŠŸèƒ½" "TC-V17-007: åŒäº‹å…ˆå¢Šåˆé¤" \
    "åŒäº‹å…ˆå¢Šåˆé¤è²»150å…ƒ" \
    "âœ… å“é …: åˆé¤è²», ä»£å¢Šç‹€æ…‹: éœ€æ”¯ä»˜, å°è±¡: åŒäº‹" \
    "è¨˜å¸³" "åˆé¤è²»" "150.0" "NA" "éœ€æ”¯ä»˜" "" "" "åŒäº‹"

# ============================================================
# ä¸ç´¢å–åŠŸèƒ½æ¸¬è©¦ï¼ˆä»£å¢Šä½†ä¸æ”¶éŒ¢ï¼‰
# ============================================================

run_test "ä¸ç´¢å–åŠŸèƒ½" "TC-V17-008: å¹«åª½åª½è²·è—¥ä¸ç”¨é‚„" \
    "å¹«åª½åª½è²·è—¥500å…ƒç¾é‡‘ï¼Œä¸ç”¨é‚„" \
    "âœ… å“é …: è—¥, ä»£å¢Šç‹€æ…‹: ä¸ç´¢å–, ä»˜æ¬¾: ç¾é‡‘, å°è±¡: åª½åª½" \
    "è¨˜å¸³" "è—¥" "500.0" "ç¾é‡‘" "ä¸ç´¢å–" "" "" "åª½åª½"

run_test "ä¸ç´¢å–åŠŸèƒ½" "TC-V17-009: å¹«è€å©†ä»˜åœè»Šè²»ä¸ç´¢å–" \
    "å¹«è€å©†ä»˜åœè»Šè²»200å…ƒç¾é‡‘ä¸ç´¢å–" \
    "âœ… å“é …: åœè»Šè²», ä»£å¢Šç‹€æ…‹: ä¸ç´¢å–, å°è±¡: è€å©†" \
    "è¨˜å¸³" "åœè»Šè²»" "200.0" "ç¾é‡‘" "ä¸ç´¢å–" "" "" "è€å©†"

# ============================================================
# å¤šé …ç›® + ä»£å¢ŠåŠŸèƒ½æ•´åˆæ¸¬è©¦
# ============================================================

run_test "å¤šé …ç›®ä»£å¢Š" "TC-V17-010: éƒ¨åˆ†é …ç›®ä»£å¢Š" \
    "æ—©é¤80å…ƒï¼Œåˆé¤150å…ƒå¹«åŒäº‹ä»£å¢Šï¼Œç¾é‡‘" \
    "âœ… 2å€‹é …ç›®ï¼Œç¬¬2å€‹é …ç›®ç‚ºä»£å¢Š" \
    "è¨˜å¸³" "" "" "ç¾é‡‘" "" "" "2"

# ============================================================
# æ—¥æœŸæå–åŠŸèƒ½æ¸¬è©¦ï¼ˆv1.7.0 ä¿®å¾©ï¼‰
# ============================================================

run_test "æ—¥æœŸæå–" "TC-V17-011: MM/DD æ ¼å¼" \
    "11/12 åˆé¤120å…ƒç¾é‡‘" \
    "âœ… æ—¥æœŸ: 2025-11-12, äº¤æ˜“ID: 20251112-120000" \
    "è¨˜å¸³" "åˆé¤" "120.0" "ç¾é‡‘" "" "2025-11-12" ""

run_test "æ—¥æœŸæå–" "TC-V17-012: æ˜¨å¤©" \
    "æ˜¨å¤©æ™šé¤200å…ƒç‹—å¡" \
    "âœ… æ—¥æœŸ: æ˜¨å¤©çš„æ—¥æœŸ, äº¤æ˜“IDä½¿ç”¨æ™šé¤æ™‚é–“(18:00)" \
    "è¨˜å¸³" "æ™šé¤" "200.0" "å°æ–°ç‹—å¡" "" "" ""

run_test "æ—¥æœŸæå–" "TC-V17-013: å¤šé …ç›® + æ—¥æœŸ" \
    "11/15 æ—©é¤80å…ƒï¼Œåˆé¤150å…ƒï¼Œç¾é‡‘" \
    "âœ… æ—¥æœŸ: 2025-11-15, 2å€‹é …ç›®" \
    "è¨˜å¸³" "" "" "ç¾é‡‘" "" "2025-11-15" "2"

run_test "æ—¥æœŸæå–" "TC-V17-014: æ—¥æœŸ + ä»£å¢Š" \
    "11/12 ä»£å¦¹è³¼è²·Pizzaå…Œæ›åˆ¸979å…ƒç¾é‡‘" \
    "âœ… æ—¥æœŸ: 2025-11-12, ä»£å¢Šç‹€æ…‹: ä»£å¢Š, å°è±¡: å¦¹" \
    "è¨˜å¸³" "Pizzaå…Œæ›åˆ¸" "979.0" "ç¾é‡‘" "ä»£å¢Š" "2025-11-12" "" "å¦¹"

# ============================================================
# è¤‡åˆå“é …æ¸¬è©¦ï¼ˆv1.7.0 ä¿®å¾©ï¼‰
# ============================================================

run_test "è¤‡åˆå“é …" "TC-V17-015: ä¸‰æ˜æ²»å’Œå’–å•¡" \
    "ä¸‰æ˜æ²»å’Œå’–å•¡80å…ƒç¾é‡‘" \
    "âœ… å“é …ä¿æŒå®Œæ•´: ä¸‰æ˜æ²»å’Œå’–å•¡" \
    "è¨˜å¸³" "ä¸‰æ˜æ²»å’Œå’–å•¡" "80.0" "ç¾é‡‘" "" "" ""

run_test "è¤‡åˆå“é …" "TC-V17-016: è›‹ç³•è·Ÿé£²æ–™" \
    "è›‹ç³•è·Ÿé£²æ–™150å…ƒç‹—å¡" \
    "âœ… å“é …ä¿æŒå®Œæ•´: è›‹ç³•è·Ÿé£²æ–™" \
    "è¨˜å¸³" "è›‹ç³•è·Ÿé£²æ–™" "150.0" "å°æ–°ç‹—å¡" "" "" ""

run_test "è¤‡åˆå“é …" "TC-V17-017: å’–å•¡èˆ‡ä¸‰æ˜æ²»" \
    "å’–å•¡èˆ‡ä¸‰æ˜æ²»100å…ƒLine" \
    "âœ… å“é …ä¿æŒå®Œæ•´: å’–å•¡èˆ‡ä¸‰æ˜æ²»" \
    "è¨˜å¸³" "å’–å•¡èˆ‡ä¸‰æ˜æ²»" "100.0" "Line è½‰å¸³" "" "" ""

run_test "è¤‡åˆå“é …" "TC-V17-018: æ¼¢å ¡åŠ è–¯æ¢" \
    "æ¼¢å ¡åŠ è–¯æ¢120å…ƒç¾é‡‘" \
    "âœ… å“é …ä¿æŒå®Œæ•´: æ¼¢å ¡åŠ è–¯æ¢" \
    "è¨˜å¸³" "æ¼¢å ¡åŠ è–¯æ¢" "120.0" "ç¾é‡‘" "" "" ""

# ============================================================
# å‘å¾Œç›¸å®¹æ€§æ¸¬è©¦
# ============================================================

run_test "å‘å¾Œç›¸å®¹" "TC-V17-019: ä¸€èˆ¬è¨˜å¸³ç„¡ä»£å¢Š" \
    "åˆé¤120å…ƒç¾é‡‘" \
    "âœ… å“é …: åˆé¤, ç„¡ä»£å¢Šç‹€æ…‹" \
    "è¨˜å¸³" "åˆé¤" "120.0" "ç¾é‡‘" "" "" ""

run_test "å‘å¾Œç›¸å®¹" "TC-V17-020: è‹±æ–‡å“é …" \
    "WSJ 499 å¤§æˆ¶" \
    "âœ… å“é …: WSJ, ä»˜æ¬¾: å¤§æˆ¶ä¿¡ç”¨å¡" \
    "è¨˜å¸³" "WSJ" "499.0" "å¤§æˆ¶ä¿¡ç”¨å¡" "" "" ""

run_test "å‘å¾Œç›¸å®¹" "TC-V17-021: é‡‘é¡ç„¡è²¨å¹£ç¬¦è™Ÿ" \
    "æ—©é¤ 21 å¤§æˆ¶" \
    "âœ… å“é …: æ—©é¤, é‡‘é¡: 21" \
    "è¨˜å¸³" "æ—©é¤" "21.0" "å¤§æˆ¶ä¿¡ç”¨å¡" "" "" ""

# ============================================================
# é¡¯ç¤ºæ¸¬è©¦çµ±è¨ˆ
# ============================================================

echo ""
echo "======================================================================"
echo "ğŸ“Š æ¸¬è©¦çµ±è¨ˆ"
echo "======================================================================"
echo "ç¸½æ¸¬è©¦æ•¸: $TOTAL_TESTS"

if [[ "$AUTO_MODE" == true ]]; then
    echo -e "${GREEN}é€šé: $PASSED_TESTS${NC}"
    echo -e "${RED}å¤±æ•—: $FAILED_TESTS${NC}"
    echo -e "${YELLOW}è·³é: $SKIPPED_TESTS${NC}"
    echo ""

    if [[ $FAILED_TESTS -eq 0 ]]; then
        echo -e "${GREEN}ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼${NC}"
        exit 0
    else
        echo -e "${RED}âš ï¸  æœ‰æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸Šæ–¹è©³ç´°è³‡è¨Š${NC}"
        exit 1
    fi
else
    echo ""
    echo "âœ… æ¸¬è©¦å®Œæˆï¼"
    echo ""
    echo "äººå·¥åˆ¤æ–·æ¨¡å¼å·²å®Œæˆæ‰€æœ‰æ¸¬è©¦ã€‚"
    echo "å¦‚éœ€è‡ªå‹•åˆ¤æ–·çµæœï¼Œè«‹ä½¿ç”¨ï¼š"
    echo "  ./run_v17_tests.sh --auto"
fi
