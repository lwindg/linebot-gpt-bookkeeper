# v1.7.0 測試指南

本文檔說明如何測試 v1.7.0 新功能：代墊支付追蹤、日期提取、複合品項。

---

## 🧪 測試工具

### 1. Functional suite runner (recommended)

```bash
# Manual mode (default) - review cases one by one
./run_tests.sh --suite advance_payment
./run_tests.sh --suite date

# Auto-compare mode (requires OpenAI)
./run_tests.sh --suite advance_payment --auto
./run_tests.sh --suite date --auto

# List-only (offline, no OpenAI calls)
./run_tests.sh --suite advance_payment --list
```

> Legacy shim: `./run_v17_tests.sh` is kept for backward compatibility, but `./run_tests.sh` is the source of truth.

### 2. 互動式測試工具

```bash
# 啟動互動模式
python test_local.py

# 單次測試
python test_local.py "代妹購買Pizza兌換券979元現金"
```

### 3. 單元測試

```bash
# 執行完整測試套件
PYTHONPATH=. uv run pytest tests/unit/test_multi_expense.py -v

# 只執行代墊相關測試
PYTHONPATH=. uv run pytest tests/unit/test_multi_expense.py::TestAdvancePayment -v
PYTHONPATH=. uv run pytest tests/unit/test_multi_expense.py::TestNeedToPay -v
PYTHONPATH=. uv run pytest tests/unit/test_multi_expense.py::TestNoCollection -v
```

---

## ✨ v1.7.0 新功能測試重點

### 1. 代墊功能（Advance Payment Tracking）

#### 1.1 代墊給他人（代墊狀態: "代墊"）

**測試案例**：

```
✅ "代妹購買Pizza兌換券979元現金"
   期望: 品項=Pizza兌換券, 金額=979, 付款=現金, 代墊狀態=代墊, 收款對象=妹

✅ "幫同事墊付計程車費100元現金"
   期望: 品項=計程車費, 金額=100, 付款=現金, 代墊狀態=代墊, 收款對象=同事

✅ "代朋友買午餐120元刷狗卡"
   期望: 品項=午餐, 金額=120, 付款=台新狗卡, 代墊狀態=代墊, 收款對象=朋友

✅ "代購咖啡給三位同事150元Line轉帳"
   期望: 品項=咖啡, 金額=150, 付款=Line 轉帳, 代墊狀態=代墊, 收款對象=同事
```

**關鍵字識別**：
- 「代」+ 對象：代妹、代朋友、代同事
- 「幫」+ 對象 + 墊：幫同事墊付
- 「代購」+ 對象：代購給同事

#### 1.2 需支付給他人（代墊狀態: "需支付"）

**測試案例**：

```
✅ "弟代訂日本白馬房間10000元"
   期望: 品項=日本白馬房間, 金額=10000, 付款=NA, 代墊狀態=需支付, 支付對象=弟

✅ "朋友幫我買演唱會門票3500元"
   期望: 品項=演唱會門票, 金額=3500, 付款=NA, 代墊狀態=需支付, 支付對象=朋友

✅ "同事先墊午餐費150元"
   期望: 品項=午餐費, 金額=150, 付款=NA, 代墊狀態=需支付, 支付對象=同事
```

**關鍵字識別**：
- 對象 + 「代訂」：弟代訂
- 對象 + 「幫我買」：朋友幫我買
- 對象 + 「先墊」：同事先墊

**付款方式規則**：
- 需支付項目預設使用 `"NA"`（尚未支付）

#### 1.3 不索取（代墊狀態: "不索取"）

**測試案例**：

```
✅ "幫媽媽買藥500元現金，不用還"
   期望: 品項=藥, 金額=500, 付款=現金, 代墊狀態=不索取, 收款對象=媽媽

✅ "幫老婆付停車費200元現金不索取"
   期望: 品項=停車費, 金額=200, 付款=現金, 代墊狀態=不索取, 收款對象=老婆
```

**關鍵字識別**：
- 「不用還」
- 「不索取」
- 「送給」

#### 1.4 多項目 + 部分代墊

**測試案例**：

```
✅ "早餐80元，午餐150元幫同事代墊，現金"
   期望: 2個項目
   - 項目1: 品項=早餐, 金額=80, 代墊狀態=無
   - 項目2: 品項=午餐, 金額=150, 代墊狀態=代墊, 收款對象=同事
   - 共用付款方式: 現金
```

---

### 2. 日期提取功能（Date Extraction）

**功能說明**：v1.7.0 恢復了在 v1.5.0 重構時丟失的日期提取功能。

#### 2.1 MM/DD 格式

**測試案例**：

```
✅ "11/12 午餐120元現金"
   期望: 日期=2025-11-12, 交易ID=20251112-120000

✅ "11/15 早餐80元，午餐150元，現金"
   期望: 日期=2025-11-15, 交易ID=20251115-080000, 2個項目
```

#### 2.2 語義化日期

**測試案例**：

```
✅ "昨天晚餐200元狗卡"
   期望: 日期=昨天的實際日期, 交易ID使用18:00（晚餐推測時間）

✅ "今天午餐120元現金"
   期望: 日期=今天, 交易ID使用當前時間

✅ "明天早餐80元現金"
   期望: 日期=明天的日期, 交易ID使用08:00（早餐推測時間）

✅ "前天晚餐200元狗卡"
   期望: 日期=前天的日期, 交易ID使用18:00
```

**支援的語義化日期**：
- 今天、昨天、前天、大前天
- 明天、後天、大後天

#### 2.3 日期 + 代墊整合

**測試案例**：

```
✅ "11/12 代妹購買Pizza兌換券979元現金"
   期望: 日期=2025-11-12, 代墊狀態=代墊, 交易ID=20251112-235900
```

#### 2.4 時間推測規則

當提供日期但無時間時，根據品項推測時間：

| 品項類型 | 推測時間 |
|---------|---------|
| 早餐 | 08:00:00 |
| 午餐 | 12:00:00 |
| 晚餐 | 18:00:00 |
| 其他 | 23:59:00 |

---

### 3. 複合品項功能（Compound Item Names）

**功能說明**：確保使用連接詞的複合品項名稱保持完整，不被截斷或改寫。

#### 3.1 支援的連接詞

- **和**：三明治和咖啡
- **跟**：蛋糕跟飲料
- **與**：咖啡與三明治
- **加**：漢堡加薯條

#### 3.2 測試案例

```
✅ "三明治和咖啡80元現金"
   期望: 品項=三明治和咖啡（不是「三明治」或「早餐」）

✅ "蛋糕跟飲料150元狗卡"
   期望: 品項=蛋糕跟飲料（不是「蛋糕」或「點心」）

✅ "咖啡與三明治100元Line"
   期望: 品項=咖啡與三明治（不是「咖啡」）

✅ "漢堡加薯條120元現金"
   期望: 品項=漢堡加薯條（不是「漢堡」）
```

**重要規則**：
- 複合品項必須只有**一個金額**
- 如果有多個金額，會被視為多項目記帳
- 複合品項不會被改寫為通用餐點類型（如「早餐」、「點心」）

---

## 📋 向後相容性測試

確保 v1.7.0 不破壞現有功能：

```bash
# 1. 基本記帳（無代墊）
✅ "午餐120元現金"
   期望: 品項=午餐, 金額=120, 付款=現金, 代墊狀態=無

# 2. 英文品項
✅ "WSJ 499 大戶"
   期望: 品項=WSJ, 金額=499, 付款=大戶信用卡

# 3. 金額無貨幣符號
✅ "早餐 21 大戶"
   期望: 品項=早餐, 金額=21, 付款=大戶信用卡

# 4. 多項目記帳
✅ "早餐80元，午餐150元，現金"
   期望: 2個項目, 共用付款方式=現金

# 5. 付款方式緊接金額
✅ "午餐120元灰狗"
   期望: 品項=午餐, 金額=120, 付款=FlyGo 信用卡
```

---

## 🚨 已知限制（v1.7.0 範圍外）

以下功能**明確排除**在 v1.7.0：

### 不支援的功能

1. **狀態更新**：無法更新代墊狀態（如「已收款」、「已支付」）
2. **收據識別**：無法從收據圖片識別代墊資訊
3. **提醒通知**：無自動提醒未結清的代墊/債務
4. **報表功能**：無代墊摘要報表

這些功能規劃在未來版本（v1.8+）實現。

---

## 📊 測試結果統計

### 完整測試覆蓋（21 個測試案例）

**代墊功能**（10 個測試）：
- 代墊給他人：4 個測試 ✅
- 需支付給他人：3 個測試 ✅
- 不索取：2 個測試 ✅
- 多項目整合：1 個測試 ✅

**日期提取功能**（4 個測試）：
- MM/DD 格式：1 個測試 ✅
- 語義化日期：1 個測試 ✅
- 多項目 + 日期：1 個測試 ✅
- 日期 + 代墊：1 個測試 ✅

**複合品項功能**（4 個測試）：
- 和/跟/與/加 連接詞：4 個測試 ✅

**向後相容性**（3 個測試）：
- 基本功能保持正常：3 個測試 ✅

---

## 🔧 故障排除

### 問題 1: 代墊狀態識別錯誤

**症狀**：「代妹買咖啡」被識別為普通記帳

**解決**：
- 檢查關鍵字：確保使用「代」、「幫」等關鍵字
- 檢查對象：必須包含收款對象（妹、同事、朋友等）

### 問題 2: 日期無法提取

**症狀**：「11/12 午餐」使用今天日期而非 11/12

**解決**：
- 檢查 GPT 回應是否包含 `date` 欄位
- 檢查 `parse_semantic_date()` 函數是否被呼叫
- 查看日誌：`logger.info("使用提取的日期...")`

### 問題 3: 複合品項被截斷

**症狀**：「三明治和咖啡」只提取「三明治」

**解決**：
- 確認 prompt 包含複合品項規則
- 檢查是否使用正確的連接詞（和/跟/與/加）
- 確保只有一個金額（否則會被視為多項目）

---

## 📚 相關文件

- **功能規格**：`specs/002-advance-payment/spec.md`
- **實作計畫**：`specs/002-advance-payment/plan.md`
- **快速入門**：`specs/002-advance-payment/quickstart.md`
- **發布說明**：`docs/releases/RELEASE_NOTES_v1.7.0.md`
- **單元測試**：`tests/test_multi_expense.py`

---

**版本**：v1.7.0
**更新日期**：2025-11-19
**測試案例數**：21
