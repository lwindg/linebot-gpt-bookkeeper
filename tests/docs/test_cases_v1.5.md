# v1.5.0 測試案例

**Status**: legacy (human-readable reference)
**Source of truth**: `tests/functional/suites/multi_expense.jsonl`
**Runner**: `./run_tests.sh --suite multi_expense`

> This document is kept for manual reading. The canonical expectations live in the JSONL suite.
> If anything conflicts, follow `tests/functional/suites/multi_expense.jsonl`.

---

## 測試分類

- [單項目記帳（向後相容）](#單項目記帳向後相容)
- [多項目記帳（核心功能）](#多項目記帳核心功能)
- [共用付款方式驗證](#共用付款方式驗證)
- [錯誤處理與邊界案例](#錯誤處理與邊界案例)
- [對話意圖識別](#對話意圖識別)

---

## 單項目記帳（向後相容）

### TC-V15-001: v1 格式兼容 - 標準記帳
**輸入**：`午餐120元現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：1
- ✅ 品項：午餐
- ✅ 金額：120 TWD
- ✅ 付款方式：現金（共用）
- ✅ 分類：家庭／餐飲／午餐
- ✅ 顯示格式：v1 單項目格式（向後相容）

### TC-V15-002: v1 格式兼容 - 含暱稱
**輸入**：`點心200元狗卡`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：1
- ✅ 付款方式：台新狗卡

### TC-V15-003: v1 格式兼容 - 自然語句
**輸入**：`買了咖啡50元，Line轉帳`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：1
- ✅ 品項：咖啡
- ✅ 付款方式：Line 轉帳

---

## 多項目記帳（核心功能）

### TC-V15-010: 雙項目 - 逗號分隔
**輸入**：`早餐80元，午餐150元，現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：早餐，80 TWD
- ✅ 項目2：午餐，150 TWD
- ✅ 付款方式：現金（共用）
- ✅ 交易ID：相同（共用）
- ✅ 日期：相同（當天）

### TC-V15-011: 雙項目 - 付款方式在前
**輸入**：`用狗卡，咖啡50，三明治35`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：咖啡，50 TWD
- ✅ 項目2：三明治，35 TWD
- ✅ 付款方式：台新狗卡（共用）

### TC-V15-012: 三項目 - 早午晚餐
**輸入**：`早餐50元，午餐120元，晚餐200元，現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：3
- ✅ 項目1：早餐，50 TWD，分類：家庭／餐飲／早餐
- ✅ 項目2：午餐，120 TWD，分類：家庭／餐飲／午餐
- ✅ 項目3：晚餐，200 TWD，分類：家庭／餐飲／晚餐
- ✅ 付款方式：現金（共用）

### TC-V15-013: 雙項目 - 分號分隔
**輸入**：`咖啡45元；蛋糕120元；Line轉帳`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：咖啡，45 TWD
- ✅ 項目2：蛋糕，120 TWD
- ✅ 付款方式：Line 轉帳（共用）

### TC-V15-014: 雙項目 - 頓號分隔
**輸入**：`早餐三明治35、飲料30、現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：早餐三明治 或 三明治，35 TWD
- ✅ 項目2：飲料，30 TWD
- ✅ 付款方式：現金（共用）

### TC-V15-015: 多項目 - 換行分隔
**輸入**：
```
咖啡50
蛋糕120
現金
```
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 付款方式：現金（共用）

### TC-V15-016: 多項目 - 付款方式在開頭（新增測試）
**輸入**：`用狗卡，咖啡50，三明治35`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：咖啡，50 TWD
- ✅ 項目2：三明治，35 TWD
- ✅ 付款方式：台新狗卡（共用）

---

## 共用付款方式驗證

### TC-V15-020: 共用交易ID驗證
**輸入**：`早餐80元，午餐150元，現金`
**預期結果**：
- ✅ 項目1.交易ID == 項目2.交易ID
- ✅ 交易ID格式：YYYYMMDD-HHMMSS

### TC-V15-021: 共用日期驗證
**輸入**：`早餐80元，午餐150元，現金`
**預期結果**：
- ✅ 項目1.日期 == 項目2.日期
- ✅ 日期：當天日期（YYYY-MM-DD）

### TC-V15-022: 共用付款方式驗證
**輸入**：`咖啡50，三明治35，用狗卡`
**預期結果**：
- ✅ 項目1.付款方式 == 項目2.付款方式 == "台新狗卡"

### TC-V15-023: 附註標記驗證
**輸入**：`早餐80元，午餐150元，現金`
**預期結果**：
- ✅ 項目1.附註：多項目支出 1/2
- ✅ 項目2.附註：多項目支出 2/2

---

## 錯誤處理與邊界案例

### TC-V15-030: ❌ 不同付款方式（錯誤）
**輸入**：`早餐80元現金，午餐150元刷卡`
**預期結果**：
- ✅ 意圖：error
- ✅ 錯誤訊息：「偵測到不同付款方式，請分開記帳」

### TC-V15-031: ❌ 第二項缺少金額（錯誤）
**輸入**：`早餐80元，午餐，現金`
**預期結果**：
- ✅ 意圖：error
- ✅ 錯誤訊息：「第2個項目缺少金額，請提供完整資訊」

### TC-V15-032: ✅ 「和」連接詞視為單項目
**輸入**：`三明治和咖啡80元現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：1
- ✅ 品項：早餐（或類似複合品項）
- ✅ 金額：80 TWD
- ✅ 付款方式：現金
- ✅ 分類：家庭／餐飲／早餐（或最接近的分類）

### TC-V15-033: ❌ 缺少付款方式
**輸入**：`早餐80元，午餐150元`
**預期結果**：
- ✅ 意圖：error
- ✅ 錯誤訊息：「缺少付款方式，請提供完整資訊」

### TC-V15-034: ❌ 第一項缺少金額
**輸入**：`早餐，午餐150元，現金`
**預期結果**：
- ✅ 意圖：error
- ✅ 錯誤訊息：「第1個項目缺少金額，請提供完整資訊」

### TC-V15-035: ❌ 缺少品項名稱
**輸入**：`80元，150元，現金`
**預期結果**：
- ✅ 意圖：error
- ✅ 錯誤訊息：「第X個項目缺少品項名稱，請提供完整資訊」

---

## 對話意圖識別

### TC-V15-040: 打招呼
**輸入**：`你好`
**預期結果**：
- ✅ 意圖：conversation
- ✅ 回應：友善的問候

### TC-V15-041: 詢問功能
**輸入**：`可以幫我做什麼？`
**預期結果**：
- ✅ 意圖：conversation
- ✅ 回應：說明功能

### TC-V15-042: 感謝
**輸入**：`謝謝`
**預期結果**：
- ✅ 意圖：conversation
- ✅ 回應：禮貌回應

---

## 複雜場景測試

### TC-V15-050: 含明細說明的多項目
**輸入**：`在開飯早餐50元，在7-11買咖啡45元，現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：2
- ✅ 項目1：品項「早餐」，明細說明「開飯」
- ✅ 項目2：品項「咖啡」，明細說明「7-11」或「7-11買」

### TC-V15-051: 含不同分類的多項目
**輸入**：`咖啡50元，蛋糕120元，狗卡`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目1：咖啡，分類「家庭／飲品」
- ✅ 項目2：蛋糕，分類「家庭／點心」

### TC-V15-052: 四項目以上
**輸入**：`咖啡50、三明治35、沙拉80、果汁40、現金`
**預期結果**：
- ✅ 意圖：multi_bookkeeping
- ✅ 項目數量：4
- ✅ 所有項目共用付款方式：現金
- ✅ 所有項目共用交易ID

---

## 測試執行方式

### 方法 1：List-only（offline, no OpenAI calls）
```bash
./run_tests.sh --suite multi_expense --list
./run_tests.sh --suite multi_expense --list --only 'TC-V15-010|TC-V15-030'
```

### 方法 2：Manual（one-by-one）
```bash
./run_tests.sh --suite multi_expense
```

### 方法 3：Auto compare（requires OpenAI）
```bash
./run_tests.sh --suite multi_expense --auto
```

### 方法 4：Ad-hoc local run
```bash
python test_local.py '早餐80元，午餐150元，現金'
python test_local.py --raw '早餐80元現金，午餐150元刷卡'
```

---

## 測試檢查清單

執行測試時，請確認以下項目：

### 核心功能
- [ ] 單項目記帳正常運作（向後相容 v1）
- [ ] 雙項目記帳正確處理
- [ ] 三項目及以上記帳正確處理
- [ ] 所有項目共用交易ID
- [ ] 所有項目共用付款方式
- [ ] 所有項目共用日期

### 錯誤處理
- [ ] 不同付款方式被拒絕
- [ ] 缺少金額被提示
- [ ] 缺少付款方式被提示
- [ ] 缺少品項名稱被提示
- [ ] 模糊情況（「和」連接詞）被拒絕

### 輸出格式
- [ ] 單項目使用 v1 格式顯示
- [ ] 多項目使用 v1.5.0 格式顯示
- [ ] 項目編號正確（#1, #2, ...）
- [ ] 共用資訊正確標註

### 對話意圖
- [ ] 對話意圖正確識別
- [ ] 對話回應友善清晰

---

## 關鍵差異：v1 vs v1.5.0

| 特性 | v1 MVP | v1.5.0 |
|------|--------|--------|
| 單項目記帳 | ✅ | ✅（向後相容）|
| 多項目記帳 | ❌ | ✅ |
| 共用交易ID | N/A | ✅ |
| 共用付款方式 | N/A | ✅ |
| 錯誤處理 | 基本 | 增強（多種付款方式、模糊情況）|
| 顯示格式 | 單項目 | 單項目 + 多項目列表 |

---

**更新日期**：2025-11-15
**版本**：v1.5.0 Test Cases
