# 自動化測試指南

本指南說明如何使用增強版測試腳本的自動判斷功能。

---

## 🚀 快速開始

### Expense Suite

```bash
# 人工判斷模式（預設，逐個檢視結果）
./run_tests.sh --suite expense

# 自動判斷模式（快速驗證所有測試）
./run_tests.sh --suite expense --auto

# 顯示說明
./run_tests.sh --suite expense --help
```

### Multi-Expense Suite

```bash
# 人工判斷模式（預設，逐個檢視結果）
./run_tests.sh --suite multi_expense

# 自動判斷模式（快速驗證所有測試）
./run_tests.sh --suite multi_expense --auto

# 顯示說明
./run_tests.sh --suite multi_expense --help
```

---

## 📊 自動判斷模式功能

### Expense Suite Assertions

- ✅ **意圖**（記帳/對話）
- ✅ **品項名稱**
- ✅ **金額**
- ✅ **付款方式**
- ✅ **分類**（允許部分匹配）
- ❌ **交易ID**（每次都不同，不判斷）

### Multi-Expense Suite Assertions

- ✅ **意圖**（記帳/對話/錯誤）
- ✅ **項目數量**（1, 2, 3, 4+）
- ✅ **共用付款方式**
- ✅ **錯誤訊息**（包含關鍵字）
- ❌ **交易ID**（每次都不同，不判斷）

---

## 🎨 輸出格式

### 測試通過範例

```
======================================================================
[基本功能] TC-V1-001: 標準記帳格式
======================================================================
📨 測試訊息: 午餐120元現金
✅ 測試通過

📊 實際結果：
  品項: 午餐
  金額: 120
  付款: 現金
  分類: 家庭／餐飲／午餐
```

### 測試失敗範例

```
======================================================================
[基本功能] TC-V1-002: 順序不固定
======================================================================
📨 測試訊息: 200 點心 狗卡
❌ 測試失敗
差異項目：
  ✗ 付款: 預期[台新狗卡] 實際[狗卡]

📊 實際結果：
  品項: 點心
  金額: 200
  付款: 狗卡
  分類: 家庭／點心
```

### 最終統計

```
====================================================================
✅ v1 MVP 測試完成！
====================================================================

📊 測試統計：
  - 總測試數: 30
  - 通過: 28
  - 失敗: 2

📈 通過率: 93%

⚠️  大部分測試通過，但仍有失敗項目需要修復
```

---

## 🔍 判斷邏輯說明

### 1. 意圖判斷

**精確匹配**：實際值必須完全等於預期值

- 記帳 → 記帳 ✅
- 對話 → 記帳 ❌

### 2. 金額判斷

**數值比較**：自動處理小數點（移除 `.0`）

- 120 → 120.0 ✅
- 45.5 → 45.5 ✅
- 120 → 150 ❌

### 3. 付款方式判斷

**精確匹配**：暱稱需轉換為標準名稱

- 台新狗卡 → 台新狗卡 ✅
- 現金 → 現金 ✅
- 狗卡 → 台新狗卡 ❌（未轉換）

### 4. 分類判斷

**部分匹配**：允許包含關係

- 家庭／餐飲／午餐 → 餐飲 ✅
- 家庭／點心 → 點心 ✅
- 家庭／飲品／咖啡 → 咖啡 ✅

### 5. 項目數量判斷（v1.5.0）

**精確匹配**：必須完全相同

- 2 → 2 ✅
- 1 → 2 ❌

### 6. 錯誤訊息判斷（v1.5.0）

**包含匹配**：實際錯誤訊息必須包含關鍵字

- "偵測到不同付款方式，請分開記帳" → "不同付款方式" ✅
- "第2個項目缺少金額" → "缺少金額" ✅
- "缺少付款方式" → "品項" ❌

---

## 💡 使用建議

### 場景 1：首次驗證

**建議**：使用人工判斷模式

```bash
./run_tests.sh --suite expense
```

逐個檢視每個測試的詳細輸出，確保理解測試意圖。

### 場景 2：快速回歸測試

**建議**：使用自動判斷模式

```bash
./run_tests.sh --suite expense --auto
./run_tests.sh --suite multi_expense --auto
```

當你修改 prompt 或程式碼後，快速驗證是否破壞現有功能。

### 場景 3：Prompt 調優

**建議**：使用自動判斷模式 + 統計

1. 記錄初始通過率
2. 調整 `app/prompts.py` 中的 prompt
3. 執行 `./run_tests.sh --suite expense --auto`
4. 比較通過率變化
5. 重複步驟 2-4 直到達到目標

### 場景 4：CI/CD 整合

**建議**：在 GitHub Actions 中使用自動模式

```yaml
- name: Run v1 tests
  run: ./run_tests.sh --suite expense --auto

- name: Run v1.5 tests
  run: ./run_tests.sh --suite multi_expense --auto
```

如果通過率 < 100%，標記為失敗。

---

## 🐛 常見問題

### Q1: 為什麼不判斷交易ID？

**A**: 交易ID 使用時間戳記（YYYYMMDD-HHMMSS），每次執行都會改變，無法預測。

### Q2: 分類判斷為何使用部分匹配？

**A**: GPT 可能回傳完整三層分類（如「家庭／餐飲／午餐」）或兩層分類（如「家庭／餐飲」），部分匹配允許這種彈性。

### Q3: 如何新增自訂測試案例？

**A**: 編輯 `tests/functional/suites/*.jsonl`，新增或調整測試案例：

```bash
{"id":"...","group":"...","name":"...","message":"...","expected":{...}}
```

### Q4: 自動模式能跳過失敗的測試嗎？

**A**: 不會跳過，會顯示所有測試結果。失敗的測試會以紅色標記並顯示差異。

### Q5: 如何只執行特定類別的測試？

**A**: 目前不支援。建議複製腳本並註解掉不需要的測試區塊。

---

## 📈 通過率目標

### v1 MVP

- **目標**：≥ 95%
- **理由**：v1 功能已穩定，應該幾乎所有測試都能通過

### v1.5.0

- **目標**：≥ 90%
- **理由**：v1.5.0 仍在開發中，允許少量測試失敗（特別是邊界案例）

---

## 🔄 測試更新流程

當需求變更時：

1. **更新測試案例**
   - 編輯 `tests/test_cases_v1.md` 或 `tests/test_cases_v1.5.md`

2. **更新測試案例**
   - 修改 `tests/functional/suites/*.jsonl` 中的預期結果

3. **執行驗證**
   ```bash
   ./run_tests.sh --suite expense --auto
   ./run_tests.sh --suite multi_expense --auto
   ```

4. **記錄結果**
   - 更新 `.specify/phase1_completion.md` 或相關文件

---

**更新日期**：2025-11-15
**版本**：v1.0.0
